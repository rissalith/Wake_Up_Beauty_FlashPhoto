#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
SSH 远程部署脚本示例

使用前请：
1. 复制此文件为 deploy-remote.py
2. 配置环境变量（不要硬编码敏感信息！）
3. 建议使用 SSH Key 认证而非密码

环境变量配置示例：
export DEPLOY_HOST=your.server.ip
export DEPLOY_USER=your_username
export DEPLOY_PASSWORD=your_password  # 或使用 SSH Key
export PROJECT_PATH=/path/to/project

或者创建 .env.deploy.local 文件（已在 .gitignore 中）
"""

import os
import sys

# 从环境变量读取配置（安全方式）
HOST = os.environ.get('DEPLOY_HOST')
USERNAME = os.environ.get('DEPLOY_USER', 'root')
PASSWORD = os.environ.get('DEPLOY_PASSWORD')  # 建议使用 SSH Key
PROJECT_PATH = os.environ.get('PROJECT_PATH', '/www/wwwroot/flashphoto')

def check_config():
    """检查必要的配置"""
    missing = []
    if not HOST:
        missing.append('DEPLOY_HOST')
    if not PASSWORD and not os.path.exists(os.path.expanduser('~/.ssh/id_rsa')):
        missing.append('DEPLOY_PASSWORD (或配置 SSH Key)')
    
    if missing:
        print("错误：缺少必要的环境变量：")
        for var in missing:
            print(f"  - {var}")
        print("\n请设置环境变量或创建 .env.deploy.local 文件")
        sys.exit(1)

def main():
    check_config()
    
    try:
        import paramiko
    except ImportError:
        print("请先安装 paramiko: pip install paramiko")
        sys.exit(1)
    
    print(f"连接到 {HOST}...")
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    
    # 优先使用 SSH Key
    try:
        ssh.connect(HOST, username=USERNAME, timeout=30)
    except:
        if PASSWORD:
            ssh.connect(HOST, username=USERNAME, password=PASSWORD, timeout=30)
        else:
            raise
    
    print("已连接，开始部署...")
    
    commands = [
        f"cd {PROJECT_PATH}",
        "docker compose down",
        "docker compose up -d --build",
        "docker compose ps"
    ]
    
    for cmd in commands:
        print(f"\n执行: {cmd}")
        stdin, stdout, stderr = ssh.exec_command(cmd, timeout=300)
        print(stdout.read().decode())
        err = stderr.read().decode()
        if err:
            print(f"[警告] {err}")
    
    ssh.close()
    print("\n部署完成！")

if __name__ == '__main__':
    main()
