# é†’ç¾é—ªå›¾ (FlashPhoto) - é¡¹ç›®æ¦‚è§ˆ

> æœ¬æ–‡æ¡£ä¸º Claude AI åŠ©æ‰‹æä¾›é¡¹ç›®æ•´ä½“æ¶æ„ã€æŠ€æœ¯æ ˆå’Œéƒ¨ç½²ä¿¡æ¯çš„å¿«é€Ÿå‚è€ƒã€‚
> è¯·ä½ åœ¨æ¯æ¬¡å¯¹è¯å¼€å§‹æ—¶åŠ ä¸Šâ€œè€å…¬â€äºŒå­—ï¼Œè®©æˆ‘çŸ¥é“ä½ ç¡®å®é˜…è¯»äº†è¿™ä»½æ–‡æ¡£ã€‚

## âš ï¸ é‡è¦ï¼šéƒ¨ç½²è§„èŒƒï¼ˆAI å¿…è¯»ï¼‰

**ç¦æ­¢ç›´æ¥æ“ä½œæœåŠ¡å™¨æ–‡ä»¶ï¼** æ‰€æœ‰ä»£ç éƒ¨ç½²å¿…é¡»é€šè¿‡ GitHub å·¥ä½œæµï¼š

1. **ä¿®æ”¹ä»£ç ** â†’ æœ¬åœ°ç¼–è¾‘æ–‡ä»¶
2. **æäº¤ä»£ç ** â†’ `git add` + `git commit`
3. **æ¨é€åˆ° GitHub** â†’ `git push`
4. **æœåŠ¡å™¨æ‹‰å–** â†’ SSH åˆ°æœåŠ¡å™¨æ‰§è¡Œ `git pull origin main`
5. **é‡å»ºå®¹å™¨** â†’ `docker compose -f docker-compose.optimized.yml up -d --build <service>`

**ä¸¥ç¦ä»¥ä¸‹æ“ä½œï¼š**
- âŒ ä½¿ç”¨ `scp` ç›´æ¥å¤åˆ¶æ–‡ä»¶åˆ°æœåŠ¡å™¨
- âŒ åœ¨æœåŠ¡å™¨ä¸Šç›´æ¥ç¼–è¾‘ä»£ç æ–‡ä»¶
- âŒ ç»•è¿‡ Git ç‰ˆæœ¬æ§åˆ¶è¿›è¡Œä»»ä½•æ–‡ä»¶ä¿®æ”¹

**åŸå› ï¼š** ç›´æ¥æ“ä½œä¼šå¯¼è‡´æœ¬åœ°å’ŒæœåŠ¡å™¨ä»£ç ä¸åŒæ­¥ï¼Œé€ æˆç‰ˆæœ¬æ··ä¹±å’Œéƒ¨ç½²å†²çªã€‚

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

**é†’ç¾é—ªå›¾**æ˜¯ä¸€ä¸ªåŸºäºå¾®ä¿¡å°ç¨‹åºçš„ AI å›¾ç‰‡ç”Ÿæˆåº”ç”¨ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å°ç¨‹åºä¸Šä¼ ç…§ç‰‡ï¼Œé€‰æ‹©ä¸åŒåœºæ™¯å’Œé£æ ¼ï¼Œä½¿ç”¨ AI æŠ€æœ¯ç”Ÿæˆä¸ªæ€§åŒ–çš„è‰ºæœ¯ç…§ç‰‡ã€‚é¡¹ç›®åŒ…å«å¾®ä¿¡å°ç¨‹åºå‰ç«¯ã€åå°ç®¡ç†ç³»ç»Ÿå’Œå¤šä¸ªåç«¯å¾®æœåŠ¡ã€‚

- **é¡¹ç›®åç§°**: é†’ç¾é—ªå›¾ (FlashPhoto)
- **é¡¹ç›®ç±»å‹**: å¾®ä¿¡å°ç¨‹åº + åå°ç®¡ç†ç³»ç»Ÿ + å¾®æœåŠ¡æ¶æ„
- **ä¸»åŸŸå**: pop-pub.com
- **å°ç¨‹åº AppID**: wxf67c9b6c7b94a9bb

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„å›¾ (å®Œæ•´ Docker åŒ– - æ¨è)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker Network                            â”‚
â”‚                  (flashphoto-network)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Nginx Container                         â”‚    â”‚
â”‚  â”‚         (SSLç»ˆæ­¢ + åå‘ä»£ç† + é™æ€æ–‡ä»¶)              â”‚    â”‚
â”‚  â”‚              ç«¯å£: 80, 443                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                         â”‚                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â”‚               â”‚               â”‚                   â”‚
â”‚         â–¼               â–¼               â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Core API  â”‚   â”‚ai-service â”‚   â”‚pay-serviceâ”‚             â”‚
â”‚  â”‚  :3001    â”‚   â”‚  :3002    â”‚   â”‚  :3003    â”‚             â”‚
â”‚  â”‚           â”‚   â”‚           â”‚   â”‚           â”‚             â”‚
â”‚  â”‚ å°ç¨‹åºAPI â”‚   â”‚ AIå›¾ç‰‡    â”‚   â”‚ å¾®ä¿¡æ”¯ä»˜  â”‚             â”‚
â”‚  â”‚ åå°ç®¡ç†  â”‚   â”‚ ç”Ÿæˆ      â”‚   â”‚ è™šæ‹Ÿæ”¯ä»˜  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚        â”‚                               â”‚                    â”‚
â”‚        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                    â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Redis   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                  â”‚  :6379    â”‚                              â”‚
â”‚                  â”‚           â”‚                              â”‚
â”‚                  â”‚ æ¶ˆæ¯é˜Ÿåˆ—  â”‚                              â”‚
â”‚                  â”‚ ç¼“å­˜      â”‚                              â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                        â”‚                                    â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                              â”‚
â”‚                  â”‚  SQLite   â”‚                              â”‚
â”‚                  â”‚  (ç»Ÿä¸€)   â”‚                              â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡è¯´æ˜

| æœåŠ¡åç§° | å®¹å™¨ç«¯å£ | å¤–éƒ¨ç«¯å£ | èŒè´£ | æŠ€æœ¯æ ˆ |
|---------|---------|---------|------|--------|
| **Nginx** | 80, 443 | 80, 443 | åå‘ä»£ç† + SSL + é™æ€æ–‡ä»¶ | Nginx Alpine |
| **Core API** | 3001 | - | ç»Ÿä¸€åç«¯æœåŠ¡ï¼ˆå°ç¨‹åºAPI + åå°ç®¡ç†APIï¼‰ | Node.js + Express + SQLite |
| **AI Service** | 3002 | - | AI å›¾ç‰‡ç”ŸæˆæœåŠ¡ | Node.js + AI API |
| **Pay Service** | 3003 | - | æ”¯ä»˜æœåŠ¡ï¼ˆå¾®ä¿¡æ”¯ä»˜ + è™šæ‹Ÿæ”¯ä»˜ï¼‰ | Node.js + Redis |
| **Redis** | 6379 | 16379 | æ¶ˆæ¯é˜Ÿåˆ— + ç¼“å­˜ | Redis 7 Alpine |

### æ—§æ¶æ„ (5 æœåŠ¡)

é¡¹ç›®è¿˜ä¿ç•™äº†æ—§ç‰ˆæ¶æ„é…ç½®ï¼ŒåŒ…å« 5 ä¸ªæœåŠ¡ï¼š
- miniprogram-api (å°ç¨‹åºAPI)
- admin-api (åå°ç®¡ç†API)
- ai-service
- pay-service
- redis

**æ¨èä½¿ç”¨å®Œæ•´ Docker åŒ–æ¶æ„**ï¼Œæ‰€æœ‰æœåŠ¡åŒ…æ‹¬ Nginx éƒ½åœ¨ Docker ä¸­è¿è¡Œï¼Œä¾¿äºè¿ç§»å’Œç®¡ç†ã€‚

## ğŸ’» æŠ€æœ¯æ ˆ

### å‰ç«¯æŠ€æœ¯

| æ¨¡å— | æŠ€æœ¯æ ˆ |
|------|--------|
| **å¾®ä¿¡å°ç¨‹åº** | WXML + WXSS + JavaScript + è…¾è®¯äº‘ AR SDK |
| **åå°ç®¡ç†å‰ç«¯** | Vue 3 + Element Plus + Vite + Pinia |

### åç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| **Node.js** | è¿è¡Œæ—¶ç¯å¢ƒ |
| **Express** | Web æ¡†æ¶ |
| **better-sqlite3** | SQLite æ•°æ®åº“é©±åŠ¨ |
| **ioredis** | Redis å®¢æˆ·ç«¯ |
| **jsonwebtoken** | JWT è®¤è¯ |
| **bcryptjs** | å¯†ç åŠ å¯† |
| **cos-nodejs-sdk-v5** | è…¾è®¯äº‘ COS SDK |
| **multer** | æ–‡ä»¶ä¸Šä¼  |
| **sharp** | å›¾ç‰‡å¤„ç† |

### åŸºç¡€è®¾æ–½

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| **Docker** | å®¹å™¨åŒ–éƒ¨ç½² |
| **Docker Compose** | æœåŠ¡ç¼–æ’ |
| **Nginx** | åå‘ä»£ç† + SSL ç»ˆæ­¢ |
| **SQLite** | å…³ç³»å‹æ•°æ®åº“ |
| **Redis** | ç¼“å­˜ + æ¶ˆæ¯é˜Ÿåˆ— |
| **è…¾è®¯äº‘ COS** | å¯¹è±¡å­˜å‚¨ï¼ˆç…§ç‰‡ã€ç´ æï¼‰ |

## ğŸ“ é¡¹ç›®ç»“æ„

```
miniprogram-1/                    # é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ miniprogram/                  # å¾®ä¿¡å°ç¨‹åºæºç 
â”‚   â”œâ”€â”€ pages/                    # å°ç¨‹åºé¡µé¢
â”‚   â”œâ”€â”€ components/               # å°ç¨‹åºç»„ä»¶
â”‚   â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ app.js                    # å°ç¨‹åºå…¥å£
â”‚
â”œâ”€â”€ core-api/                     # ç»Ÿä¸€åç«¯æœåŠ¡ (æ¨è)
â”‚   â”œâ”€â”€ index.js                  # ä¸»å…¥å£
â”‚   â”œâ”€â”€ config/                   # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ database.js           # æ•°æ®åº“é…ç½®
â”‚   â”‚   â””â”€â”€ cos.js                # COS é…ç½®
â”‚   â”œâ”€â”€ routes/                   # è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ miniprogram/          # å°ç¨‹åºç«¯è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ user.js           # ç”¨æˆ·ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ points.js         # ç§¯åˆ†ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ photo.js          # ç…§ç‰‡ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ invite.js         # é‚€è¯·ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ config.js         # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ virtual-pay.js    # è™šæ‹Ÿæ”¯ä»˜
â”‚   â”‚   â””â”€â”€ admin/                # åå°ç®¡ç†è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ auth.js           # è®¤è¯
â”‚   â”‚       â”œâ”€â”€ users.js          # ç”¨æˆ·ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ stats.js          # ç»Ÿè®¡
â”‚   â”‚       â”œâ”€â”€ config.js         # é…ç½®
â”‚   â”‚       â””â”€â”€ scenes.js         # åœºæ™¯ç®¡ç†
â”‚   â”œâ”€â”€ lib/                      # æ ¸å¿ƒåº“
â”‚   â”‚   â””â”€â”€ redis-message-handler.js  # Redis æ¶ˆæ¯å¤„ç†
â”‚   â””â”€â”€ public/                   # é™æ€æ–‡ä»¶
â”‚       â””â”€â”€ admin/                # åå°ç®¡ç†å‰ç«¯æ„å»ºäº§ç‰©
â”‚
â”œâ”€â”€ admin-server/                 # åå°ç®¡ç†ç³»ç»Ÿ (æ—§ç‰ˆ)
â”‚   â”œâ”€â”€ admin-web/                # åå°å‰ç«¯æºç 
â”‚   â”‚   â”œâ”€â”€ src/                  # Vue æºç 
â”‚   â”‚   â”‚   â”œâ”€â”€ views/            # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ components/       # å…¬å…±ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ router/           # è·¯ç”±é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ store/            # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ api/              # API æ¥å£
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ server/                   # åå°åç«¯æœåŠ¡
â”‚       â”œâ”€â”€ app.js                # ä¸»å…¥å£
â”‚       â”œâ”€â”€ routes/               # è·¯ç”±
â”‚       â”œâ”€â”€ config/               # é…ç½®
â”‚       â”œâ”€â”€ middleware/           # ä¸­é—´ä»¶
â”‚       â””â”€â”€ database/             # æ•°æ®åº“æ–‡ä»¶
â”‚
â”œâ”€â”€ services/                     # å¾®æœåŠ¡
â”‚   â”œâ”€â”€ ai-service/               # AI æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ index.js
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â””â”€â”€ pay-service/              # æ”¯ä»˜æœåŠ¡
â”‚       â”œâ”€â”€ index.js
â”‚       â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ docker/                       # Docker é…ç½®
â”‚   â”œâ”€â”€ deploy.sh                 # éƒ¨ç½²è„šæœ¬ (æ—§ç‰ˆ)
â”‚   â”œâ”€â”€ deploy-optimized.sh       # éƒ¨ç½²è„šæœ¬ (ä¼˜åŒ–ç‰ˆ)
â”‚   â”œâ”€â”€ config/                   # ç¯å¢ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ common.env            # é€šç”¨ç¯å¢ƒå˜é‡
â”‚   â”‚   â””â”€â”€ common.env.example    # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”‚   â”œâ”€â”€ nginx/                    # Nginx é…ç½®
â”‚   â”‚   â”œâ”€â”€ nginx.conf            # ä¸»é…ç½®
â”‚   â”‚   â”œâ”€â”€ conf.d/               # ç«™ç‚¹é…ç½®
â”‚   â”‚   â””â”€â”€ ssl/                  # SSL è¯ä¹¦
â”‚   â”œâ”€â”€ certs/                    # æ”¯ä»˜è¯ä¹¦
â”‚   â””â”€â”€ scripts/                  # è¾…åŠ©è„šæœ¬
â”‚
â”œâ”€â”€ docs/                         # æ–‡æ¡£
â”‚   â”œâ”€â”€ midplatform-design.sql    # æ•°æ®åº“è®¾è®¡
â”‚   â”œâ”€â”€ midplatform-plan.md       # é¡¹ç›®è§„åˆ’
â”‚   â”œâ”€â”€ miniprogram-review-checklist.md  # å°ç¨‹åºå®¡æ ¸æ¸…å•
â”‚   â”œâ”€â”€ overseas-access-solution.md      # æµ·å¤–è®¿é—®æ–¹æ¡ˆ
â”‚   â””â”€â”€ user-id-strategy.md       # ç”¨æˆ·IDç­–ç•¥
â”‚
â”œâ”€â”€ docker-compose.yml            # Docker ç¼–æ’ (æ—§ç‰ˆ 5 æœåŠ¡)
â”œâ”€â”€ docker-compose.optimized.yml  # Docker ç¼–æ’ (ä¼˜åŒ–ç‰ˆ 4 æœåŠ¡)
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡ (ä¸»é…ç½®)
â”œâ”€â”€ .env.deploy                   # éƒ¨ç½²é…ç½®
â”œâ”€â”€ env.example                   # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ package.json                  # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ project.config.json           # å°ç¨‹åºé…ç½®
â”œâ”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ DOCKER_DEPLOY.md              # Docker éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ ARCHITECTURE_OPTIMIZED.md     # æ¶æ„ä¼˜åŒ–è¯´æ˜
â””â”€â”€ CLAUDE.md                     # æœ¬æ–‡æ¡£
```

## ğŸ” å¯†é’¥å’Œé…ç½®æ–‡ä»¶ä½ç½®

### ç¯å¢ƒå˜é‡æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ç”¨é€” | è¯´æ˜ |
|---------|------|------|
| **`.env`** | ä¸»ç¯å¢ƒå˜é‡é…ç½® | Docker Compose ä½¿ç”¨ï¼ŒåŒ…å«æ‰€æœ‰æœåŠ¡çš„é…ç½® |
| **`.env.deploy`** | éƒ¨ç½²é…ç½® | æœåŠ¡å™¨ä¿¡æ¯ã€è·¯å¾„ã€è´¦å·ç­‰éƒ¨ç½²ç›¸å…³é…ç½® |
| **`env.example`** | ç¯å¢ƒå˜é‡ç¤ºä¾‹ | æ¨¡æ¿æ–‡ä»¶ï¼Œå¤åˆ¶åå¡«å†™å®é™…å€¼ |
| **`.env.deploy.example`** | éƒ¨ç½²é…ç½®ç¤ºä¾‹ | éƒ¨ç½²é…ç½®æ¨¡æ¿ |
| **`docker/config/common.env`** | Docker é€šç”¨é…ç½® | ä¼˜åŒ–ç‰ˆæ¶æ„ä½¿ç”¨çš„ç»Ÿä¸€ç¯å¢ƒå˜é‡ |
| **`docker/config/common.env.example`** | Docker é…ç½®ç¤ºä¾‹ | æ¨¡æ¿æ–‡ä»¶ |
| **`admin-server/server/.env`** | ç®¡ç†åå°æœåŠ¡é…ç½® | æ—§ç‰ˆæ¶æ„ä½¿ç”¨ |

### å…³é”®é…ç½®é¡¹

#### å¾®ä¿¡å°ç¨‹åºé…ç½®
```env
WX_APPID=wxf67c9b6c7b94a9bb          # å°ç¨‹åº AppID
WX_SECRET=your_wx_secret              # å°ç¨‹åº Secret
```

#### å¾®ä¿¡æ”¯ä»˜é…ç½®
```env
WX_MCH_ID=your_mch_id                 # å•†æˆ·å·
WX_PAY_API_KEY=your_pay_api_key       # API å¯†é’¥
WX_PAY_CERT_SERIAL=your_cert_serial   # è¯ä¹¦åºåˆ—å·
WX_PAY_NOTIFY_URL=https://pop-pub.com/api/pay/notify  # æ”¯ä»˜å›è°ƒåœ°å€
```

#### AI æœåŠ¡é…ç½®
```env
AI_API_KEY=your_ai_api_key            # AI API å¯†é’¥
AI_API_BASE=https://api.vectorengine.ai  # AI API åœ°å€
```

#### è…¾è®¯äº‘ COS é…ç½®
```env
COS_SECRET_ID=your_cos_secret_id      # COS Secret ID
COS_SECRET_KEY=your_cos_secret_key    # COS Secret Key
```

#### JWT é…ç½®
```env
JWT_SECRET=your_jwt_secret            # JWT å¯†é’¥ï¼ˆç”¨äºåå°ç®¡ç†è®¤è¯ï¼‰
```

#### æ•°æ®åº“é…ç½®
```env
SHARED_DB_PATH=/app/data/flashphoto.db  # SQLite æ•°æ®åº“è·¯å¾„
```

### è¯ä¹¦æ–‡ä»¶ä½ç½®

| æ–‡ä»¶è·¯å¾„ | ç”¨é€” |
|---------|------|
| **`docker/nginx/ssl/`** | SSL è¯ä¹¦ç›®å½•ï¼ˆfullchain.pem, privkey.pemï¼‰ |
| **`docker/certs/`** | å¾®ä¿¡æ”¯ä»˜è¯ä¹¦ç›®å½• |
| **`pub_key.pem`** | å…¬é’¥æ–‡ä»¶ |

### æ•°æ®åº“æ–‡ä»¶ä½ç½®

**é‡è¦ï¼šæ‰€æœ‰æœåŠ¡ç°å·²ç»Ÿä¸€ä½¿ç”¨å•ä¸€æ•°æ®åº“æ–‡ä»¶**

| ç¯å¢ƒ | æ•°æ®åº“è·¯å¾„ | è¯´æ˜ |
|------|-----------|------|
| **Docker ç¯å¢ƒ** | `/app/data/flashphoto.db` | æ‰€æœ‰æœåŠ¡å…±äº«ï¼ŒæŒ‚è½½åˆ° `flashphoto-shared-data` å· |
| **æœ¬åœ°å¼€å‘** | `core-api/data/flashphoto.db` | ç»Ÿä¸€æ•°æ®åº“æ–‡ä»¶ |

**æ—§æ•°æ®åº“æ–‡ä»¶ï¼ˆå·²åºŸå¼ƒï¼Œä»…ä¾›è¿ç§»å‚è€ƒï¼‰ï¼š**

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `admin-server/server/database/xingmei.db` | æ—§ç‰ˆç®¡ç†åå°æ•°æ®åº“ |
| `admin-server/server/database/flashphoto.db` | æ—§ç‰ˆç®¡ç†åå°æ•°æ®åº“ |
| `server/data/flashphoto_prod.db` | æ—§ç‰ˆå°ç¨‹åºç”Ÿäº§æ•°æ®åº“ |
| `server/data/flashphoto_test.db` | æ—§ç‰ˆå°ç¨‹åºæµ‹è¯•æ•°æ®åº“ |

**æ•°æ®è¿ç§»ï¼š** å¦‚éœ€è¿ç§»æ—§æ•°æ®ï¼Œè¿è¡Œ `node scripts/migrate-database.js`

## ğŸš€ Docker éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šä¼˜åŒ–ç‰ˆæ¶æ„éƒ¨ç½² (æ¨è)

#### 1. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
cp docker/config/common.env.example docker/config/common.env

# ç¼–è¾‘é…ç½®ï¼Œå¡«å†™å®é™…å€¼
vim docker/config/common.env
```

#### 2. é…ç½® SSL è¯ä¹¦ï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# å°† SSL è¯ä¹¦æ”¾ç½®åˆ°æŒ‡å®šç›®å½•
mkdir -p docker/nginx/ssl
cp /path/to/fullchain.pem docker/nginx/ssl/
cp /path/to/privkey.pem docker/nginx/ssl/
```

#### 3. ä¸€é”®éƒ¨ç½²

```bash
# ç»™éƒ¨ç½²è„šæœ¬æ‰§è¡Œæƒé™
chmod +x docker/deploy-optimized.sh

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
bash docker/deploy-optimized.sh start
```

#### 4. å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
bash docker/deploy-optimized.sh start

# åœæ­¢æœåŠ¡
bash docker/deploy-optimized.sh stop

# é‡å¯æœåŠ¡
bash docker/deploy-optimized.sh restart

# æŸ¥çœ‹æ—¥å¿—
bash docker/deploy-optimized.sh logs

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
bash docker/deploy-optimized.sh status

# å¤‡ä»½æ•°æ®
bash docker/deploy-optimized.sh backup

# å¥åº·æ£€æŸ¥
bash docker/deploy-optimized.sh health
```

### æ–¹å¼äºŒï¼šæ—§ç‰ˆæ¶æ„éƒ¨ç½²

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡
cp env.example .env
vim .env

# å¯åŠ¨æœåŠ¡
bash docker/deploy.sh start

# å…¶ä»–å‘½ä»¤ä¸ä¼˜åŒ–ç‰ˆç›¸åŒ
```

### æ–¹å¼ä¸‰ï¼šæ‰‹åŠ¨ Docker Compose éƒ¨ç½²

```bash
# ä¼˜åŒ–ç‰ˆæ¶æ„
docker compose -f docker-compose.optimized.yml up -d --build

# æ—§ç‰ˆæ¶æ„
docker compose -f docker-compose.yml up -d --build

# åœæ­¢æœåŠ¡
docker compose down

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker compose ps
```

## ğŸŒ è®¿é—®åœ°å€

éƒ¨ç½²å®Œæˆåï¼Œå¯é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

| æœåŠ¡ | HTTPS åœ°å€ | HTTP æµ‹è¯•åœ°å€ |
|------|-----------|--------------|
| **åå°ç®¡ç†** | https://pop-pub.com/admin | http://æœåŠ¡å™¨IP:13001/admin |
| **å°ç¨‹åº API** | https://pop-pub.com/api | http://æœåŠ¡å™¨IP:13001/api |
| **å¥åº·æ£€æŸ¥** | https://pop-pub.com/api/health | http://æœåŠ¡å™¨IP:13001/api/health |

### é»˜è®¤ç®¡ç†å‘˜è´¦å·

- **ç”¨æˆ·å**: `admin`
- **å¯†ç **: `admin123`

âš ï¸ **é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼**

## ğŸ“Š æ•°æ®åº“ç»“æ„

é¡¹ç›®ä½¿ç”¨ SQLite æ•°æ®åº“ï¼Œ**æ‰€æœ‰æœåŠ¡å…±äº«ç»Ÿä¸€çš„æ•°æ®åº“æ–‡ä»¶**ã€‚

### æ ¸å¿ƒä¸šåŠ¡è¡¨

| è¡¨å | è¯´æ˜ |
|------|------|
| **users** | ç”¨æˆ·è¡¨ï¼ˆå°ç¨‹åºç”¨æˆ·ï¼‰ |
| **admins** | ç®¡ç†å‘˜è¡¨ |
| **photo_history** | ç…§ç‰‡ç”Ÿæˆå†å²è®°å½• |
| **points_records** | ç§¯åˆ†å˜åŠ¨è®°å½• |
| **orders** | å……å€¼è®¢å•è¡¨ |
| **invites** | é‚€è¯·è®°å½• |
| **feedbacks** | ç”¨æˆ·åé¦ˆ |
| **virtual_pay_orders** | iOS è™šæ‹Ÿæ”¯ä»˜è®¢å• |
| **operation_logs** | ç®¡ç†å‘˜æ“ä½œæ—¥å¿— |

### é…ç½®è¡¨

| è¡¨å | è¯´æ˜ |
|------|------|
| **scenes** | åœºæ™¯é…ç½® |
| **scene_steps** | åœºæ™¯æ­¥éª¤å®šä¹‰ |
| **step_options** | æ­¥éª¤é€‰é¡¹ |
| **prompt_templates** | AI Prompt æ¨¡æ¿ |
| **photo_specs** | ç…§ç‰‡è§„æ ¼ï¼ˆä¸€å¯¸ã€äºŒå¯¸ç­‰ï¼‰ |
| **recharge_packages** | å……å€¼å¥—é¤ |
| **point_rewards** | ç§¯åˆ†å¥–åŠ±é…ç½® |
| **system_config** | ç³»ç»Ÿé…ç½® |

è¯¦ç»†æ•°æ®åº“è®¾è®¡å‚è§ï¼š[`docs/midplatform-design.sql`](docs/midplatform-design.sql:1)

## ğŸ”„ API è·¯ç”±è¯´æ˜

### Core API è·¯ç”± (ç«¯å£ 13001)

#### å°ç¨‹åºç«¯è·¯ç”±

| è·¯ç”±å‰ç¼€ | è¯´æ˜ | ä¸»è¦åŠŸèƒ½ |
|---------|------|---------|
| `/api/user/*` | ç”¨æˆ·ç®¡ç† | ç™»å½•ã€æ³¨å†Œã€ä¿¡æ¯ç®¡ç† |
| `/api/points/*` | ç§¯åˆ†ç®¡ç† | ä½™é¢æŸ¥è¯¢ã€æ¶ˆè´¹ã€å……å€¼ã€è®°å½• |
| `/api/photo/*` | ç…§ç‰‡ç®¡ç† | åˆ›å»ºã€å†å²ã€åˆ é™¤ |
| `/api/invite/*` | é‚€è¯·ç®¡ç† | ç»Ÿè®¡ã€è®°å½• |
| `/api/config/*` | é…ç½®ç®¡ç† | å…¬å¼€é…ç½®ã€åœºæ™¯åˆ—è¡¨ |
| `/api/virtual-pay/*` | è™šæ‹Ÿæ”¯ä»˜ | iOS è™šæ‹Ÿæ”¯ä»˜ |

#### åå°ç®¡ç†è·¯ç”±

| è·¯ç”±å‰ç¼€ | è¯´æ˜ | ä¸»è¦åŠŸèƒ½ |
|---------|------|---------|
| `/api/admin/auth/*` | è®¤è¯ | ç™»å½•ã€éªŒè¯ |
| `/api/admin/users/*` | ç”¨æˆ·ç®¡ç† | ç”¨æˆ·åˆ—è¡¨ã€è¯¦æƒ…ã€ç¼–è¾‘ |
| `/api/admin/stats/*` | ç»Ÿè®¡ | ä»ªè¡¨ç›˜ã€è¶‹åŠ¿åˆ†æ |
| `/api/admin/config/*` | é…ç½®ç®¡ç† | ç³»ç»Ÿé…ç½®ã€å¥–åŠ±è®¾ç½® |
| `/api/admin/scenes/*` | åœºæ™¯ç®¡ç† | åœºæ™¯åˆ—è¡¨ã€ç¼–è¾‘ã€æ­¥éª¤é…ç½® |

#### å…¼å®¹è·¯ç”±ï¼ˆæ—§ç‰ˆå‰ç«¯ï¼‰

ä¸ºå…¼å®¹æ—§ç‰ˆå‰ç«¯ï¼Œä»¥ä¸‹è·¯ç”±ä¸å¸¦ `/admin` å‰ç¼€ä¹Ÿå¯è®¿é—®ï¼š
- `/api/auth/*` â†’ `/api/admin/auth/*`
- `/api/users/*` â†’ `/api/admin/users/*`
- `/api/stats/*` â†’ `/api/admin/stats/*`
- `/api/scenes/*` â†’ `/api/admin/scenes/*`

## ğŸ”§ å¼€å‘æŒ‡å—

### æœ¬åœ°å¼€å‘ç¯å¢ƒæ­å»º

#### 1. å®‰è£…ä¾èµ–

```bash
# å®‰è£…å°ç¨‹åºä¾èµ–
cd miniprogram
npm install

# å®‰è£…åå°ç®¡ç†å‰ç«¯ä¾èµ–
cd ../admin-server/admin-web
npm install

# å®‰è£… Core API ä¾èµ–
cd ../../core-api
npm install
```

#### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘é…ç½®
vim .env
```

#### 3. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ Redis (éœ€è¦å…ˆå®‰è£… Redis)
redis-server

# å¯åŠ¨ Core API
cd core-api
npm start

# å¯åŠ¨åå°ç®¡ç†å‰ç«¯ (å¼€å‘æ¨¡å¼)
cd admin-server/admin-web
npm run dev
```

#### 4. å¾®ä¿¡å¼€å‘è€…å·¥å…·

1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. å¯¼å…¥é¡¹ç›®ï¼Œé€‰æ‹© `miniprogram/` ç›®å½•
3. é…ç½® AppID: `wxf67c9b6c7b94a9bb`
4. ç‚¹å‡»ã€å·¥å…·ã€‘â†’ã€æ„å»º npmã€‘

### æ„å»ºåå°ç®¡ç†å‰ç«¯

```bash
cd admin-server/admin-web
npm run build

# æ„å»ºäº§ç‰©ä¼šè¾“å‡ºåˆ° admin-server/server/public/admin/
# æˆ–å¤åˆ¶åˆ° core-api/public/admin/
```

## ğŸ“ é‡è¦æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [`README.md`](README.md:1) | é¡¹ç›®åŸºæœ¬è¯´æ˜ |
| [`DOCKER_DEPLOY.md`](DOCKER_DEPLOY.md:1) | Docker éƒ¨ç½²è¯¦ç»†æŒ‡å— |
| [`ARCHITECTURE_OPTIMIZED.md`](ARCHITECTURE_OPTIMIZED.md:1) | æ¶æ„ä¼˜åŒ–è¯´æ˜ |
| [`docs/midplatform-plan.md`](docs/midplatform-plan.md:1) | é¡¹ç›®è§„åˆ’ |
| [`docs/miniprogram-review-checklist.md`](docs/miniprogram-review-checklist.md:1) | å°ç¨‹åºå®¡æ ¸æ¸…å• |
| [`docs/overseas-access-solution.md`](docs/overseas-access-solution.md:1) | æµ·å¤–è®¿é—®æ–¹æ¡ˆ |
| [`docs/user-id-strategy.md`](docs/user-id-strategy.md:1) | ç”¨æˆ·IDç­–ç•¥ |

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ä¿®æ”¹é»˜è®¤å¯†ç **: é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
2. **é…ç½® SSL**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
3. **ä¿æŠ¤å¯†é’¥**: ç¡®ä¿ `.env` æ–‡ä»¶ä¸è¢«æäº¤åˆ°ä»£ç ä»“åº“ï¼ˆå·²åœ¨ `.gitignore` ä¸­ï¼‰
4. **é˜²ç«å¢™**: åªå¼€æ”¾ 80/443 ç«¯å£ï¼Œå†…éƒ¨æœåŠ¡ç«¯å£ä¸å¯¹å¤–æš´éœ²
5. **å®šæœŸå¤‡ä»½**: ä½¿ç”¨éƒ¨ç½²è„šæœ¬å®šæœŸå¤‡ä»½æ•°æ®åº“
6. **æ›´æ–°ä¾èµ–**: å®šæœŸæ›´æ–° Node.js å’Œä¾èµ–åŒ…
7. **å¼ºå¯†é’¥**: JWT_SECRET å¿…é¡»ä½¿ç”¨å¼ºéšæœºå€¼ï¼ˆ`openssl rand -base64 32`ï¼‰

## ğŸ› å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼Ÿ

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker compose logs -f

# æŸ¥çœ‹æŒ‡å®šæœåŠ¡æ—¥å¿—
docker compose logs -f core-api
docker compose logs -f ai-service
```

### Q: å¦‚ä½•è¿›å…¥å®¹å™¨è°ƒè¯•ï¼Ÿ

```bash
# è¿›å…¥ Core API å®¹å™¨
docker exec -it flashphoto-core-api sh

# æŸ¥çœ‹æ•°æ®åº“
sqlite3 /app/data/flashphoto.db ".tables"
```

### Q: å¦‚ä½•å¤‡ä»½å’Œæ¢å¤æ•°æ®ï¼Ÿ

```bash
# å¤‡ä»½
bash docker/deploy-optimized.sh backup

# æ¢å¤
bash docker/deploy-optimized.sh restore /path/to/backup.tar.gz
```

### Q: å¦‚ä½•æ›´æ–°ä»£ç å¹¶é‡æ–°éƒ¨ç½²ï¼Ÿ

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
bash docker/deploy-optimized.sh update
```

### Q: ç«¯å£è¢«å ç”¨æ€ä¹ˆåŠï¼Ÿ

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep 13001

# ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„
# ä¾‹å¦‚å°† 13001:3001 æ”¹ä¸º 13011:3001
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **Docker æ˜¯å¦æ­£ç¡®å®‰è£…**: `docker --version`
2. **ç¯å¢ƒå˜é‡æ˜¯å¦é…ç½®**: `cat .env`
3. **å®¹å™¨æ—¥å¿—**: `docker compose logs`
4. **æœåŠ¡å¥åº·çŠ¶æ€**: `curl http://localhost:13001/api/health`
5. **æ•°æ®åº“æ–‡ä»¶æƒé™**: ç¡®ä¿ Docker æœ‰æƒé™è®¿é—®æ•°æ®åº“æ–‡ä»¶

## ğŸ“Œ å¿«é€Ÿå‚è€ƒ

### æœåŠ¡å™¨ä¿¡æ¯ä½ç½®

- **æœåŠ¡å™¨ IP**: æŸ¥çœ‹ [`.env.deploy`](.env.deploy:5)
- **åŸŸå**: pop-pub.com
- **æœåŠ¡å™¨è·¯å¾„**: æŸ¥çœ‹ [`.env.deploy`](.env.deploy:11-14)

### å¯†é’¥ä½ç½®

- **å¾®ä¿¡é…ç½®**: [`.env`](.env:12-14)
- **æ”¯ä»˜é…ç½®**: [`.env`](.env:16-20)
- **AI é…ç½®**: [`.env`](.env:22-24)
- **COS é…ç½®**: [`.env`](.env:26-30)
- **JWT å¯†é’¥**: [`.env`](.env:32-35)

### éƒ¨ç½²è„šæœ¬

- **ä¼˜åŒ–ç‰ˆ**: [`docker/deploy-optimized.sh`](docker/deploy-optimized.sh:1)
- **æ—§ç‰ˆ**: [`docker/deploy.sh`](docker/deploy.sh:1)

### Docker ç¼–æ’æ–‡ä»¶

- **ä¼˜åŒ–ç‰ˆ**: [`docker-compose.optimized.yml`](docker-compose.optimized.yml:1)
- **æ—§ç‰ˆ**: [`docker-compose.yml`](docker-compose.yml:1)

---

**æœ€åæ›´æ–°**: 2026-01-20  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
