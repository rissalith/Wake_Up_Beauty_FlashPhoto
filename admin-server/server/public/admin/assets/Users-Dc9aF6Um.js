import{F as e,r as a,x as l,i as t,c as s,o as u,e as n,G as i,w as d,f as o,H as r,I as c,d as v,t as p,h as m,g as f,J as _,j as g,K as y,L as h,M as w,N as b,O as k,P as x,Q as V,l as z,E as C}from"./index-1m_ef7t3.js";import{u as U,t as I}from"./timezone-To2cqxMU.js";import{_ as D,u as S}from"./_plugin-vue_export-helper-D4xNqaWu.js";const j={class:"users-page"},A={class:"card-header"},B={class:"header-right"},P={class:"user-cell"},W={key:1,class:"user-avatar"},T={class:"user-info"},Y={class:"nickname"},H={class:"user-id"},M={key:0,class:"union-id"},O={key:1,class:"union-id"},R={class:"points-value"},$={class:"recharge-value"},q={style:{"white-space":"nowrap"}},F={class:"pagination-wrap"},K={key:0,class:"user-detail"},L={class:"detail-header"},N={key:1,class:"detail-avatar"},E={class:"detail-info"},G={class:"detail-id"},J={class:"detail-points"},Q={class:"points-num"},X={class:"stats-cards"},Z={class:"stat-card recharge"},ee={class:"stat-icon"},ae={class:"stat-content"},le={class:"stat-value"},te={class:"stat-sub"},se={class:"stat-card consume"},ue={class:"stat-icon"},ne={class:"stat-content"},ie={class:"stat-value"},de={class:"stat-sub"},oe={class:"stat-card share"},re={class:"stat-icon"},ce={class:"stat-content"},ve={class:"stat-value"},pe={class:"stat-sub"},me={class:"stat-card invite"},fe={class:"stat-icon"},_e={class:"stat-content"},ge={class:"stat-value"},ye={class:"stat-sub"},he={class:"id-text"},we={class:"id-text"},be={key:2,class:"agreement-time"},ke={key:2,class:"agreement-time"},xe={class:"amount-text"},Ve={class:"points-value"},ze={class:"photo-grid"},Ce={class:"photo-info"},Ue={class:"points-value"},Ie={key:0,style:{color:"#f56c6c","margin-left":"8px"}},De=D({__name:"Users",setup(D){e.extend(U),e.extend(I);const De=a(!1),Se=a([]),je=a(1),Ae=a(20),Be=a(0),Pe=a(""),We=a(!1),Te=a(null),Ye=a({}),He=a(!1),Me=a(!1),Oe=a(!1),Re=a([]),$e=a(null),qe=a(!1),Fe=a(!1),Ke=a([]),Le=a(null),Ne=a(!1),Ee=a(!1),Ge=a({type:"add",amount:null,reason:""}),Je=l(()=>{var e;if(!Te.value||!Ge.value.amount)return(null==(e=Te.value)?void 0:e.points)||0;const a=Te.value.points||0,l=Ge.value.amount||0;return"add"===Ge.value.type?a+l:a-l}),Qe=a=>a?e.utc(a).tz("Asia/Shanghai").format("YYYY-MM-DD HH:mm:ss"):"-",Xe=e=>e?Number(e).toFixed(2):"0.00",Ze=e=>!(!e||"string"!=typeof e)&&(!e.startsWith("wxfile://")&&(!e.startsWith("http://tmp")&&!e.startsWith("https://tmp")&&(e.startsWith("http://")||e.startsWith("https://")))),ea=async()=>{De.value=!0;try{const e=await S.getList({page:je.value,pageSize:Ae.value,keyword:Pe.value});200!==e.code&&0!==e.code&&0!==e.code||(Se.value=e.data.list,Be.value=e.data.total)}finally{De.value=!1}},aa=()=>{Ge.value={type:"add",amount:null,reason:""},Ne.value=!0},la=async()=>{var e,a;if(Ge.value.amount&&Ge.value.reason)if(Je.value<0)C.error("扣减后余额不能为负数");else try{await z.confirm(`确定要${"add"===Ge.value.type?"增加":"扣减"} ${Ge.value.amount} 醒币吗？`,"确认修正",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),Ee.value=!0;const e="add"===Ge.value.type?Ge.value.amount:-Ge.value.amount,a=await S.adjustPoints(Te.value.user_id||Te.value.id,{amount:e,type:Ge.value.type,reason:Ge.value.reason});200===a.code||0===a.code?(C.success(a.message||"醒币修正成功"),Ne.value=!1,Te.value.points=a.data.currentPoints,ea()):C.error(a.message||"醒币修正失败")}catch(l){"cancel"!==l&&(console.error("醒币修正失败:",l),C.error((null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"醒币修正失败"))}finally{Ee.value=!1}else C.warning("请填写修正数量和原因")};return t(()=>{ea()}),(e,a)=>{var l,t,U,I;const D=o("Search"),ta=o("el-icon"),sa=o("el-button"),ua=o("el-input"),na=o("el-avatar"),ia=o("el-table-column"),da=o("el-table"),oa=o("el-pagination"),ra=o("el-card"),ca=o("el-descriptions-item"),va=o("el-tag"),pa=o("el-descriptions"),ma=o("el-dialog"),fa=o("el-empty"),_a=o("el-image"),ga=o("el-form-item"),ya=o("el-radio"),ha=o("el-radio-group"),wa=o("el-input-number"),ba=o("el-form"),ka=c("loading"),xa=c("dialog-drag");return u(),s("div",j,[n(ra,null,{header:d(()=>[v("div",A,[a[12]||(a[12]=v("span",null,"用户管理",-1)),v("div",B,[n(ua,{modelValue:Pe.value,"onUpdate:modelValue":a[0]||(a[0]=e=>Pe.value=e),placeholder:"搜索用户ID/UnionID/昵称",style:{width:"250px"},clearable:"",onKeyup:f(ea,["enter"])},{append:d(()=>[n(sa,{onClick:ea},{default:d(()=>[n(ta,null,{default:d(()=>[n(D)]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(sa,{type:"primary",onClick:ea},{default:d(()=>[...a[11]||(a[11]=[m("刷新",-1)])]),_:1})])])]),default:d(()=>[i((u(),r(da,{data:Se.value,stripe:"",style:{width:"100%"}},{default:d(()=>[n(ia,{label:"用户","min-width":"320"},{default:d(({row:e})=>[v("div",P,[Ze(e.avatar_url)?(u(),r(na,{key:0,src:e.avatar_url,size:36},{default:d(()=>[v("span",null,p((e.nickname||"用户")[0]),1)]),_:2},1032,["src"])):(u(),s("div",W,[v("span",null,p((e.nickname||"用户")[0]),1)])),v("div",T,[v("div",Y,p(e.nickname||"未设置昵称"),1),v("div",H,"ID: "+p(e.user_id||e.id),1),e.unionid?(u(),s("div",M,"UnionID: "+p(e.unionid),1)):(u(),s("div",O,"UnionID: -"))])])]),_:1}),n(ia,{label:"醒币",width:"90",align:"center"},{default:d(({row:e})=>[v("span",R,p(e.points||0),1)]),_:1}),n(ia,{label:"累计充值",width:"100",align:"center"},{default:d(({row:e})=>[v("span",$,"¥"+p(Xe(e.total_recharge)),1)]),_:1}),n(ia,{label:"生成次数",width:"90",align:"center"},{default:d(({row:e})=>[v("span",null,p(e.photo_count||0),1)]),_:1}),n(ia,{label:"注册时间",width:"170"},{default:d(({row:e})=>[v("span",q,p(Qe(e.created_at)),1)]),_:1}),n(ia,{label:"操作",width:"240",fixed:"right"},{default:d(({row:e})=>[n(sa,{type:"primary",link:"",size:"small",onClick:a=>(async e=>{Te.value=e,Ye.value={},We.value=!0,He.value=!0;try{const a=await S.getStats(e.user_id||e.id);200!==a.code&&0!==a.code||(Ye.value=a.data)}catch(a){console.error("获取用户统计失败:",a)}finally{He.value=!1}})(e)},{default:d(()=>[...a[13]||(a[13]=[m("详情",-1)])]),_:1},8,["onClick"]),n(sa,{type:"primary",link:"",size:"small",onClick:a=>(async e=>{$e.value=e,Me.value=!0,Oe.value=!0,Re.value=[];try{const a=await S.getOrders(e.user_id||e.id,{pageSize:50});200!==a.code&&0!==a.code||(Re.value=a.data.list)}finally{Oe.value=!1}})(e)},{default:d(()=>[...a[14]||(a[14]=[m("订单",-1)])]),_:1},8,["onClick"]),n(sa,{type:"primary",link:"",size:"small",onClick:a=>(async e=>{Le.value=e,qe.value=!0,Fe.value=!0,Ke.value=[];try{const a=await S.getPhotos(e.user_id||e.id,{pageSize:50});200!==a.code&&0!==a.code||(Ke.value=a.data.list)}finally{Fe.value=!1}})(e)},{default:d(()=>[...a[15]||(a[15]=[m("照片",-1)])]),_:1},8,["onClick"]),n(sa,{type:"danger",link:"",size:"small",onClick:a=>(async e=>{try{await z.confirm(`确定要注销用户 "${e.nickname||e.user_id}" 吗？注销后该用户的所有数据（醒币、订单、照片等）将被永久删除，下次登录将作为新用户。`,"注销用户",{confirmButtonText:"确定注销",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"});const a=await S.deleteUser(e.user_id||e.id);200!==a.code&&0!==a.code||(C.success("用户注销成功"),ea())}catch(a){"cancel"!==a&&C.error("注销失败: "+(a.message||"未知错误"))}})(e)},{default:d(()=>[...a[16]||(a[16]=[m("注销",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ka,De.value]]),v("div",F,[n(oa,{"current-page":je.value,"onUpdate:currentPage":a[1]||(a[1]=e=>je.value=e),"page-size":Ae.value,"onUpdate:pageSize":a[2]||(a[2]=e=>Ae.value=e),total:Be.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",onChange:ea},null,8,["current-page","page-size","total"])])]),_:1}),i((u(),r(ma,{modelValue:We.value,"onUpdate:modelValue":a[3]||(a[3]=e=>We.value=e),title:"用户详情",width:"800px"},{default:d(()=>{var e,l,t,o,c,f,k,x,V;return[Te.value?i((u(),s("div",K,[v("div",L,[Ze(Te.value.avatar_url)?(u(),r(na,{key:0,src:Te.value.avatar_url,size:60},{default:d(()=>[v("span",null,p((Te.value.nickname||"用户")[0]),1)]),_:1},8,["src"])):(u(),s("div",N,[v("span",null,p((Te.value.nickname||"用户")[0]),1)])),v("div",E,[v("h3",null,p(Te.value.nickname||"未设置昵称"),1),v("p",G,p(Te.value.user_id||Te.value.id),1)]),v("div",J,[a[18]||(a[18]=v("div",{class:"points-label"},"醒币余额",-1)),v("div",Q,p(Te.value.points||0),1),n(sa,{type:"primary",size:"small",onClick:aa,style:{"margin-top":"8px"}},{default:d(()=>[...a[17]||(a[17]=[m(" 修正醒币 ",-1)])]),_:1})])]),v("div",X,[v("div",Z,[v("div",ee,[n(ta,null,{default:d(()=>[n(g(y))]),_:1})]),v("div",ae,[a[19]||(a[19]=v("div",{class:"stat-title"},"累计充值",-1)),v("div",le,"¥"+p(Xe(null==(e=Ye.value.totalRecharge)?void 0:e.amount)),1),v("div",te,"获得 "+p((null==(l=Ye.value.totalRecharge)?void 0:l.points)||0)+" 醒币 · "+p((null==(t=Ye.value.totalRecharge)?void 0:t.count)||0)+" 次",1)])]),v("div",se,[v("div",ue,[n(ta,null,{default:d(()=>[n(g(h))]),_:1})]),v("div",ne,[a[20]||(a[20]=v("div",{class:"stat-title"},"累计消费",-1)),v("div",ie,p((null==(o=Ye.value.totalConsume)?void 0:o.points)||0)+" 醒币",1),v("div",de,p((null==(c=Ye.value.totalConsume)?void 0:c.count)||0)+" 次",1)])]),v("div",oe,[v("div",re,[n(ta,null,{default:d(()=>[n(g(w))]),_:1})]),v("div",ce,[a[21]||(a[21]=v("div",{class:"stat-title"},"分享奖励",-1)),v("div",ve,p((null==(f=Ye.value.totalShare)?void 0:f.points)||0)+" 醒币",1),v("div",pe,p((null==(k=Ye.value.totalShare)?void 0:k.count)||0)+" 次分享",1)])]),v("div",me,[v("div",fe,[n(ta,null,{default:d(()=>[n(g(b))]),_:1})]),v("div",_e,[a[22]||(a[22]=v("div",{class:"stat-title"},"邀请奖励",-1)),v("div",ge,p((null==(x=Ye.value.totalInvite)?void 0:x.points)||0)+" 醒币",1),v("div",ye,p((null==(V=Ye.value.totalInvite)?void 0:V.count)||0)+" 人",1)])])]),n(pa,{column:2,border:"",class:"detail-desc"},{default:d(()=>[n(ca,{label:"OpenID","label-class-name":"desc-label","class-name":"desc-content",span:2},{default:d(()=>[v("span",he,p(Te.value.openid||"-"),1)]),_:1}),n(ca,{label:"UnionID","label-class-name":"desc-label","class-name":"desc-content",span:2},{default:d(()=>[v("span",we,p(Te.value.unionid||"-"),1)]),_:1}),n(ca,{label:"隐私协议","label-class-name":"desc-label"},{default:d(()=>{var e,l,t,n;return[(null==(l=null==(e=Ye.value.agreements)?void 0:e.privacy)?void 0:l.signed)?(u(),r(va,{key:0,type:"success",size:"small"},{default:d(()=>[...a[23]||(a[23]=[m(" 已签署 ",-1)])]),_:1})):(u(),r(va,{key:1,type:"info",size:"small"},{default:d(()=>[...a[24]||(a[24]=[m("未签署",-1)])]),_:1})),(null==(n=null==(t=Ye.value.agreements)?void 0:t.privacy)?void 0:n.signedAt)?(u(),s("span",be,p(Qe(Ye.value.agreements.privacy.signedAt)),1)):_("",!0)]}),_:1}),n(ca,{label:"用户协议","label-class-name":"desc-label"},{default:d(()=>{var e,l,t,n;return[(null==(l=null==(e=Ye.value.agreements)?void 0:e.terms)?void 0:l.signed)?(u(),r(va,{key:0,type:"success",size:"small"},{default:d(()=>[...a[25]||(a[25]=[m(" 已签署 ",-1)])]),_:1})):(u(),r(va,{key:1,type:"info",size:"small"},{default:d(()=>[...a[26]||(a[26]=[m("未签署",-1)])]),_:1})),(null==(n=null==(t=Ye.value.agreements)?void 0:t.terms)?void 0:n.signedAt)?(u(),s("span",ke,p(Qe(Ye.value.agreements.terms.signedAt)),1)):_("",!0)]}),_:1}),n(ca,{label:"注册时间","label-class-name":"desc-label",span:2},{default:d(()=>[m(p(Qe(Te.value.created_at)),1)]),_:1})]),_:1})])),[[ka,He.value]]):_("",!0)]}),_:1},8,["modelValue"])),[[xa]]),i((u(),r(ma,{modelValue:Me.value,"onUpdate:modelValue":a[4]||(a[4]=e=>Me.value=e),title:"用户订单 - "+((null==(l=$e.value)?void 0:l.nickname)||(null==(t=$e.value)?void 0:t.user_id)||""),width:"900px"},{default:d(()=>[i((u(),r(da,{data:Re.value},{default:d(()=>[n(ia,{prop:"order_id",label:"订单号","min-width":"220"}),n(ia,{prop:"amount",label:"金额",width:"100"},{default:d(({row:e})=>[v("span",xe,"¥"+p(Xe(e.amount)),1)]),_:1}),n(ia,{label:"获得醒币",width:"100"},{default:d(({row:e})=>[v("span",Ve,p((e.points_amount||0)+(e.bonus_points||0)),1)]),_:1}),n(ia,{prop:"status",label:"状态",width:"90"},{default:d(({row:e})=>[n(va,{type:"paid"===e.status?"success":"warning",size:"small"},{default:d(()=>{return[m(p((a=e.status,{paid:"已支付",pending:"待支付",cancelled:"已取消",refunded:"已退款",failed:"支付失败"}[a]||a)),1)];var a}),_:2},1032,["type"])]),_:1}),n(ia,{prop:"created_at",label:"创建时间",width:"170"},{default:d(({row:e})=>[m(p(Qe(e.created_at)),1)]),_:1})]),_:1},8,["data"])),[[ka,Oe.value]]),Oe.value||0!==Re.value.length?_("",!0):(u(),r(fa,{key:0,description:"暂无订单"}))]),_:1},8,["modelValue","title"])),[[xa]]),i((u(),r(ma,{modelValue:qe.value,"onUpdate:modelValue":a[5]||(a[5]=e=>qe.value=e),title:"用户照片 - "+((null==(U=Le.value)?void 0:U.nickname)||(null==(I=Le.value)?void 0:I.user_id)||""),width:"900px"},{default:d(()=>[i((u(),s("div",ze,[(u(!0),s(k,null,x(Ke.value,e=>(u(),s("div",{class:"photo-item",key:e.id},[n(_a,{src:e.result_image,"preview-src-list":[e.result_image],fit:"cover",class:"photo-img"},null,8,["src","preview-src-list"]),v("div",Ce,[v("span",null,p(e.spec||"-"),1),v("span",null,p(e.bg_color||"-"),1)])]))),128))])),[[ka,Fe.value]]),Fe.value||0!==Ke.value.length?_("",!0):(u(),r(fa,{key:0,description:"暂无照片"}))]),_:1},8,["modelValue","title"])),[[xa]]),i((u(),r(ma,{modelValue:Ne.value,"onUpdate:modelValue":a[10]||(a[10]=e=>Ne.value=e),title:"醒币修正",width:"500px"},{footer:d(()=>[n(sa,{onClick:a[9]||(a[9]=e=>Ne.value=!1)},{default:d(()=>[...a[30]||(a[30]=[m("取消",-1)])]),_:1}),n(sa,{type:"primary",onClick:la,loading:Ee.value,disabled:!Ge.value.amount||!Ge.value.reason||Je.value<0},{default:d(()=>[...a[31]||(a[31]=[m(" 确认修正 ",-1)])]),_:1},8,["loading","disabled"])]),default:d(()=>[Te.value?(u(),r(ba,{key:0,model:Ge.value,"label-width":"100px"},{default:d(()=>[n(ga,{label:"当前用户"},{default:d(()=>[v("span",null,p(Te.value.nickname||Te.value.user_id),1)]),_:1}),n(ga,{label:"当前余额"},{default:d(()=>[v("span",Ue,p(Te.value.points||0)+" 醒币",1)]),_:1}),n(ga,{label:"修正类型"},{default:d(()=>[n(ha,{modelValue:Ge.value.type,"onUpdate:modelValue":a[6]||(a[6]=e=>Ge.value.type=e)},{default:d(()=>[n(ya,{value:"add"},{default:d(()=>[...a[27]||(a[27]=[m("增加",-1)])]),_:1}),n(ya,{value:"deduct"},{default:d(()=>[...a[28]||(a[28]=[m("扣减",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),n(ga,{label:"修正数量",required:""},{default:d(()=>[n(wa,{modelValue:Ge.value.amount,"onUpdate:modelValue":a[7]||(a[7]=e=>Ge.value.amount=e),min:1,max:99999,placeholder:"请输入修正数量"},null,8,["modelValue"]),a[29]||(a[29]=v("span",{style:{"margin-left":"8px",color:"#909399"}},"醒币",-1))]),_:1}),n(ga,{label:"修正后余额"},{default:d(()=>[v("span",{class:V(["points-preview",Je.value<0?"negative":""])},p(Je.value)+" 醒币 ",3),Je.value<0?(u(),s("span",Ie," (余额不足) ")):_("",!0)]),_:1}),n(ga,{label:"修正原因",required:""},{default:d(()=>[n(ua,{modelValue:Ge.value.reason,"onUpdate:modelValue":a[8]||(a[8]=e=>Ge.value.reason=e),type:"textarea",rows:3,placeholder:"请输入修正原因，如：客服补偿、系统异常修正等",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])):_("",!0)]),_:1},8,["modelValue"])),[[xa]])])}}},[["__scopeId","data-v-5949dd13"]]);export{De as default};
