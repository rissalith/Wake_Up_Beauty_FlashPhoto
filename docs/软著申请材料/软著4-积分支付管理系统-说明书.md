# 积分支付管理系统 软件说明书

## 一、软件基本信息

- **软件全称**：积分支付管理系统软件
- **软件简称**：积分支付系统
- **版本号**：V1.0
- **开发完成日期**：2026年1月
- **软件分类**：应用软件/支付系统
- **运行平台**：Linux服务器
- **开发语言**：JavaScript (Node.js)
- **软件规模**：约6000行代码

---

## 二、软件概述

### 2.1 软件背景

在虚拟商品和服务交易场景中，积分系统作为一种灵活的支付方式被广泛应用。本系统为醒美闪图AI图片生成服务提供完整的积分管理和支付处理能力，支持微信支付充值、虚拟支付（iOS）、积分消费等功能。

### 2.2 软件目的

本软件的主要目的是：
1. 提供完整的积分生命周期管理
2. 集成微信支付实现积分充值
3. 支持iOS虚拟支付合规处理
4. 实现积分消费和退还机制

### 2.3 软件功能概述

本软件主要包含以下功能模块：
- 积分账户管理模块
- 微信支付集成模块
- 虚拟支付处理模块
- 订单管理模块
- 积分流水记录模块
- 消息队列通信模块

---

## 三、运行环境

### 3.1 硬件环境

- **服务器**：Linux服务器（推荐配置：2核CPU、4GB内存）
- **存储**：SSD硬盘，至少20GB可用空间
- **网络**：需要稳定的互联网连接

### 3.2 软件环境

- **操作系统**：Linux (Ubuntu 20.04+/CentOS 7+)
- **运行时**：Node.js 18.x
- **缓存**：Redis 7.x
- **数据库**：SQLite 3.x

---

## 四、功能详细说明

### 4.1 积分账户管理模块

#### 4.1.1 账户查询

查询用户的积分账户信息：
- 当前积分余额
- 累计获得积分
- 累计消费积分
- 账户状态

#### 4.1.2 余额变动

处理积分余额的变动：

| 变动类型 | 说明 |
|---------|------|
| 充值 | 用户付费购买积分 |
| 消费 | 使用积分购买服务 |
| 奖励 | 系统赠送积分 |
| 退还 | 服务失败退还积分 |
| 调整 | 管理员手动调整 |

#### 4.1.3 余额校验

在积分消费前进行余额校验：
- 检查余额是否充足
- 检查账户状态是否正常
- 防止并发消费导致超支

### 4.2 微信支付集成模块

#### 4.2.1 支付参数获取

调用微信支付API获取支付参数：
- 生成预支付订单
- 获取支付签名
- 返回小程序调起支付所需参数

#### 4.2.2 支付签名

实现微信支付V3版本的签名算法：
- RSA-SHA256签名
- 请求头构建
- 时间戳和随机串生成

#### 4.2.3 支付回调处理

处理微信支付的异步通知：
- 验证签名
- 解密通知数据
- 更新订单状态
- 发放积分

#### 4.2.4 订单查询

主动查询订单支付状态：
- 调用微信查询接口
- 同步订单状态
- 处理异常订单

### 4.3 虚拟支付处理模块

#### 4.3.1 iOS虚拟支付

针对iOS平台的虚拟支付处理：
- 符合App Store审核要求
- 虚拟商品购买流程
- 订单状态管理

#### 4.3.2 支付验证

验证虚拟支付的有效性：
- 订单信息验证
- 防重复支付
- 异常处理

### 4.4 订单管理模块

#### 4.4.1 订单创建

创建充值订单：

**订单信息**：
| 字段 | 说明 |
|-----|------|
| order_id | 订单号（唯一） |
| user_id | 用户ID |
| amount | 支付金额（分） |
| points | 获得积分 |
| status | 订单状态 |
| payment_method | 支付方式 |
| created_at | 创建时间 |

#### 4.4.2 订单状态流转

订单状态流转规则：

```
待支付 → 已支付 → 已完成
   ↓
已取消

已支付 → 已退款
```

#### 4.4.3 订单查询

支持多维度订单查询：
- 按用户查询
- 按状态查询
- 按时间范围查询
- 按订单号查询

### 4.5 积分流水记录模块

#### 4.5.1 流水记录

记录每一笔积分变动：

**记录字段**：
| 字段 | 说明 |
|-----|------|
| record_id | 记录ID |
| user_id | 用户ID |
| type | 变动类型 |
| amount | 变动数量 |
| balance_before | 变动前余额 |
| balance_after | 变动后余额 |
| description | 变动说明 |
| related_order | 关联订单 |
| created_at | 记录时间 |

#### 4.5.2 流水查询

支持流水记录查询：
- 按用户查询
- 按类型筛选
- 按时间范围查询
- 分页查询

### 4.6 消息队列通信模块

#### 4.6.1 Redis消息队列

使用Redis实现服务间通信：
- 支付结果通知
- 积分变动通知
- 异步任务处理

#### 4.6.2 消息发布

发布消息到指定频道：
- 支付成功消息
- 积分变动消息
- 订单状态变更消息

#### 4.6.3 消息订阅

订阅并处理消息：
- 消息接收
- 消息解析
- 业务处理
- 确认机制

---

## 五、系统架构

### 5.1 整体架构

```
┌─────────────────────────────────────────┐
│           积分支付管理系统               │
│  ┌─────────────────────────────────┐   │
│  │         API层                    │   │
│  │  充值接口 | 消费接口 | 查询接口   │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │        业务逻辑层                │   │
│  │  订单处理 | 积分管理 | 支付处理   │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │        外部服务层                │   │
│  │  微信支付API | Redis消息队列     │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │        数据层                    │   │
│  │  订单表 | 积分记录表 | 用户表     │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### 5.2 技术架构

- **运行时**：Node.js 18.x
- **Web框架**：Express.js
- **数据库**：SQLite
- **缓存/消息**：Redis (ioredis)
- **支付SDK**：微信支付V3

---

## 六、API接口说明

### 6.1 创建充值订单

**接口地址**：POST /api/recharge/create

**请求参数**：
```json
{
  "userId": "用户ID",
  "packageId": "套餐ID",
  "customAmount": 100
}
```

**响应参数**：
```json
{
  "code": 200,
  "data": {
    "orderId": "订单号",
    "amount": 100,
    "points": 1000,
    "payParams": {
      "timeStamp": "时间戳",
      "nonceStr": "随机串",
      "package": "prepay_id=xxx",
      "signType": "RSA",
      "paySign": "签名"
    }
  }
}
```

### 6.2 积分消费

**接口地址**：POST /api/points/consume

**请求参数**：
```json
{
  "userId": "用户ID",
  "amount": 100,
  "description": "生成证件照"
}
```

**响应参数**：
```json
{
  "code": 200,
  "data": {
    "balance": 900,
    "consumed": 100
  }
}
```

### 6.3 查询余额

**接口地址**：GET /api/points/balance

**请求参数**：
```
userId: 用户ID
```

**响应参数**：
```json
{
  "code": 200,
  "data": {
    "balance": 1000,
    "totalEarned": 1500,
    "totalSpent": 500
  }
}
```

### 6.4 支付回调

**接口地址**：POST /api/pay/notify

**说明**：微信支付异步通知接口，由微信服务器调用

---

## 七、数据流程

### 7.1 充值流程

```
用户发起充值 → 创建订单 → 调用微信支付
     ↓
获取支付参数 → 返回小程序 → 用户完成支付
     ↓
微信回调通知 → 验证签名 → 更新订单状态
     ↓
发放积分 → 记录流水 → 通知用户
```

### 7.2 消费流程

```
用户发起消费 → 检查余额 → 扣减积分
     ↓
记录流水 → 返回结果 → 执行业务
     ↓
业务失败 → 退还积分 → 记录流水
```

---

## 八、安全设计

### 8.1 支付安全

- 微信支付V3签名验证
- 回调通知验签
- 订单号唯一性校验
- 金额一致性校验

### 8.2 数据安全

- 敏感数据加密存储
- 传输层加密（HTTPS）
- 防SQL注入
- 防重放攻击

### 8.3 并发安全

- 数据库事务保证
- 乐观锁防超卖
- 幂等性设计

---

## 九、配置说明

### 9.1 环境变量

| 变量名 | 说明 | 默认值 |
|-------|------|-------|
| PORT | 服务端口 | 3003 |
| WX_MCH_ID | 微信商户号 | - |
| WX_PAY_API_KEY | 支付API密钥 | - |
| WX_PAY_CERT_SERIAL | 证书序列号 | - |
| REDIS_HOST | Redis地址 | localhost |
| REDIS_PORT | Redis端口 | 6379 |

---

## 十、著作权声明

本软件由开发者独立开发完成，拥有完整的知识产权。软件中使用的所有代码均为原创开发，未使用任何侵犯他人知识产权的内容。

---

**文档编写日期**：2026年1月
**文档版本**：V1.0
