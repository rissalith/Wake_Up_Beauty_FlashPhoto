import{r as e,a as l,x as a,z as t,i as o,f as n,I as s,c as i,o as d,d as c,G as r,e as u,w as p,O as m,P as v,H as g,g as f,j as _,W as y,h as b,X as h,Y as k,t as w,T as V,J as x,Q as C,E as z,l as U,Z as $,_ as I,$ as S,a0 as F,a1 as E,C as A,a2 as O,a3 as K,a4 as P,a5 as T,a6 as N,a7 as j,a8 as q,a9 as L,aa as B,ab as J,ac as D}from"./index-DQJe672r.js";import{S as R}from"./sortable.esm-Dhe0be67.js";import{d as W}from"./vuedraggable.umd-CvUCa-Ku.js";import{c as M,_ as G}from"./_plugin-vue_export-helper-DhoNb-KX.js";async function H(e){if(!e)return"";try{const l=await M.post("/translate/to-english",{text:e});return 0===l.code&&l.data?l.data.translated:(console.warn("翻译失败:",l.message),e)}catch(l){return console.error("翻译API调用失败:",l),e}}const Y={class:"draw-pool-manager"},Q={class:"toolbar"},X={class:"toolbar-left"},Z={class:"toolbar-right"},ee={class:"stats-bar"},le={class:"batch-bar"},ae={class:"batch-select-row"},te={key:0,class:"batch-action-row"},oe={class:"selected-count"},ne={key:1,class:"placeholder-icon"},se={class:"probability"},ie={class:"action-btns"},de={class:"image-picker"},ce={class:"image-picker-actions"},re={class:"cos-picker"},ue={class:"cos-picker-header"},pe={key:0,class:"filter-result"},me={class:"cos-image-grid"},ve=["onClick"],ge={class:"cos-image-info"},fe={class:"cos-image-name"},_e={__name:"DrawPoolManager",props:{sceneId:{type:String,required:!0},stepKey:{type:String,default:""},showImage:{type:Boolean,default:!1}},setup($,{expose:I}){const S=$,F=e([]),E=async()=>{if(S.sceneId&&S.stepKey)try{const e=await M.get(`/admin/grade-schemes/mapping/${S.sceneId}/${S.stepKey}`);if(0===e.code&&e.data&&e.data.grades)F.value=e.data.grades||[];else{const e=await M.get(`/admin/scenes/${S.sceneId}/draw-pool/${S.stepKey}/grades`);0===e.code&&(F.value=e.data||[])}}catch(e){try{const e=await M.get(`/admin/scenes/${S.sceneId}/draw-pool/${S.stepKey}/grades`);0===e.code&&(F.value=e.data||[])}catch(l){console.error("加载品级失败:",l)}}},A=e=>{const l=F.value.find(l=>l.grade_key===e||l.name===e);return(null==l?void 0:l.color)||"#909399"},O=e=>{const l=F.value.find(l=>l.grade_key===e||l.name===e);return(null==l?void 0:l.name)||e||"-"},K=e=>{if(!e.rarity||0===F.value.length)return"-";const l=F.value.reduce((e,l)=>e+(l.weight||0),0);if(0===l)return"-";const a=F.value.find(l=>l.grade_key===e.rarity||l.name===e.rarity);if(!a)return"-";const t=T.value.filter(l=>l.rarity===e.rarity&&1===l.is_active).length;if(0===t)return"-";const o=a.weight/l*(1/t)*100;return o<.01?"<0.01%":o<1?o.toFixed(2)+"%":o.toFixed(1)+"%"},P=e(!1),T=e([]),N=e(0),j=e(1),q=e(500),L=e(""),B=e(""),J=e(null),D=e([]),R=e(""),W=e(""),G=e(!1),H=e(!1),_e=e(!1),ye=e(null),be=e(!1),he=e(!1),ke=e([]),we=e([]),Ve=e([]),xe=e(""),Ce=e("all"),ze=e(""),Ue={all:null,banner:["banner","banner-en","banner-tw"],scene:["scene","scenes"],"ai-generated":["ai-generated"],horses:["horses"],icon:["icon","icons"],misc:["misc","feedback"]},$e=l({id:null,name:"",nameEn:"",image:"",rarity:"",promptText:""}),Ie=e(""),Se={name:[{required:!0,message:"请输入名称",trigger:"blur"}],rarity:[{required:!0,message:"请选择品级",trigger:"change"}]},Fe=a(()=>`draw-pool/${S.stepKey||"default"}`),Ee=async()=>{if(S.sceneId&&S.stepKey){P.value=!0;try{const e={page:j.value,pageSize:q.value};L.value&&(e.rarity=L.value);const l=await M.get(`/admin/scenes/${S.sceneId}/${Fe.value}`,{params:e});if(0===l.code&&(T.value=l.data.list||l.data||[],N.value=l.data.total||T.value.length,B.value)){const e=B.value.toLowerCase();T.value=T.value.filter(l=>{var a,t;return(null==(a=l.name)?void 0:a.toLowerCase().includes(e))||(null==(t=l.name_en)?void 0:t.toLowerCase().includes(e))})}}catch(e){console.error("加载列表失败:",e)}finally{P.value=!1}}},Ae=()=>{var e;_e.value=!1,Object.assign($e,{id:null,name:"",nameEn:"",image:"",rarity:(null==(e=F.value[0])?void 0:e.name)||"",promptText:""}),G.value=!0},Oe=async()=>{try{await ye.value.validate();const e={name:$e.name,nameEn:$e.nameEn,image:$e.image||null,rarity:$e.rarity,weight:100,promptText:$e.promptText||$e.name};_e.value?(await M.put(`/admin/scenes/${S.sceneId}/${Fe.value}/${$e.id}`,e),z.success("更新成功")):(await M.post(`/admin/scenes/${S.sceneId}/${Fe.value}`,e),z.success("添加成功")),G.value=!1,Ee()}catch(e){"cancel"!==e&&(console.error("保存失败:",e),z.error("保存失败"))}},Ke=e=>{D.value=e},Pe=()=>{var e;null==(e=J.value)||e.clearSelection(),D.value=[],R.value="",W.value=""},Te=e=>(j.value-1)*q.value+e+1,Ne=()=>{T.value.forEach(e=>{var l;null==(l=J.value)||l.toggleRowSelection(e,!0)})},je=()=>{var e;if(!W.value.trim())return void z.warning("请输入序号范围");null==(e=J.value)||e.clearSelection();const l=new Set,a=W.value.split(",");for(const s of a){const e=s.trim();if(e.includes("-")){const[a,t]=e.split("-").map(e=>parseInt(e.trim()));if(!isNaN(a)&&!isNaN(t))for(let e=a;e<=t;e++)l.add(e)}else{const a=parseInt(e);isNaN(a)||l.add(a)}}const t=(j.value-1)*q.value+1,o=t+T.value.length-1;let n=0;l.forEach(e=>{var l;if(e>=t&&e<=o){const a=e-t;T.value[a]&&(null==(l=J.value)||l.toggleRowSelection(T.value[a],!0),n++)}}),n>0?z.success(`已选择 ${n} 项`):z.warning("未找到匹配的序号，请检查范围是否在当前页内")},qe=async()=>{if(D.value.length&&R.value)try{const e=D.value.map(e=>e.id),l=F.value.find(e=>e.name===R.value),a=(null==l?void 0:l.weight)||100;await M.put(`/admin/scenes/${S.sceneId}/${Fe.value}/batch-rarity`,{ids:e,rarity:R.value,weight:a}),z.success(`已更新 ${e.length} 个词条的品级`),Pe(),Ee()}catch(e){console.error("批量设置品级失败:",e),z.error("批量设置品级失败")}},Le=()=>{Ie.value="",H.value=!0},Be=async()=>{if(!Ie.value.trim())return void z.warning("请输入要导入的数据");const e=Ie.value.trim().split("\n"),l=[],a=F.value.map(e=>e.name);for(const o of e){const e=o.split(",").map(e=>e.trim());if(e[0]){const t=e[2]||a[0]||"";if(!a.includes(t))return void z.warning(`品级"${t}"不存在，请先在品级管理中添加`);l.push({name:e[0],nameEn:e[1]||"",rarity:t,weight:100})}}if(0!==l.length)try{await M.post(`/admin/scenes/${S.sceneId}/${Fe.value}/batch`,{items:l}),z.success(`成功导入 ${l.length} 项`),H.value=!1,Ee()}catch(t){console.error("批量导入失败:",t),z.error("批量导入失败")}else z.warning("没有有效的数据")};async function Je(){ze.value=$e.image||"",be.value=!0,await De()}async function De(){he.value=!0;try{const e=await M.get("/photos/cos-images");200===e.code||0===e.code?(ke.value=e.data||[],Ve.value=e.folders||[],We()):z.warning("素材加载失败")}catch(e){console.error("加载COS图片失败:",e),z.error("加载图片列表失败")}finally{he.value=!1}}function Re(){We()}function We(){let e=ke.value;if("all"!==Ce.value){const l=Ue[Ce.value]||[];l.length>0&&(e=e.filter(e=>{const a=(e.folderPath||"").toLowerCase();return l.some(e=>a.includes(e.toLowerCase()))}))}if(xe.value){const l=xe.value.toLowerCase();e=e.filter(e=>{var a,t;return(null==(a=e.fileName)?void 0:a.toLowerCase().includes(l))||(null==(t=e.key)?void 0:t.toLowerCase().includes(l))})}we.value=e}function Me(){ze.value&&($e.image=ze.value,z.success("图片已选择")),be.value=!1}return t(()=>S.sceneId,e=>{e&&S.stepKey&&(E(),Ee())}),t(()=>S.stepKey,e=>{S.sceneId&&e&&(E(),Ee())}),o(()=>{S.sceneId&&S.stepKey&&(E(),Ee())}),I({reload:()=>{E(),Ee()}}),(e,l)=>{const a=n("el-option"),t=n("el-select"),o=n("el-input"),I=n("el-button"),E=n("el-table-column"),j=n("el-image"),q=n("el-tag"),ke=n("el-switch"),Ve=n("el-table"),Ue=n("el-form-item"),Ge=n("el-form"),He=n("el-dialog"),Ye=n("el-alert"),Qe=n("el-tab-pane"),Xe=n("el-tabs"),Ze=n("el-icon"),el=n("el-empty"),ll=s("loading");return d(),i("div",Y,[c("div",Q,[c("div",X,[u(t,{modelValue:L.value,"onUpdate:modelValue":l[0]||(l[0]=e=>L.value=e),placeholder:"品级筛选",clearable:"",size:"small",style:{width:"100px"},onChange:Ee},{default:p(()=>[u(a,{label:"全部",value:""}),(d(!0),i(m,null,v(F.value,e=>(d(),g(a,{key:e.id,label:e.name,value:e.grade_key},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),u(o,{modelValue:B.value,"onUpdate:modelValue":l[1]||(l[1]=e=>B.value=e),placeholder:"搜索",clearable:"",size:"small",style:{width:"120px"},onClear:Ee,onKeyup:f(Ee,["enter"])},null,8,["modelValue"]),u(I,{icon:_(y),size:"small",onClick:Ee},null,8,["icon"])]),c("div",Z,[u(I,{type:"primary",size:"small",icon:_(h),onClick:Ae,disabled:0===F.value.length},{default:p(()=>[...l[18]||(l[18]=[b("添加",-1)])]),_:1},8,["icon","disabled"]),u(I,{size:"small",icon:_(k),onClick:Le,disabled:0===F.value.length},{default:p(()=>[...l[19]||(l[19]=[b("批量导入",-1)])]),_:1},8,["icon","disabled"])])]),c("div",ee,[c("span",null,"共 "+w(N.value)+" 项",1),(d(!0),i(m,null,v(F.value,e=>{return d(),i("span",{key:e.id,class:"stat-item",style:V({background:e.color})},w(e.name)+": "+w((l=e.grade_key,T.value.filter(e=>e.rarity===l).length)),5);var l}),128))]),c("div",le,[c("div",ae,[l[23]||(l[23]=c("span",{class:"batch-label"},"快速选择:",-1)),u(o,{modelValue:W.value,"onUpdate:modelValue":l[2]||(l[2]=e=>W.value=e),placeholder:"序号范围，如 1-20 或 1,3,5,10-15",size:"small",style:{width:"200px"},onKeyup:f(je,["enter"])},null,8,["modelValue"]),u(I,{size:"small",onClick:je},{default:p(()=>[...l[20]||(l[20]=[b("选取",-1)])]),_:1}),u(I,{size:"small",onClick:Ne},{default:p(()=>[...l[21]||(l[21]=[b("全选",-1)])]),_:1}),D.value.length>0?(d(),g(I,{key:0,size:"small",onClick:Pe},{default:p(()=>[...l[22]||(l[22]=[b("清除",-1)])]),_:1})):x("",!0)]),D.value.length>0?(d(),i("div",te,[c("span",oe,"已选 "+w(D.value.length)+" 项",1),u(t,{modelValue:R.value,"onUpdate:modelValue":l[3]||(l[3]=e=>R.value=e),placeholder:"选择品级",size:"small",style:{width:"100px"}},{default:p(()=>[(d(!0),i(m,null,v(F.value,e=>(d(),g(a,{key:e.id,label:e.name,value:e.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),u(I,{type:"primary",size:"small",onClick:qe,disabled:!R.value},{default:p(()=>[...l[24]||(l[24]=[b("设置品级",-1)])]),_:1},8,["disabled"])])):x("",!0)]),r((d(),g(Ve,{ref_key:"tableRef",ref:J,data:T.value,stripe:"",size:"small","max-height":"500",onSelectionChange:Ke},{default:p(()=>[u(E,{type:"index",label:"#",width:"45",index:Te}),u(E,{type:"selection",width:"40"}),$.showImage?(d(),g(E,{key:0,prop:"image",label:"图",width:"50",align:"center"},{default:p(({row:e})=>[e.image?(d(),g(j,{key:0,src:e.image,style:{width:"30px",height:"30px"},fit:"cover","preview-src-list":[e.image]},null,8,["src","preview-src-list"])):(d(),i("span",ne,"-"))]),_:1})):x("",!0),u(E,{prop:"name",label:"名称",width:"100","show-overflow-tooltip":""}),u(E,{prop:"name_en",label:"英文","min-width":"140","show-overflow-tooltip":""}),u(E,{prop:"rarity",label:"品级",width:"100",align:"center"},{default:p(({row:e})=>[u(q,{size:"small",color:A(e.rarity),style:{color:"#fff",border:"none"}},{default:p(()=>[b(w(O(e.rarity)),1)]),_:2},1032,["color"])]),_:1}),u(E,{label:"概率",width:"60",align:"center"},{default:p(({row:e})=>[c("span",se,w(K(e)),1)]),_:1}),u(E,{prop:"is_active",label:"启用",width:"55",align:"center"},{default:p(({row:e})=>[u(ke,{modelValue:e.is_active,"onUpdate:modelValue":l=>e.is_active=l,"active-value":1,"inactive-value":0,onChange:l=>(async e=>{try{await M.put(`/admin/scenes/${S.sceneId}/${Fe.value}/${e.id}`,{isActive:e.is_active})}catch(l){console.error("更新失败:",l),z.error("更新失败"),e.is_active=1===e.is_active?0:1}})(e),size:"small"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),u(E,{label:"操作",width:"90",align:"center",fixed:"right"},{default:p(({row:e})=>[c("div",ie,[u(I,{type:"primary",link:"",size:"small",onClick:l=>(e=>{_e.value=!0,Object.assign($e,{id:e.id,name:e.name,nameEn:e.name_en,image:e.image||"",rarity:e.rarity||"",promptText:e.prompt_text||""}),G.value=!0})(e)},{default:p(()=>[...l[25]||(l[25]=[b("编辑",-1)])]),_:1},8,["onClick"]),u(I,{type:"danger",link:"",size:"small",onClick:l=>(async e=>{try{await U.confirm(`确定删除"${e.name}"吗？`,"确认删除",{type:"warning"}),await M.delete(`/admin/scenes/${S.sceneId}/${Fe.value}/${e.id}`),z.success("删除成功"),Ee()}catch(l){"cancel"!==l&&(console.error("删除失败:",l),z.error("删除失败"))}})(e)},{default:p(()=>[...l[26]||(l[26]=[b("删除",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])),[[ll,P.value]]),u(He,{modelValue:G.value,"onUpdate:modelValue":l[10]||(l[10]=e=>G.value=e),title:_e.value?"编辑词条":"添加词条",width:"450px"},{footer:p(()=>[u(I,{size:"small",onClick:l[9]||(l[9]=e=>G.value=!1)},{default:p(()=>[...l[29]||(l[29]=[b("取消",-1)])]),_:1}),u(I,{type:"primary",size:"small",onClick:Oe},{default:p(()=>[...l[30]||(l[30]=[b("保存",-1)])]),_:1})]),default:p(()=>[u(Ge,{model:$e,rules:Se,ref_key:"formRef",ref:ye,"label-width":"80px",size:"small"},{default:p(()=>[u(Ue,{label:"名称",prop:"name"},{default:p(()=>[u(o,{modelValue:$e.name,"onUpdate:modelValue":l[4]||(l[4]=e=>$e.name=e),placeholder:"如：马到成功"},null,8,["modelValue"])]),_:1}),u(Ue,{label:"英文"},{default:p(()=>[u(o,{modelValue:$e.nameEn,"onUpdate:modelValue":l[5]||(l[5]=e=>$e.nameEn=e),placeholder:"如：Instant Success"},null,8,["modelValue"])]),_:1}),$.showImage?(d(),g(Ue,{key:0,label:"图片"},{default:p(()=>[c("div",de,[$e.image?(d(),g(j,{key:0,src:$e.image,fit:"cover",style:{width:"80px",height:"80px","border-radius":"4px","margin-right":"10px"}},null,8,["src"])):x("",!0),c("div",ce,[u(I,{size:"small",onClick:Je},{default:p(()=>[...l[27]||(l[27]=[b("选择素材",-1)])]),_:1}),$e.image?(d(),g(I,{key:0,size:"small",type:"danger",onClick:l[6]||(l[6]=e=>$e.image="")},{default:p(()=>[...l[28]||(l[28]=[b("清除",-1)])]),_:1})):x("",!0)])])]),_:1})):x("",!0),u(Ue,{label:"品级",prop:"rarity"},{default:p(()=>[u(t,{modelValue:$e.rarity,"onUpdate:modelValue":l[7]||(l[7]=e=>$e.rarity=e),style:{width:"100%"}},{default:p(()=>[(d(!0),i(m,null,v(F.value,e=>(d(),g(a,{key:e.id,label:e.name,value:e.grade_key},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(Ue,{label:"Prompt"},{default:p(()=>[u(o,{modelValue:$e.promptText,"onUpdate:modelValue":l[8]||(l[8]=e=>$e.promptText=e),type:"textarea",rows:2,placeholder:"用于AI生成的文本描述（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),u(He,{modelValue:H.value,"onUpdate:modelValue":l[13]||(l[13]=e=>H.value=e),title:"批量导入词条",width:"500px"},{footer:p(()=>[u(I,{size:"small",onClick:l[12]||(l[12]=e=>H.value=!1)},{default:p(()=>[...l[32]||(l[32]=[b("取消",-1)])]),_:1}),u(I,{type:"primary",size:"small",onClick:Be},{default:p(()=>[...l[33]||(l[33]=[b("导入",-1)])]),_:1})]),default:p(()=>[u(Ye,{type:"info",closable:!1,style:{"margin-bottom":"15px"}},{title:p(()=>[...l[31]||(l[31]=[b(" 每行一项，格式：名称,英文,品级",-1),c("br",null,null,-1),b(" 品级必须是已定义的品级名称",-1),c("br",null,null,-1),b(" 示例：马到成功,Instant Success,rare ",-1)])]),_:1}),u(o,{modelValue:Ie.value,"onUpdate:modelValue":l[11]||(l[11]=e=>Ie.value=e),type:"textarea",rows:8,placeholder:"马到成功,Instant Success,rare\n龙马精神,Vigorous Spirit,epic\n万事如意,All the Best,common"},null,8,["modelValue"])]),_:1},8,["modelValue"]),u(He,{modelValue:be.value,"onUpdate:modelValue":l[17]||(l[17]=e=>be.value=e),title:"选择素材图片",width:"85%",style:{"max-width":"900px"}},{footer:p(()=>[u(I,{onClick:l[16]||(l[16]=e=>be.value=!1)},{default:p(()=>[...l[35]||(l[35]=[b("取消",-1)])]),_:1}),u(I,{type:"primary",onClick:Me,disabled:!ze.value},{default:p(()=>[...l[36]||(l[36]=[b("确定选择",-1)])]),_:1},8,["disabled"])]),default:p(()=>[c("div",re,[u(Xe,{modelValue:Ce.value,"onUpdate:modelValue":l[14]||(l[14]=e=>Ce.value=e),type:"card",onTabChange:Re},{default:p(()=>[u(Qe,{label:"全部",name:"all"}),u(Qe,{label:"Banner",name:"banner"}),u(Qe,{label:"场景素材",name:"scene"}),u(Qe,{label:"AI生成",name:"ai-generated"}),u(Qe,{label:"马匹素材",name:"horses"}),u(Qe,{label:"图标",name:"icon"}),u(Qe,{label:"其他",name:"misc"})]),_:1},8,["modelValue"]),c("div",ue,[u(o,{modelValue:xe.value,"onUpdate:modelValue":l[15]||(l[15]=e=>xe.value=e),placeholder:"搜索文件名...",clearable:"",style:{width:"200px"},onInput:We},{prefix:p(()=>[u(Ze,null,{default:p(()=>[u(_(y))]),_:1})]),_:1},8,["modelValue"]),u(I,{onClick:De,loading:he.value},{default:p(()=>[...l[34]||(l[34]=[b("刷新",-1)])]),_:1},8,["loading"]),we.value.length>0?(d(),i("span",pe,"共 "+w(we.value.length)+" 张",1)):x("",!0)]),r((d(),i("div",me,[(d(!0),i(m,null,v(we.value,e=>(d(),i("div",{key:e.key,class:C(["cos-image-item",{selected:ze.value===e.url}]),onClick:l=>function(e){ze.value=e.url}(e)},[u(j,{src:e.url,fit:"cover",lazy:""},null,8,["src"]),c("div",ge,[c("div",fe,w(e.fileName),1)])],10,ve))),128)),he.value||0!==we.value.length?x("",!0):(d(),g(el,{key:0,description:"暂无图片"}))])),[[ll,he.value]])])]),_:1},8,["modelValue"])])}}},ye=G(_e,[["__scopeId","data-v-b1485b6b"]]),be={class:"grade-style-editor"},he={class:"editor-layout"},ke={class:"config-panel"},we={class:"config-section"},Ve={class:"config-item"},xe={key:0,class:"config-item"},Ce={class:"config-item"},ze={class:"gradient-colors"},Ue={class:"config-item"},$e={class:"config-section"},Ie={class:"config-item"},Se={class:"config-item"},Fe={class:"config-item"},Ee={class:"config-item"},Ae={class:"config-section"},Oe={class:"config-item"},Ke={class:"config-item"},Pe={class:"config-item"},Te={class:"config-item"},Ne={class:"config-section"},je={class:"config-item"},qe={class:"config-item"},Le={class:"config-item"},Be={class:"config-item"},Je={class:"config-section"},De={class:"config-item"},Re={key:0,class:"config-item"},We={class:"config-section"},Me={class:"config-item"},Ge={class:"config-item"},He={class:"presets-section"},Ye={class:"presets-list"},Qe=["onClick"],Xe={class:"preview-panel"},Ze={class:"preview-container"},el={class:"preview-subtext"},ll={class:"editor-footer"},al=G({__name:"GradeStyleEditor",props:{grade:{type:Object,required:!0}},emits:["save","cancel"],setup(s,{emit:r}){const g=s,f=r,_=e("background"),y=e("马到成功"),h=l({card:{background:{type:"gradient",color:"#409eff",colors:["#FFD700","#FFA500"],direction:"135deg"},border:{width:"2rpx",style:"solid",color:"#B8860B",radius:"16rpx"},shadow:{x:"0",y:"8rpx",blur:"30rpx",color:"rgba(255, 215, 0, 0.3)"}},text:{primary:{color:"#C41E3A",fontSize:"56rpx",fontWeight:"bold",letterSpacing:"8rpx"}},badge:{background:{type:"solid",color:"#C41E3A"},textColor:"#FFD700"},animation:{type:"none",duration:"2s"}}),k=a({get:()=>parseInt(h.text.primary.fontSize)||56,set:e=>{h.text.primary.fontSize=e+"rpx"}}),z=a({get:()=>parseInt(h.text.primary.letterSpacing)||8,set:e=>{h.text.primary.letterSpacing=e+"rpx"}}),U=a({get:()=>parseInt(h.card.border.width)||2,set:e=>{h.card.border.width=e+"rpx"}}),$=a({get:()=>parseInt(h.card.border.radius)||16,set:e=>{h.card.border.radius=e+"rpx"}}),I=a({get:()=>parseInt(h.card.shadow.blur)||30,set:e=>{h.card.shadow.blur=e+"rpx"}}),S=a({get:()=>parseInt(h.card.shadow.y)||8,set:e=>{h.card.shadow.y=e+"rpx"}}),F=a({get:()=>"0rpx"!==h.card.shadow.blur,set:e=>{e?(h.card.shadow.blur="30rpx",h.card.shadow.y="8rpx"):(h.card.shadow.blur="0rpx",h.card.shadow.y="0rpx")}}),E=a({get:()=>h.badge.background.color||"#C41E3A",set:e=>{h.badge.background.color=e}}),A=a(()=>{const e={};"gradient"===h.card.background.type?e.background=`linear-gradient(${h.card.background.direction}, ${h.card.background.colors.join(", ")})`:e.background=h.card.background.color;const l=parseInt(h.card.border.width)||0;if(e.border=`${l}px ${h.card.border.style} ${h.card.border.color}`,e.borderRadius=(parseInt(h.card.border.radius)||0)+"px",F.value){const l=parseInt(h.card.shadow.y)||0,a=parseInt(h.card.shadow.blur)||0;e.boxShadow=`0 ${l}px ${a}px ${h.card.shadow.color}`}return e}),O=a(()=>({color:h.text.primary.color,fontSize:(parseInt(h.text.primary.fontSize)||56)/2+"px",fontWeight:h.text.primary.fontWeight,letterSpacing:(parseInt(h.text.primary.letterSpacing)||0)/2+"px"})),K=a(()=>({background:h.badge.background.color,color:h.badge.textColor})),P=a(()=>"none"===h.animation.type?"":`animation-${h.animation.type}`),T=[{name:"gold-red",label:"金底红字",config:{card:{background:{type:"gradient",colors:["#FFD700","#FFA500"],direction:"135deg"},border:{width:"4rpx",style:"solid",color:"#B8860B",radius:"16rpx"},shadow:{x:"0",y:"8rpx",blur:"40rpx",color:"rgba(255, 215, 0, 0.5)"}},text:{primary:{color:"#C41E3A",fontSize:"64rpx",fontWeight:"bold",letterSpacing:"12rpx"}},badge:{background:{type:"solid",color:"#C41E3A"},textColor:"#FFD700"},animation:{type:"shimmer",duration:"3s"}}},{name:"red-gold",label:"红底金字",config:{card:{background:{type:"gradient",colors:["#DC143C","#8B0000"],direction:"135deg"},border:{width:"3rpx",style:"solid",color:"#FFD700",radius:"16rpx"},shadow:{x:"0",y:"6rpx",blur:"30rpx",color:"rgba(220, 20, 60, 0.4)"}},text:{primary:{color:"#FFD700",fontSize:"56rpx",fontWeight:"bold",letterSpacing:"10rpx"}},badge:{background:{type:"solid",color:"#FFD700"},textColor:"#8B0000"},animation:{type:"pulse",duration:"2s"}}},{name:"light-red",label:"浅红白字",config:{card:{background:{type:"gradient",colors:["#FF6B6B","#EE5A5A"],direction:"135deg"},border:{width:"2rpx",style:"solid",color:"#FFFFFF",radius:"16rpx"},shadow:{x:"0",y:"4rpx",blur:"20rpx",color:"rgba(255, 107, 107, 0.3)"}},text:{primary:{color:"#FFFFFF",fontSize:"52rpx",fontWeight:"bold",letterSpacing:"8rpx"}},badge:{background:{type:"solid",color:"#FFFFFF"},textColor:"#FF6B6B"},animation:{type:"none",duration:"2s"}}},{name:"pink",label:"粉色调",config:{card:{background:{type:"gradient",colors:["#FFB6C1","#FF69B4"],direction:"135deg"},border:{width:"2rpx",style:"solid",color:"#FFFFFF",radius:"16rpx"},shadow:{x:"0",y:"4rpx",blur:"15rpx",color:"rgba(255, 182, 193, 0.3)"}},text:{primary:{color:"#8B0000",fontSize:"48rpx",fontWeight:"bold",letterSpacing:"6rpx"}},badge:{background:{type:"solid",color:"#8B0000"},textColor:"#FFB6C1"},animation:{type:"none",duration:"2s"}}},{name:"dark",label:"灰黑色",config:{card:{background:{type:"gradient",colors:["#4A4A4A","#2C2C2C"],direction:"135deg"},border:{width:"2rpx",style:"solid",color:"#666666",radius:"16rpx"},shadow:{x:"0",y:"4rpx",blur:"15rpx",color:"rgba(0, 0, 0, 0.3)"}},text:{primary:{color:"#AAAAAA",fontSize:"48rpx",fontWeight:"normal",letterSpacing:"6rpx"}},badge:{background:{type:"solid",color:"#666666"},textColor:"#CCCCCC"},animation:{type:"none",duration:"2s"}}}],N=e=>{const l=e.config.card.background;return"gradient"===l.type?{background:`linear-gradient(${l.direction}, ${l.colors.join(", ")})`}:{background:l.color}},j=()=>{L()},q=()=>{f("save",JSON.parse(JSON.stringify(h)))},L=()=>{const e=g.grade.styleConfig||g.grade.style_config;if(e){const l="string"==typeof e?JSON.parse(e):e;l.card&&Object.assign(h.card,l.card),l.text&&Object.assign(h.text,l.text),l.badge&&Object.assign(h.badge,l.badge),l.animation&&Object.assign(h.animation,l.animation)}else h.card.background.colors[0]=g.grade.color||"#409eff",h.card.background.colors[1]=g.grade.color||"#409eff"};return o(()=>{L()}),t(()=>g.grade,()=>{L()},{deep:!0}),(e,l)=>{const a=n("el-radio-button"),t=n("el-radio-group"),o=n("el-color-picker"),r=n("el-option"),g=n("el-select"),f=n("el-tab-pane"),L=n("el-slider"),B=n("el-switch"),J=n("el-tabs"),D=n("el-button");return d(),i("div",be,[c("div",he,[c("div",ke,[u(J,{modelValue:_.value,"onUpdate:modelValue":l[21]||(l[21]=e=>_.value=e)},{default:p(()=>[u(f,{label:"背景",name:"background"},{default:p(()=>[c("div",we,[c("div",Ve,[l[25]||(l[25]=c("span",{class:"config-label"},"背景类型",-1)),u(t,{modelValue:h.card.background.type,"onUpdate:modelValue":l[0]||(l[0]=e=>h.card.background.type=e),size:"small"},{default:p(()=>[u(a,{label:"solid"},{default:p(()=>[...l[23]||(l[23]=[b("纯色",-1)])]),_:1}),u(a,{label:"gradient"},{default:p(()=>[...l[24]||(l[24]=[b("渐变",-1)])]),_:1})]),_:1},8,["modelValue"])]),"solid"===h.card.background.type?(d(),i("div",xe,[l[26]||(l[26]=c("span",{class:"config-label"},"背景颜色",-1)),u(o,{modelValue:h.card.background.color,"onUpdate:modelValue":l[1]||(l[1]=e=>h.card.background.color=e),"show-alpha":""},null,8,["modelValue"])])):(d(),i(m,{key:1},[c("div",Ce,[l[28]||(l[28]=c("span",{class:"config-label"},"渐变颜色",-1)),c("div",ze,[u(o,{modelValue:h.card.background.colors[0],"onUpdate:modelValue":l[2]||(l[2]=e=>h.card.background.colors[0]=e),"show-alpha":""},null,8,["modelValue"]),l[27]||(l[27]=c("span",{class:"arrow"},"→",-1)),u(o,{modelValue:h.card.background.colors[1],"onUpdate:modelValue":l[3]||(l[3]=e=>h.card.background.colors[1]=e),"show-alpha":""},null,8,["modelValue"])])]),c("div",Ue,[l[29]||(l[29]=c("span",{class:"config-label"},"渐变方向",-1)),u(g,{modelValue:h.card.background.direction,"onUpdate:modelValue":l[4]||(l[4]=e=>h.card.background.direction=e),size:"small",style:{width:"120px"}},{default:p(()=>[u(r,{label:"↘ 135°",value:"135deg"}),u(r,{label:"→ 90°",value:"90deg"}),u(r,{label:"↓ 180°",value:"180deg"}),u(r,{label:"↗ 45°",value:"45deg"}),u(r,{label:"← 270°",value:"270deg"})]),_:1},8,["modelValue"])])],64))])]),_:1}),u(f,{label:"文字",name:"text"},{default:p(()=>[c("div",$e,[c("div",Ie,[l[30]||(l[30]=c("span",{class:"config-label"},"文字颜色",-1)),u(o,{modelValue:h.text.primary.color,"onUpdate:modelValue":l[5]||(l[5]=e=>h.text.primary.color=e)},null,8,["modelValue"])]),c("div",Se,[l[31]||(l[31]=c("span",{class:"config-label"},"字号",-1)),u(L,{modelValue:k.value,"onUpdate:modelValue":l[6]||(l[6]=e=>k.value=e),min:24,max:80,step:2,"show-input":"",size:"small"},null,8,["modelValue"])]),c("div",Fe,[l[32]||(l[32]=c("span",{class:"config-label"},"字重",-1)),u(g,{modelValue:h.text.primary.fontWeight,"onUpdate:modelValue":l[7]||(l[7]=e=>h.text.primary.fontWeight=e),size:"small",style:{width:"120px"}},{default:p(()=>[u(r,{label:"正常",value:"normal"}),u(r,{label:"中等",value:"500"}),u(r,{label:"粗体",value:"bold"}),u(r,{label:"特粗",value:"800"})]),_:1},8,["modelValue"])]),c("div",Ee,[l[33]||(l[33]=c("span",{class:"config-label"},"字间距",-1)),u(L,{modelValue:z.value,"onUpdate:modelValue":l[8]||(l[8]=e=>z.value=e),min:0,max:20,step:1,"show-input":"",size:"small"},null,8,["modelValue"])])])]),_:1}),u(f,{label:"边框",name:"border"},{default:p(()=>[c("div",Ae,[c("div",Oe,[l[34]||(l[34]=c("span",{class:"config-label"},"边框宽度",-1)),u(L,{modelValue:U.value,"onUpdate:modelValue":l[9]||(l[9]=e=>U.value=e),min:0,max:10,step:1,"show-input":"",size:"small"},null,8,["modelValue"])]),c("div",Ke,[l[35]||(l[35]=c("span",{class:"config-label"},"边框颜色",-1)),u(o,{modelValue:h.card.border.color,"onUpdate:modelValue":l[10]||(l[10]=e=>h.card.border.color=e),"show-alpha":""},null,8,["modelValue"])]),c("div",Pe,[l[36]||(l[36]=c("span",{class:"config-label"},"边框样式",-1)),u(g,{modelValue:h.card.border.style,"onUpdate:modelValue":l[11]||(l[11]=e=>h.card.border.style=e),size:"small",style:{width:"120px"}},{default:p(()=>[u(r,{label:"实线",value:"solid"}),u(r,{label:"虚线",value:"dashed"}),u(r,{label:"点线",value:"dotted"}),u(r,{label:"双线",value:"double"})]),_:1},8,["modelValue"])]),c("div",Te,[l[37]||(l[37]=c("span",{class:"config-label"},"圆角",-1)),u(L,{modelValue:$.value,"onUpdate:modelValue":l[12]||(l[12]=e=>$.value=e),min:0,max:30,step:2,"show-input":"",size:"small"},null,8,["modelValue"])])])]),_:1}),u(f,{label:"阴影",name:"shadow"},{default:p(()=>[c("div",Ne,[c("div",je,[l[38]||(l[38]=c("span",{class:"config-label"},"启用阴影",-1)),u(B,{modelValue:F.value,"onUpdate:modelValue":l[13]||(l[13]=e=>F.value=e)},null,8,["modelValue"])]),F.value?(d(),i(m,{key:0},[c("div",qe,[l[39]||(l[39]=c("span",{class:"config-label"},"阴影颜色",-1)),u(o,{modelValue:h.card.shadow.color,"onUpdate:modelValue":l[14]||(l[14]=e=>h.card.shadow.color=e),"show-alpha":""},null,8,["modelValue"])]),c("div",Le,[l[40]||(l[40]=c("span",{class:"config-label"},"模糊半径",-1)),u(L,{modelValue:I.value,"onUpdate:modelValue":l[15]||(l[15]=e=>I.value=e),min:0,max:50,step:2,"show-input":"",size:"small"},null,8,["modelValue"])]),c("div",Be,[l[41]||(l[41]=c("span",{class:"config-label"},"Y偏移",-1)),u(L,{modelValue:S.value,"onUpdate:modelValue":l[16]||(l[16]=e=>S.value=e),min:0,max:20,step:1,"show-input":"",size:"small"},null,8,["modelValue"])])],64)):x("",!0)])]),_:1}),u(f,{label:"动画",name:"animation"},{default:p(()=>[c("div",Je,[c("div",De,[l[42]||(l[42]=c("span",{class:"config-label"},"动画效果",-1)),u(g,{modelValue:h.animation.type,"onUpdate:modelValue":l[17]||(l[17]=e=>h.animation.type=e),size:"small",style:{width:"150px"}},{default:p(()=>[u(r,{label:"无",value:"none"}),u(r,{label:"闪烁",value:"shimmer"}),u(r,{label:"发光",value:"glow"}),u(r,{label:"脉冲",value:"pulse"})]),_:1},8,["modelValue"])]),"none"!==h.animation.type?(d(),i("div",Re,[l[43]||(l[43]=c("span",{class:"config-label"},"动画时长",-1)),u(g,{modelValue:h.animation.duration,"onUpdate:modelValue":l[18]||(l[18]=e=>h.animation.duration=e),size:"small",style:{width:"120px"}},{default:p(()=>[u(r,{label:"快速 (1s)",value:"1s"}),u(r,{label:"正常 (2s)",value:"2s"}),u(r,{label:"慢速 (3s)",value:"3s"})]),_:1},8,["modelValue"])])):x("",!0)])]),_:1}),u(f,{label:"徽章",name:"badge"},{default:p(()=>[c("div",We,[c("div",Me,[l[44]||(l[44]=c("span",{class:"config-label"},"徽章背景",-1)),u(o,{modelValue:E.value,"onUpdate:modelValue":l[19]||(l[19]=e=>E.value=e)},null,8,["modelValue"])]),c("div",Ge,[l[45]||(l[45]=c("span",{class:"config-label"},"徽章文字",-1)),u(o,{modelValue:h.badge.textColor,"onUpdate:modelValue":l[20]||(l[20]=e=>h.badge.textColor=e)},null,8,["modelValue"])])])]),_:1})]),_:1},8,["modelValue"]),c("div",He,[l[46]||(l[46]=c("div",{class:"presets-header"},"快速预设",-1)),c("div",Ye,[(d(),i(m,null,v(T,e=>c("div",{key:e.name,class:"preset-item",style:V(N(e)),onClick:l=>(e=>{Object.assign(h.card,JSON.parse(JSON.stringify(e.config.card))),Object.assign(h.text,JSON.parse(JSON.stringify(e.config.text))),Object.assign(h.badge,JSON.parse(JSON.stringify(e.config.badge))),Object.assign(h.animation,JSON.parse(JSON.stringify(e.config.animation)))})(e)},w(e.label),13,Qe)),64))])])]),c("div",Xe,[l[47]||(l[47]=c("div",{class:"preview-header"},"实时预览",-1)),c("div",Ze,[c("div",{class:C(["preview-card",P.value]),style:V(A.value)},[c("div",{class:"preview-badge",style:V(K.value)},w(s.grade.name),5),c("div",{class:"preview-text",style:V(O.value)},w(y.value),5),c("div",el,w(s.grade.name_en||"English Name"),1)],6)]),l[48]||(l[48]=c("div",{class:"preview-tip"}," 预览效果仅供参考，实际效果以小程序端为准 ",-1))])]),c("div",ll,[u(D,{onClick:l[22]||(l[22]=l=>e.$emit("cancel"))},{default:p(()=>[...l[49]||(l[49]=[b("取消",-1)])]),_:1}),u(D,{onClick:j},{default:p(()=>[...l[50]||(l[50]=[b("重置",-1)])]),_:1}),u(D,{type:"primary",onClick:q},{default:p(()=>[...l[51]||(l[51]=[b("保存样式",-1)])]),_:1})])])}}},[["__scopeId","data-v-3e39388b"]]),tl={class:"grade-scheme-manager"},ol={class:"scheme-selector"},nl={class:"selector-header"},sl={key:0,class:"scheme-detail"},il={class:"scheme-header"},dl={class:"scheme-info"},cl={class:"scheme-name"},rl={class:"scheme-actions"},ul={class:"grades-section"},pl={class:"section-header"},ml={key:0,class:"grades-list"},vl={class:"drag-handle"},gl={class:"preview-text"},fl={class:"grade-info"},_l={class:"grade-name"},yl={class:"grade-meta"},bl={class:"grade-actions"},hl={key:1,class:"grades-empty"},kl={key:1,class:"no-scheme-tip"},wl={class:"input-with-translate"},Vl={class:"input-with-translate"},xl=G({__name:"GradeSchemeManager",props:{sceneId:{type:String,required:!0},stepKey:{type:String,required:!0}},emits:["change"],setup(a,{expose:s,emit:r}){const f=a,y=r,k=e([]),C=e(null),A=e(null),O=e([]),K=e(!1),P=e(!1),T=e(null),N=l({id:null,schemeKey:"",name:"",nameEn:"",description:"",category:"general"}),j={schemeKey:[{required:!0,message:"请输入方案标识",trigger:"blur"}],name:[{required:!0,message:"请输入方案名称",trigger:"blur"}]},q=async()=>{try{const e=await M.get("/admin/grade-schemes");0===e.code&&(k.value=e.data.list||[])}catch(e){console.error("加载方案列表失败:",e)}},L=async()=>{if(f.sceneId&&f.stepKey)try{const e=await M.get(`/admin/grade-schemes/mapping/${f.sceneId}/${f.stepKey}`);0===e.code&&e.data?(C.value=e.data.scheme_id,A.value=e.data,O.value=e.data.grades||[]):(C.value=null,A.value=null,O.value=[])}catch(e){console.error("加载方案映射失败:",e)}},B=async e=>{if(e)try{await M.put(`/admin/grade-schemes/mapping/${f.sceneId}/${f.stepKey}`,{schemeId:e}),z.success("方案已绑定"),await J(e),y("change",e)}catch(l){console.error("绑定方案失败:",l),z.error("绑定失败")}else try{await M.delete(`/admin/grade-schemes/mapping/${f.sceneId}/${f.stepKey}`),A.value=null,O.value=[],y("change",null)}catch(l){console.error("移除映射失败:",l)}},J=async e=>{try{const l=await M.get(`/admin/grade-schemes/${e}`);0===l.code&&(A.value=l.data,O.value=l.data.grades||[])}catch(l){console.error("加载方案详情失败:",l)}},D=()=>{P.value=!1,Object.assign(N,{id:null,schemeKey:"",name:"",nameEn:"",description:"",category:"general"}),K.value=!0},R=()=>{A.value&&(P.value=!0,Object.assign(N,{id:A.value.id,schemeKey:A.value.scheme_key,name:A.value.name,nameEn:A.value.name_en||"",description:A.value.description||"",category:A.value.category||"general"}),K.value=!0)},G=async()=>{var e;try{if(await T.value.validate(),P.value)await M.put(`/admin/grade-schemes/${N.id}`,{name:N.name,nameEn:N.nameEn,description:N.description,category:N.category}),z.success("更新成功"),await J(N.id);else{const l=await M.post("/admin/grade-schemes",{schemeKey:N.schemeKey,name:N.name,nameEn:N.nameEn,description:N.description,category:N.category});z.success("创建成功"),await q(),(null==(e=l.data)?void 0:e.id)&&(C.value=l.data.id,await B(l.data.id))}K.value=!1}catch(l){"cancel"!==l&&(console.error("保存方案失败:",l),z.error("保存失败"))}},Y=async()=>{var e,l;if(A.value)try{await U.confirm(`确定删除方案"${A.value.name}"吗？删除后无法恢复。`,"确认删除",{type:"warning"}),await M.delete(`/admin/grade-schemes/${A.value.id}`),z.success("删除成功"),C.value=null,A.value=null,O.value=[],await q()}catch(a){"cancel"!==a&&(console.error("删除方案失败:",a),z.error((null==(l=null==(e=a.response)?void 0:e.data)?void 0:l.msg)||"删除失败"))}},Q=e(!1),X=e(!1),Z=e(null),ee=l({id:null,gradeKey:"",name:"",nameEn:"",weight:100,promptText:"",color:"#409eff"}),le={name:[{required:!0,message:"请输入品级名称",trigger:"blur"}],weight:[{required:!0,message:"请输入权重",trigger:"blur"}]},ae=()=>{X.value=!1,Object.assign(ee,{id:null,gradeKey:"",name:"",nameEn:"",weight:100,promptText:"",color:"#409eff"}),Q.value=!0},te=e(!1),oe=async()=>{if(ee.name){te.value=!0;try{const e=await H(ee.name);ee.nameEn=e,z.success("翻译成功")}catch(e){z.error("翻译失败")}finally{te.value=!1}}else z.warning("请先输入品级名称")},ne=e(!1),se=async()=>{if(N.name){ne.value=!0;try{const e=await H(N.name);N.nameEn=e,z.success("翻译成功")}catch(e){z.error("翻译失败")}finally{ne.value=!1}}else z.warning("请先输入方案名称")},ie=async()=>{if(A.value)try{await Z.value.validate();const e={gradeKey:ee.gradeKey||void 0,name:ee.name,nameEn:ee.nameEn,weight:ee.weight,promptText:ee.promptText,color:ee.color};X.value?(await M.put(`/admin/grade-schemes/${A.value.id}/grades/${ee.id}`,e),z.success("更新成功")):(await M.post(`/admin/grade-schemes/${A.value.id}/grades`,e),z.success("添加成功")),Q.value=!1,await J(A.value.id)}catch(e){"cancel"!==e&&(console.error("保存品级失败:",e),z.error("保存失败"))}},de=async()=>{if(A.value)try{const e=O.value.map(e=>e.id);await M.put(`/admin/grade-schemes/${A.value.id}/grades/reorder`,{gradeIds:e})}catch(e){console.error("更新排序失败:",e)}},ce=e=>{const l=O.value.reduce((e,l)=>e+(l.weight||0),0);if(0===l)return"-";const a=e.weight/l*100;return a<1?a.toFixed(2)+"%":a.toFixed(1)+"%"},re=e(!1),ue=e(null),pe=async e=>{if(A.value&&ue.value)try{await M.put(`/admin/grade-schemes/${A.value.id}/grades/${ue.value.id}`,{styleConfig:e}),z.success("样式已保存"),re.value=!1,await J(A.value.id)}catch(l){console.error("保存样式失败:",l),z.error("保存失败")}},me=e=>({borderLeftColor:e.color||"#409eff"}),ve=e=>{var l,a,t,o;const n=e.styleConfig||e.style_config;if(!n)return{background:e.color||"#409eff",color:"#fff"};const s="string"==typeof n?JSON.parse(n):n,i={};if(null==(l=s.card)?void 0:l.background){const e=s.card.background;"gradient"===e.type&&e.colors?i.background=`linear-gradient(${e.direction||"135deg"}, ${e.colors.join(", ")})`:e.color&&(i.background=e.color)}else i.background=e.color||"#409eff";if((null==(t=null==(a=s.text)?void 0:a.primary)?void 0:t.color)?i.color=s.text.primary.color:i.color="#fff",null==(o=s.card)?void 0:o.border){const e=s.card.border;i.border=`${e.width||"2px"} ${e.style||"solid"} ${e.color||"transparent"}`,i.borderRadius=e.radius||"8px"}return i};return t(()=>[f.sceneId,f.stepKey],()=>{f.sceneId&&f.stepKey&&(q(),L())},{immediate:!0}),o(()=>{q(),f.sceneId&&f.stepKey&&L()}),s({reload:()=>{q(),L()}}),(e,l)=>{const a=n("el-option"),t=n("el-select"),o=n("el-button"),s=n("el-tag"),r=n("el-icon"),f=n("el-empty"),y=n("el-input"),q=n("el-form-item"),L=n("el-tooltip"),H=n("el-form"),ge=n("el-dialog"),fe=n("el-input-number"),_e=n("el-color-picker");return d(),i("div",tl,[c("div",ol,[c("div",nl,[l[19]||(l[19]=c("span",{class:"label"},"品级方案",-1)),u(t,{modelValue:C.value,"onUpdate:modelValue":l[0]||(l[0]=e=>C.value=e),placeholder:"选择品级方案",size:"small",style:{width:"200px"},onChange:B},{default:p(()=>[u(a,{label:"不使用品级方案",value:null}),(d(!0),i(m,null,v(k.value,e=>(d(),g(a,{key:e.id,label:`${e.name} (${e.gradeCount||0}个品级)`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),u(o,{type:"primary",size:"small",icon:_(h),onClick:D},{default:p(()=>[...l[18]||(l[18]=[b(" 新建方案 ",-1)])]),_:1},8,["icon"])])]),A.value?(d(),i("div",sl,[c("div",il,[c("div",dl,[c("span",cl,w(A.value.name),1),u(s,{size:"small",type:"info"},{default:p(()=>[b(w(A.value.category),1)]),_:1})]),c("div",rl,[u(o,{size:"small",onClick:R},{default:p(()=>[...l[20]||(l[20]=[b("编辑方案",-1)])]),_:1}),u(o,{size:"small",type:"danger",onClick:Y,disabled:A.value.is_system},{default:p(()=>[...l[21]||(l[21]=[b("删除",-1)])]),_:1},8,["disabled"])])]),c("div",ul,[c("div",pl,[l[23]||(l[23]=c("span",null,"品级列表",-1)),u(o,{type:"primary",size:"small",icon:_(h),onClick:ae},{default:p(()=>[...l[22]||(l[22]=[b("添加品级",-1)])]),_:1},8,["icon"])]),O.value.length>0?(d(),i("div",ml,[u(_(W),{modelValue:O.value,"onUpdate:modelValue":l[1]||(l[1]=e=>O.value=e),"item-key":"id",handle:".drag-handle",onEnd:de},{item:p(({element:e})=>[c("div",{class:"grade-item",style:V(me(e))},[c("div",vl,[u(r,null,{default:p(()=>[u(_($))]),_:1})]),c("div",{class:"grade-preview",style:V(ve(e))},[c("span",gl,w(e.name),1)],4),c("div",fl,[c("div",_l,w(e.name),1),c("div",yl,[c("span",null,"权重: "+w(e.weight),1),c("span",null,"概率: "+w(ce(e)),1)])]),c("div",bl,[u(o,{type:"primary",link:"",size:"small",onClick:l=>(e=>{X.value=!0,Object.assign(ee,{id:e.id,gradeKey:e.grade_key,name:e.name,nameEn:e.name_en||"",weight:e.weight,promptText:e.prompt_text||"",color:e.color||"#409eff"}),Q.value=!0})(e)},{default:p(()=>[u(r,null,{default:p(()=>[u(_(I))]),_:1})]),_:1},8,["onClick"]),u(o,{type:"primary",link:"",size:"small",onClick:l=>(e=>{ue.value={...e},re.value=!0})(e)},{default:p(()=>[u(r,null,{default:p(()=>[u(_(S))]),_:1})]),_:1},8,["onClick"]),u(o,{type:"danger",link:"",size:"small",onClick:l=>(async e=>{if(A.value)try{await U.confirm(`确定删除品级"${e.name}"吗？`,"确认删除",{type:"warning"}),await M.delete(`/admin/grade-schemes/${A.value.id}/grades/${e.id}`),z.success("删除成功"),await J(A.value.id)}catch(l){"cancel"!==l&&(console.error("删除品级失败:",l),z.error("删除失败"))}})(e)},{default:p(()=>[u(r,null,{default:p(()=>[u(_(F))]),_:1})]),_:1},8,["onClick"])])],4)]),_:1},8,["modelValue"])])):(d(),i("div",hl,[u(f,{description:"暂无品级，请添加","image-size":60})]))])])):(d(),i("div",kl,[u(f,{description:"请选择或创建品级方案","image-size":80},{default:p(()=>[u(o,{type:"primary",onClick:D},{default:p(()=>[...l[24]||(l[24]=[b("创建品级方案",-1)])]),_:1})]),_:1})])),u(ge,{modelValue:K.value,"onUpdate:modelValue":l[8]||(l[8]=e=>K.value=e),title:P.value?"编辑品级方案":"创建品级方案",width:"450px"},{footer:p(()=>[u(o,{onClick:l[7]||(l[7]=e=>K.value=!1)},{default:p(()=>[...l[26]||(l[26]=[b("取消",-1)])]),_:1}),u(o,{type:"primary",onClick:G},{default:p(()=>[...l[27]||(l[27]=[b("保存",-1)])]),_:1})]),default:p(()=>[u(H,{model:N,rules:j,ref_key:"schemeFormRef",ref:T,"label-width":"80px"},{default:p(()=>[P.value?x("",!0):(d(),g(q,{key:0,label:"方案标识",prop:"schemeKey"},{default:p(()=>[u(y,{modelValue:N.schemeKey,"onUpdate:modelValue":l[2]||(l[2]=e=>N.schemeKey=e),placeholder:"如: couplet_fortune"},null,8,["modelValue"]),l[25]||(l[25]=c("div",{class:"form-tip"},"唯一标识，创建后不可修改",-1))]),_:1})),u(q,{label:"方案名称",prop:"name"},{default:p(()=>[u(y,{modelValue:N.name,"onUpdate:modelValue":l[3]||(l[3]=e=>N.name=e),placeholder:"如: 对联品级方案"},null,8,["modelValue"])]),_:1}),u(q,{label:"英文名称"},{default:p(()=>[c("div",wl,[u(y,{modelValue:N.nameEn,"onUpdate:modelValue":l[4]||(l[4]=e=>N.nameEn=e),placeholder:"如: Couplet Fortune Scheme"},null,8,["modelValue"]),u(L,{content:"翻译为英文",placement:"top"},{default:p(()=>[u(o,{type:"primary",link:"",onClick:se,loading:ne.value},{default:p(()=>[u(r,null,{default:p(()=>[u(_(E))]),_:1})]),_:1},8,["loading"])]),_:1})])]),_:1}),u(q,{label:"分类"},{default:p(()=>[u(t,{modelValue:N.category,"onUpdate:modelValue":l[5]||(l[5]=e=>N.category=e),style:{width:"100%"}},{default:p(()=>[u(a,{label:"通用",value:"general"}),u(a,{label:"对联/题词",value:"couplet"}),u(a,{label:"坐骑",value:"mount"})]),_:1},8,["modelValue"])]),_:1}),u(q,{label:"描述"},{default:p(()=>[u(y,{modelValue:N.description,"onUpdate:modelValue":l[6]||(l[6]=e=>N.description=e),type:"textarea",rows:2,placeholder:"方案描述（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),u(ge,{modelValue:Q.value,"onUpdate:modelValue":l[15]||(l[15]=e=>Q.value=e),title:X.value?"编辑品级":"添加品级",width:"500px"},{footer:p(()=>[u(o,{onClick:l[14]||(l[14]=e=>Q.value=!1)},{default:p(()=>[...l[29]||(l[29]=[b("取消",-1)])]),_:1}),u(o,{type:"primary",onClick:ie},{default:p(()=>[...l[30]||(l[30]=[b("保存",-1)])]),_:1})]),default:p(()=>[u(H,{model:ee,rules:le,ref_key:"gradeFormRef",ref:Z,"label-width":"80px"},{default:p(()=>[u(q,{label:"品级名称",prop:"name"},{default:p(()=>[u(y,{modelValue:ee.name,"onUpdate:modelValue":l[9]||(l[9]=e=>ee.name=e),placeholder:"如: 大吉、上上签、传说"},null,8,["modelValue"])]),_:1}),u(q,{label:"英文名称"},{default:p(()=>[c("div",Vl,[u(y,{modelValue:ee.nameEn,"onUpdate:modelValue":l[10]||(l[10]=e=>ee.nameEn=e),placeholder:"如: Great Fortune"},null,8,["modelValue"]),u(L,{content:"翻译为英文",placement:"top"},{default:p(()=>[u(o,{type:"primary",link:"",onClick:oe,loading:te.value},{default:p(()=>[u(r,null,{default:p(()=>[u(_(E))]),_:1})]),_:1},8,["loading"])]),_:1})])]),_:1}),u(q,{label:"权重",prop:"weight"},{default:p(()=>[u(fe,{modelValue:ee.weight,"onUpdate:modelValue":l[11]||(l[11]=e=>ee.weight=e),min:1,max:1e4,style:{width:"100%"}},null,8,["modelValue"]),l[28]||(l[28]=c("div",{class:"form-tip"},"权重越高，抽中该品级的概率越大",-1))]),_:1}),u(q,{label:"AI Prompt"},{default:p(()=>[u(y,{modelValue:ee.promptText,"onUpdate:modelValue":l[12]||(l[12]=e=>ee.promptText=e),type:"textarea",rows:3,placeholder:"用于AI生成时的风格提示，如: 极其华丽喜庆的风格，金光闪闪"},null,8,["modelValue"])]),_:1}),u(q,{label:"主题色"},{default:p(()=>[u(_e,{modelValue:ee.color,"onUpdate:modelValue":l[13]||(l[13]=e=>ee.color=e)},null,8,["modelValue"]),c("span",{class:"color-preview",style:V({background:ee.color})},w(ee.color),5)]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),u(ge,{modelValue:re.value,"onUpdate:modelValue":l[17]||(l[17]=e=>re.value=e),title:"样式配置",width:"800px",class:"style-editor-dialog"},{default:p(()=>[ue.value?(d(),g(al,{key:0,grade:ue.value,onSave:pe,onCancel:l[16]||(l[16]=e=>re.value=!1)},null,8,["grade"])):x("",!0)]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-04abe1d6"]]),Cl={class:"prompt-template-editor"},zl={class:"editor-layout"},Ul={class:"editor-left"},$l={class:"section-header"},Il={class:"variable-section"},Sl={key:0,class:"variable-buttons"},Fl=["textContent"],El={class:"editor-right"},Al={key:0,class:"preview-selectors"},Ol={class:"selector-label"},Kl={class:"preview-result"},Pl=G({__name:"PromptTemplateEditor",props:{modelValue:{type:Object,default:()=>({name:"",template:"",negative_prompt:"",segments:null,model_config:null})},sceneSteps:{type:Array,default:()=>[]},sceneId:{type:String,default:""}},emits:["update:modelValue"],setup(l,{emit:s}){const r=l,f=s,_=e(null),y=e(""),h=e({}),k=e({});function V(e){return"dice"===e.component_type||"random_dice"===e.component_type}t(()=>r.sceneSteps,()=>{!async function(){if(r.sceneId)for(const l of r.sceneSteps)if(V(l)&&l.step_key)try{const e=await M.get(`/admin/scenes/${r.sceneId}/draw-pool/${l.step_key}`,{params:{pageSize:200}});0===e.code&&(k.value[l.step_key]=e.data.list||[])}catch(e){console.error("加载词条池失败:",e)}}()},{immediate:!0}),a(()=>r.sceneSteps.filter(e=>e.options&&e.options.length>0));const U=a(()=>{if(!y.value)return[{text:"(暂无内容，请在左侧输入 Prompt 模板)",type:"empty"}];const e=[],l=/(\{\{(\w+)\}\})/g;let a,t=0;for(;null!==(a=l.exec(y.value));){a.index>t&&e.push({text:y.value.slice(t,a.index),type:"text"});const o=a[2],n=h.value[o];n?e.push({text:n,type:"replaced",varKey:o}):e.push({text:a[1],type:"variable",varKey:o}),t=l.lastIndex}return t<y.value.length&&e.push({text:y.value.slice(t),type:"text"}),e.length>0?e:[{text:"(暂无内容)",type:"empty"}]});function $(e){return"upload"===e.step_key||"image_upload"===e.component_type}function I(e){return{gender:"如：男士/女士",phrase:"如：马到成功",horse:"如：金色骏马",upload:"用户照片"}[e.step_key]||"输入测试值"}function S(e){if(!e.options||0===e.options.length)return[];if(e.gender_based){const l=r.sceneSteps.find(e=>"gender_select"===e.component_type),a=l?h.value[l.step_key]:null;if(a){const l={"男士":"male","女士":"female",male:"male",female:"female"}[a];if(l)return e.options.filter(e=>e.gender===l)}}return e.options}function F(e){return{"part-text":"text"===e.type,"part-variable":"variable"===e.type,"part-replaced":"replaced"===e.type,"part-empty":"empty"===e.type}}function E(){y.value?(navigator.clipboard.writeText(y.value),z.success("已复制到剪贴板")):z.warning("暂无内容可复制")}function O(){r.modelValue&&(y.value=r.modelValue.template_content||r.modelValue.template||"")}let K=!1;return t(y,()=>{K||f("update:modelValue",{...r.modelValue,template:y.value})}),t(()=>r.modelValue,(e,l)=>{((null==e?void 0:e.template_content)||(null==e?void 0:e.template)||"")!==((null==l?void 0:l.template_content)||(null==l?void 0:l.template)||"")&&(K=!0,O(),setTimeout(()=>{K=!1},0))},{deep:!0}),t(()=>{const e=r.sceneSteps.find(e=>"gender_select"===e.component_type);return e?h.value[e.step_key]:null},(e,l)=>{e!==l&&r.sceneSteps.forEach(e=>{e.gender_based&&e.step_key&&(h.value[e.step_key]="")})}),o(()=>{O()}),(e,a)=>{const t=n("el-button"),o=n("el-input"),s=n("el-tag"),r=n("el-option"),f=n("el-select");return d(),i("div",Cl,[c("div",zl,[c("div",Ul,[c("div",$l,[a[2]||(a[2]=c("span",{class:"section-title"},"Prompt 模板",-1)),u(t,{size:"small",onClick:E},{default:p(()=>[...a[1]||(a[1]=[b("复制",-1)])]),_:1})]),u(o,{ref_key:"textareaRef",ref:_,modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=e=>y.value=e),type:"textarea",rows:16,placeholder:"输入 Prompt 模板，点击下方变量按钮插入步骤参数..."},null,8,["modelValue"]),c("div",Il,[a[3]||(a[3]=c("span",{class:"section-label"},"插入变量:",-1)),l.sceneSteps.length>0?(d(),i("div",Sl,[(d(!0),i(m,null,v(l.sceneSteps,e=>(d(),g(t,{key:e.step_key,size:"small",class:"var-btn",onClick:l=>function(e){var l;const a=null==(l=_.value)?void 0:l.textarea;if(a){const l=a.selectionStart,t=a.selectionEnd,o=`{{${e}}}`;y.value=y.value.slice(0,l)+o+y.value.slice(t),A(()=>{a.focus(),a.setSelectionRange(l+o.length,l+o.length)})}else y.value+=`{{${e}}}`}(e.step_key)},{default:p(()=>{return[c("span",{textContent:w((l=e.step_key,"{{"+l+"}}"))},null,8,Fl)];var l}),_:2},1032,["onClick"]))),128))])):x("",!0)])]),c("div",El,[a[5]||(a[5]=c("div",{class:"section-header"},[c("span",{class:"section-title"},"实时预览")],-1)),l.sceneSteps.length>0?(d(),i("div",Al,[(d(!0),i(m,null,v(l.sceneSteps,e=>(d(),i("div",{key:e.step_key,class:"selector-item"},[c("span",Ol,w(e.title||e.step_key)+":",1),$(e)?(d(),g(s,{key:0,size:"small",type:"info"},{default:p(()=>[...a[4]||(a[4]=[b("用户照片",-1)])]),_:1})):"gender_select"===e.component_type?(d(),g(f,{key:1,modelValue:h.value[e.step_key],"onUpdate:modelValue":l=>h.value[e.step_key]=l,size:"small",placeholder:"选择",clearable:"",style:{width:"120px"}},{default:p(()=>[u(r,{label:"男士",value:"男士"}),u(r,{label:"女士",value:"女士"})]),_:1},8,["modelValue","onUpdate:modelValue"])):e.options&&e.options.length>0?(d(),g(f,{key:2,modelValue:h.value[e.step_key],"onUpdate:modelValue":l=>h.value[e.step_key]=l,size:"small",placeholder:"选择",clearable:"",style:{width:"160px"}},{default:p(()=>[(d(!0),i(m,null,v(S(e),e=>(d(),g(r,{key:e.id||e.option_key,label:e.label,value:e.prompt_text||e.label},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):V(e)&&k.value[e.step_key]?(d(),g(f,{key:3,modelValue:h.value[e.step_key],"onUpdate:modelValue":l=>h.value[e.step_key]=l,size:"small",placeholder:"选择",clearable:"",filterable:"",style:{width:"160px"}},{default:p(()=>[(d(!0),i(m,null,v(k.value[e.step_key],e=>(d(),g(r,{key:e.id,label:e.name,value:e.prompt_text||e.name},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(d(),g(o,{key:4,modelValue:h.value[e.step_key],"onUpdate:modelValue":l=>h.value[e.step_key]=l,size:"small",placeholder:I(e),style:{width:"160px"}},null,8,["modelValue","onUpdate:modelValue","placeholder"]))]))),128))])):x("",!0),c("div",Kl,[(d(!0),i(m,null,v(U.value,(e,l)=>(d(),i("span",{key:l,class:C(F(e))},w(e.text),3))),128))])])])])}}},[["__scopeId","data-v-f52e5fe1"]]),Tl={class:"scene-management"},Nl={class:"page-header"},jl={class:"header-right"},ql={class:"status-tabs"},Ll={class:"scene-count"},Bl={class:"scene-list"},Jl={class:"scene-info"},Dl={class:"image-placeholder"},Rl={class:"scene-detail"},Wl={class:"scene-name"},Ml={class:"scene-desc"},Gl={class:"scene-key"},Hl={class:"status-switch"},Yl=["onClick"],Ql=["onClick"],Xl=["onClick"],Zl={class:"points-value"},ea={class:"action-btns-row"},la={class:"input-with-translate"},aa={class:"input-with-translate"},ta={class:"icon-upload-inline"},oa={key:1,class:"icon-placeholder-inline"},na={class:"icon-upload-actions"},sa={class:"steps-config-3col"},ia={class:"steps-sidebar"},da=["onClick"],ca={class:"step-order"},ra={class:"step-info-compact"},ua={class:"step-title-compact"},pa={key:0,class:"step-basic-config"},ma={class:"step-icon-selector"},va=["src"],ga={key:1,class:"step-icon-empty"},fa={class:"input-with-translate-compact"},_a={key:0,class:"dice-pricing-config"},ya={class:"switch-row"},ba={key:1,class:"step-basic-empty"},ha={key:2,class:"step-options-config"},ka={key:0,class:"no-options-tip"},wa={key:1,class:"no-options-tip"},Va={key:2,class:"random-dice-config-standalone"},xa={class:"dice-config-header"},Ca={class:"grade-scheme-section"},za={key:0,class:"grade-scheme-selector"},Ua={class:"grade-scheme-row"},$a={key:0,class:"grade-preview"},Ia={class:"dice-pool-manager"},Sa={class:"config-section-title"},Fa={class:"config-title-actions"},Ea={key:0,class:"options-filter-compact"},Aa={class:"options-count"},Oa={key:1,class:"spec-tip-compact"},Ka={class:"options-scroll-area"},Pa={class:"image-tag-left"},Ta=["onClick"],Na={key:1,class:"option-thumb-empty"},ja={class:"image-tag-right"},qa={class:"image-tag-row1"},La={class:"image-tag-field"},Ba={class:"image-tag-field"},Ja={class:"field-with-btn"},Da={key:0,class:"image-tag-field"},Ra={class:"image-tag-field"},Wa={class:"image-tag-field"},Ma={class:"image-tag-row2"},Ga={class:"tags-col tags-col-label-main"},Ha={class:"tags-col tags-col-label"},Ya={class:"field-with-btn-inline"},Qa={class:"tags-col tags-col-prompt"},Xa={class:"tags-col tags-col-default"},Za={class:"tags-col tags-col-action"},et={class:"spec-col spec-col-label-main"},lt={class:"spec-col spec-col-label"},at={class:"field-with-btn-inline"},tt={class:"spec-col spec-col-size"},ot={class:"spec-col spec-col-size"},nt={class:"spec-col spec-col-default"},st={class:"spec-col spec-col-action"},it={class:"common-table-header"},dt={key:0,class:"common-col common-col-extra"},ct={key:1,class:"common-col common-col-extra"},rt={class:"common-col common-col-label-main"},ut={class:"common-col common-col-label"},pt={class:"field-with-btn-inline"},mt={class:"common-col common-col-extra"},vt={class:"common-col common-col-prompt"},gt={class:"common-col common-col-default"},ft={class:"common-col common-col-action"},_t={key:3,class:"step-options-empty"},yt={class:"cos-picker"},bt={class:"cos-picker-header"},ht={key:0,class:"cos-filter-tags"},kt={class:"filter-result"},wt={class:"cos-image-grid"},Vt=["onClick"],xt={class:"cos-image-info"},Ct={class:"cos-image-name"},zt={class:"cos-image-tags"},Ut={class:"step-icon-picker"},$t={class:"step-icon-grid"},It=["onClick"],St=["src","alt"],Ft={class:"step-icon-name"},Et={class:"scene-icon-picker"},At={class:"scene-icon-picker-header"},Ot={key:0,class:"scene-icon-count"},Kt={class:"scene-icon-grid"},Pt=["onClick"],Tt={class:"scene-icon-info"},Nt={class:"scene-icon-name"},jt={class:"scene-icon-tags"},qt={class:"ai-sidebar-content"},Lt={class:"ai-mode-switch"},Bt={key:0,class:"ai-current-scene"},Jt={key:1,class:"ai-image-generator"},Dt={class:"image-gen-disabled-notice"},Rt={class:"quick-actions",style:{"margin-top":"16px"}},Wt={key:0,class:"current-scene-info",style:{"margin-top":"16px"}},Mt={key:0,class:"ai-welcome"},Gt={key:0},Ht={key:1},Yt={class:"ai-suggestions"},Qt={class:"message-avatar"},Xt={key:0},Zt={key:1},eo={class:"message-content"},lo=["innerHTML"],ao={key:0,class:"ai-config-preview"},to={class:"config-preview-header"},oo={class:"config-preview-info"},no={key:0,class:"preview-icon"},so=["src"],io={key:1,class:"image-tasks-pending"},co={class:"tasks-header"},ro={class:"tasks-list"},uo={class:"tasks-confirm"},po={key:2,class:"generating-images-progress"},mo={class:"progress-header"},vo={class:"progress-tasks"},go={class:"config-preview-actions"},fo={key:1,class:"ai-message assistant"},_o={class:"ai-input-area"},yo={class:"ai-input-actions"},bo={key:0,class:"ai-config-detail"},ho=["src"],ko={key:1,class:"no-icon-hint"},wo={class:"preview-step-header"},Vo={class:"step-num"},xo={class:"step-name"},Co={key:0,class:"preview-step-options"},zo={class:"option-grid"},Uo=["src","alt"],$o={key:1,class:"option-no-image"},Io={class:"option-label"},So={class:"preview-prompt"},Fo={key:0,class:"prompt-label"},Eo={key:1},Ao=G({__name:"Scenes",setup(t){const y=e(!1),$=e(!1);e(!1),e(!1);const I=e([]),S=e(!1),F=e(!1),G=e(null),Y=e(null),Q=e([]),X=e(-1),Z=e("all"),ee=e("basic"),le=e(!1),ae=e(!1),te=e([]),oe=e([]),ne=e([]),se=e(""),ie=e(""),de=e(""),ce=e(""),re=e(-1),ue=e(!1),pe=e(!1),me=e([]),ve=e(""),ge=e(""),fe=e(!1),_e=e(!1),be=e([]),he=e([]),ke=e(""),we=e(""),Ve=e(""),xe=e([]),Ce=e([]),ze=e(!1),Ue=a(()=>{var e,l;return(null==(l=null==(e=qe.value)?void 0:e.config)?void 0:l.gradeSchemeId)?Ce.value.find(e=>e.id===qe.value.config.gradeSchemeId):null});function $e(){var e;Te.id&&(null==(e=qe.value)?void 0:e.step_key)?ze.value=!0:z.warning("请先保存场景")}function Ie(){Se()}async function Se(){try{const l=(await M.get("/admin/grade-schemes")).data.list||[];for(const a of l)try{const e=await M.get(`/admin/grade-schemes/${a.id}`);0===e.code&&e.data&&(a.grades=e.data.grades||[])}catch(e){a.grades=[]}Ce.value=l}catch(l){console.error("加载品级方案失败:",l)}}function Fe(e){qe.value&&(qe.value.config||(qe.value.config={}),qe.value.config.gradeSchemeId=e)}const Ee=a(()=>{if(!ve.value)return me.value;const e=ve.value.toLowerCase();return me.value.filter(l=>l.fileName.toLowerCase().includes(e))});function Ae(){let e=be.value;if(we.value&&(e=e.filter(e=>e.folderPath===we.value)),ke.value){const l=ke.value.toLowerCase();e=e.filter(e=>{var a,t,o;return(null==(a=e.fileName)?void 0:a.toLowerCase().includes(l))||(null==(t=e.key)?void 0:t.toLowerCase().includes(l))||(null==(o=e.folderPath)?void 0:o.toLowerCase().includes(l))})}xe.value=e}const Oe=a(()=>({Authorization:`Bearer ${localStorage.getItem("admin_token")}`})),Ke=l({id:null,name:"",template:"",negative_prompt:"",segments:null,model_config:null,is_active:!0}),Pe=e({name:"",template:"",negative_prompt:"",segments:null,model_config:null}),Te=l({id:"",name:"",name_en:"",description:"",description_en:"",icon:"",status:"active",is_review_safe:!0,points_cost:50,sort_order:0}),Ne={id:[{required:!0,message:"请输入场景ID",trigger:"blur"}],name:[{required:!0,message:"请输入场景名称",trigger:"blur"}]},je=a(()=>"all"===Z.value?I.value:I.value.filter(e=>e.status===Z.value)),qe=a(()=>X.value>=0?Q.value[X.value]:null),Le=e(""),Be=a(()=>qe.value&&qe.value.options?Le.value?qe.value.options.filter(e=>e.gender===Le.value):qe.value.options:[]);a(()=>Q.value.map(e=>e.step_key).filter(e=>e&&"upload"!==e));const Je={image_upload:"图片上传",gender_select:"性别选择",radio:"单选框",tags:"标签选择",spec_select:"规格选择",color_picker:"颜色选择",image_tags:"图片标签",slider:"滑块",random_dice:"摇骰子"};function De(){}async function Re(){y.value=!0;try{const e=await M.get("/config/admin/scenes");I.value=(e.data||[]).map(e=>({...e,points_cost:e.points_cost||e.price||50})),setTimeout(()=>{const e=document.querySelector(".scene-list .el-table__body-wrapper tbody");e&&new R(e,{handle:".drag-handle",animation:150,onEnd:async e=>{const{oldIndex:l,newIndex:a}=e;if(l!==a){const e=I.value.splice(l,1)[0];I.value.splice(a,0,e),await async function(){const e=I.value.map((e,l)=>({id:e.id,sort_order:l}));try{await M.post("/config/admin/scenes/sort",{scenes:e}),z.success("排序已更新")}catch{z.error("排序更新失败")}}()}}})},100)}catch(e){console.error("加载场景失败:",e),z.error("加载场景列表失败")}finally{y.value=!1}}function We(){F.value=!1,Object.assign(Te,{id:"",name:"",name_en:"",description:"",description_en:"",icon:"",status:"active",is_review_safe:!0,points_cost:50,sort_order:I.value.length}),S.value=!0}function Me(e){var l;200===e.code&&(null==(l=e.data)?void 0:l.url)?(Te.icon=e.data.url,z.success("图标上传成功")):z.error(e.message||"上传失败")}function Ge(){z.error("图标上传失败")}function He(e){const l=e.type.startsWith("image/"),a=e.size/1024<500;return l?!!a||(z.error("图片大小不能超过 500KB!"),!1):(z.error("只能上传图片文件!"),!1)}async function Ye(){try{await G.value.validate()}catch{return}$.value=!0;try{const e={...Te,scene_key:Te.id,price:Te.points_cost,is_review_safe:Te.is_review_safe?1:0,use_dynamic_render:1};if(F.value&&(e.id=Te.id),await M.post("/config/admin/scene",e),F.value&&(Q.value.length>0||Ke.template)){const e=Q.value.map(e=>({...e,icon:e.icon||"",gender_based:e.gender_based||!1,config:e.config||{}}));Pe.value&&(Ke.name=Pe.value.name||Ke.name,Ke.template=Pe.value.template||"",Ke.negative_prompt=Pe.value.negative_prompt||"",Ke.segments=Pe.value.segments||null,Ke.model_config=Pe.value.model_config||null);const l=Ke.template?{...Ke,scene_id:Te.id}:null,a={steps:e,prompt:l},t=JSON.stringify(a);console.log("[保存调试] 总体积:",(t.length/1024).toFixed(2),"KB"),console.log("[保存调试] 步骤数:",e.length),console.log("[保存调试] promptFormData:",JSON.stringify(Pe.value)),console.log("[保存调试] promptForm.template:",Ke.template),console.log("[保存调试] promptData:",l?JSON.stringify(l).substring(0,200):"null"),e.forEach((e,l)=>{console.log(`[保存调试] 步骤${l+1} "${e.title}": icon="${e.icon}", gender_based=${e.gender_based}`)}),await M.post(`/config/admin/scene/${Te.id}/batch-save`,a)}z.success("保存成功"),S.value=!1,Re()}catch(e){z.error("保存失败: "+(e.message||"未知错误"))}finally{$.value=!1}}async function Qe(e){try{const l={...e,price:e.points_cost||e.price,use_dynamic_render:1};await M.post("/config/admin/scene",l),z.success("更新成功")}catch(l){z.error("更新失败"),Re()}}async function Xe(e,l){if(e.status===l)return;const a=e.status;e.status=l;try{const t=await M.post("/config/admin/scene/status",{id:e.id,status:l});200===t.code||0===t.code?z.success("状态更新成功"):(e.status=a,z.error(t.message||"状态更新失败"))}catch(t){e.status=a,z.error(t.message||"状态更新失败")}}function Ze(){const e={id:null,step_order:Q.value.length+1,step_key:"",title:"新步骤",title_en:"",icon:"",component_type:"radio",is_required:!1,is_visible:!0,gender_based:!1,free_count:1,cost_per_roll:10,config:{},options:[]};Q.value.push(e),X.value=Q.value.length-1}function el(){if(!qe.value)return;const e={option_key:`opt_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,4)}`,label:"",label_en:"",color:"",image:"",prompt_text:"",is_default:0===qe.value.options.length?1:0};"spec_select"===qe.value.component_type&&(e.width=25,e.height=35),qe.value.options.push(e)}function ll(e){const l=qe.value.options,a=l[e],t=1===a.is_default,o=a.gender;if(l.splice(e,1),t&&l.length>0)if(qe.value.gender_based&&o){const e=l.filter(e=>e.gender===o);e.length>0&&!e.some(e=>1===e.is_default)&&(e[0].is_default=1)}else l.some(e=>1===e.is_default)||(l[0].is_default=1)}function al(e){qe.value&&(qe.value.gender_based&&e.gender?qe.value.options.forEach(l=>{l.gender===e.gender&&(l.is_default=0)}):qe.value.options.forEach(e=>{e.is_default=0}),e.is_default=1)}function tl(e){if(!qe.value)return!1;if(1!==e.is_default)return!1;if(qe.value.gender_based&&e.gender){return qe.value.options.filter(l=>l.gender===e.gender).filter(e=>1===e.is_default).length<=1}return qe.value.options.filter(e=>1===e.is_default).length<=1}function ol(){Q.value.forEach((e,l)=>{e.step_order=l+1})}const nl=e(null);async function sl(){ae.value=!0;try{const e=await M.get("/photos/cos-images");200===e.code||0===e.code?(te.value=e.data||[],ne.value=e.folders||[],il()):(console.warn("photos/cos-images返回非200:",e),z.warning("素材加载失败，请检查COS配置"))}catch(e){console.error("加载COS图片失败:",e),z.error("加载图片列表失败: "+(e.message||"网络错误"))}finally{ae.value=!1}}function il(){var e;let l=te.value;if(de.value&&(null==(e=qe.value)?void 0:e.gender_based)&&(l=l.filter(e=>{const l=(e.folderPath||"").toLowerCase(),a=(e.category||"").toLowerCase();return l.includes(de.value)||a===de.value})),ie.value&&(l=l.filter(e=>e.folderPath===ie.value)),se.value){const e=se.value.toLowerCase();l=l.filter(l=>{var a,t;return(null==(a=l.fileName)?void 0:a.toLowerCase().includes(e))||(null==(t=l.key)?void 0:t.toLowerCase().includes(e))})}oe.value=l}function dl(){ce.value&&(nl.value?(nl.value.image=ce.value,z.success("图片已选择")):re.value>=0&&(qe.value.options[re.value].image=ce.value,z.success("图片已选择"))),le.value=!1,nl.value=null}async function cl(){var e;ge.value=(null==(e=qe.value)?void 0:e.icon)||"",ue.value=!0,0===me.value.length&&await async function(){var e;pe.value=!0;try{const l=await M.get("/assets/list");200!==l.code&&0!==l.code||(me.value=(null==(e=l.data)?void 0:e.uiIcons)||[])}catch(l){console.error("加载图标失败:",l),z.error("加载图标列表失败")}finally{pe.value=!1}}()}function rl(){ge.value&&qe.value&&(qe.value.icon=ge.value,z.success("图标已选择")),ue.value=!1}async function ul(){Ve.value=Te.icon||"",we.value="",ke.value="",fe.value=!0,0===be.value.length?await pl():Ae()}async function pl(){_e.value=!0;try{const e=await M.get("/photos/cos-images");200!==e.code&&0!==e.code||(be.value=e.data||[],he.value=e.folders||[],Ae())}catch(e){console.error("加载场景图标失败:",e),z.error("加载图标列表失败")}finally{_e.value=!1}}function ml(){Ve.value&&(Te.icon=Ve.value,z.success("图标已选择")),fe.value=!1}const vl=l({name:!1,desc:!1,step:!1,options:!1});async function gl(){if(Te.name){vl.name=!0;try{Te.name_en=await H(Te.name),z.success("翻译成功")}catch(e){z.error("翻译失败")}finally{vl.name=!1}}else z.warning("请先输入中文名称")}async function fl(){if(Te.description){vl.desc=!0;try{Te.description_en=await H(Te.description),z.success("翻译成功")}catch(e){z.error("翻译失败")}finally{vl.desc=!1}}else z.warning("请先输入中文描述")}async function _l(){if(qe.value)if(qe.value.title){vl.step=!0;try{qe.value.title_en=await H(qe.value.title),z.success("翻译成功")}catch(e){z.error("翻译失败")}finally{vl.step=!1}}else z.warning("请先输入中文标题")}async function yl(){if(!qe.value||!qe.value.options||0===qe.value.options.length)return void z.warning("当前步骤没有选项");const e=qe.value.options.filter(e=>e.label&&!e.label_en).map(e=>e.label);if(0!==e.length){vl.options=!0;try{const l=await async function(e){if(!e||0===e.length)return[];try{const l=await M.post("/translate/batch",{texts:e,target:"en"});return 0===l.code&&l.data?l.data:(console.warn("批量翻译失败:",l.message),e.map(e=>({original:e,translated:e})))}catch(l){return console.error("批量翻译API调用失败:",l),e.map(e=>({original:e,translated:e}))}}(e);let a=0;qe.value.options.forEach(e=>{var t;e.label&&!e.label_en&&(e.label_en=(null==(t=l[a])?void 0:t.translated)||e.label,a++)}),z.success(`已翻译 ${l.length} 个选项`)}catch(l){z.error("批量翻译失败")}finally{vl.options=!1}}else z.warning("没有需要翻译的选项")}async function bl(e){if(e.label)try{e.label_en=await H(e.label),z.success("翻译成功")}catch(l){z.error("翻译失败")}else z.warning("请先输入中文名称")}const hl=e(!1),kl=e("create"),wl=e(""),Vl=e(!1),Cl=e([]),zl=e(null),Ul=e(!1),$l=e(null);function Il(){hl.value=!hl.value,hl.value&&(console.log("%c🤖 AI场景生成助手已更新","color: #67C23A; font-size: 16px; font-weight: bold;"),console.log("%c版本: v2.3.0 (2026-01-20 12:22:00)","color: #409EFF; font-size: 14px;"),console.log("%c✨ 新功能:","color: #E6A23C; font-size: 14px; font-weight: bold;"),console.log("  • 禁用AI图片生成功能（绿幕抠图效果不理想）"),console.log("  • 改为使用占位图，请通过素材管理上传图片"),console.log("  • 新增「素材管理」→「场景素材」TAB"),console.log("  • 在场景配置中点击图片区域从素材库选择"),console.log("%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━","color: #909399;"))}function Sl(e){wl.value=e}function Fl(){A(()=>{zl.value&&(zl.value.scrollTop=zl.value.scrollHeight)})}function El(){window.location.href="/admin/#/assets"}async function Al(e){var l,a;const t=Cl.value[e];if(t&&t.generatedConfig){t.imageTasksPending=!1,t.generatingImages=!0,t.imageProgress={current:0,total:t.imageTasks.length};try{const e=await async function(e,l,a){var t,o;try{const l=JSON.parse(JSON.stringify(e)),s=5;let i=0;if(null==(t=l.scene)?void 0:t.icon_description){a(i,"processing");try{const e=await M.post("/ai-agent/generate-icon",{description:l.scene.icon_description,type:"scene",scene_id:l.scene.scene_key,auto_upload:!0});200===e.code&&(null==(o=e.data)?void 0:o.url)?(l.scene.icon=e.data.url,a(i,"completed")):a(i,"failed")}catch(n){console.error("生成场景图标失败:",n),a(i,"failed")}i++}const d=[];if(l.steps&&Array.isArray(l.steps))for(const e of l.steps)if("image_upload"!==e.component_type&&e.options&&Array.isArray(e.options))for(const l of e.options)l.image_description&&d.push({step:e,opt:l,taskIndex:i++,description:l.image_description,step_key:e.step_key,option_key:l.option_key});const c=async e=>{var t,o;a(e.taskIndex,"processing");try{const n=await M.post("/ai-agent/generate-icon",{description:e.description,type:"step",scene_id:null==(t=l.scene)?void 0:t.scene_key,step_key:e.step_key,option_key:e.option_key,auto_upload:!0});return 200===n.code&&(null==(o=n.data)?void 0:o.url)?(e.opt.image=n.data.url,a(e.taskIndex,"completed"),{success:!0}):(a(e.taskIndex,"failed"),{success:!1})}catch(n){return console.error(`生成选项 ${e.option_key} 示意图失败:`,n),a(e.taskIndex,"failed"),{success:!1}}};for(let e=0;e<d.length;e+=s){const l=d.slice(e,e+s);console.log(`[并发生成] 批次 ${Math.floor(e/s)+1}/${Math.ceil(d.length/s)}, 任务数: ${l.length}`),await Promise.all(l.map(e=>c(e))),e+s<d.length&&await new Promise(e=>setTimeout(e,200))}return l}catch(s){throw console.error("生成配置图片失败:",s),s}}(t.generatedConfig,t.imageTasks,(e,l)=>{t.imageTasks[e].status=l,"completed"===l&&t.imageProgress.current++});t.generatedConfig=e,t.generatingImages=!1,t.content="create"===kl.value?`已为您生成「${(null==(l=e.scene)?void 0:l.name)||"新场景"}」的完整配置，包含 ${(null==(a=e.steps)?void 0:a.length)||0} 个步骤。所有图片已生成完成，点击下方按钮可预览详情或直接应用。`:"已根据您的要求修改了场景配置。所有图片已生成完成，点击下方按钮查看修改结果。",z.success("图片生成完成")}catch(o){console.error("图片生成失败:",o),t.generatingImages=!1,z.error("图片生成失败: "+(o.message||"未知错误"))}Fl()}}async function Ol(){var e,l;const a=wl.value.trim();if(a&&!Vl.value){Cl.value.push({role:"user",content:a}),wl.value="",Vl.value=!0,Fl();try{let t;if("create"===kl.value)t=await M.post("/ai-agent/generate-scene",{description:a,reference_scene:null});else{if(!Y.value)throw new Error("请先选择要修改的场景");const e={scene:{scene_key:Y.value.id,name:Y.value.name,name_en:Y.value.name_en,description:Y.value.description,description_en:Y.value.description_en,points_cost:Y.value.points_cost||Y.value.price,status:Y.value.status},steps:Q.value.map(e=>{var l;return{step_key:e.step_key,title:e.title,title_en:e.title_en,component_type:e.component_type,is_required:e.is_required,is_visible:e.is_visible,gender_based:e.gender_based,options:null==(l=e.options)?void 0:l.map(e=>({option_key:e.option_key,label:e.label,label_en:e.label_en,color:e.color,image:e.image,prompt_text:e.prompt_text,is_default:e.is_default}))}}),prompt_template:{name:Ke.name,template:Ke.template,negative_prompt:Ke.negative_prompt}};t=await M.post("/ai-agent/modify-scene",{current_config:e,instruction:a})}if(200===t.code){const a=t.data,o=[];Cl.value.push({role:"assistant",content:"create"===kl.value?`已为您生成「${(null==(e=a.scene)?void 0:e.name)||"新场景"}」的完整配置，包含 ${(null==(l=a.steps)?void 0:l.length)||0} 个步骤。检测到需要生成 ${o.length} 张图片，请确认是否继续。`:`已根据您的要求修改了场景配置。检测到需要生成 ${o.length} 张图片，请确认是否继续。`,generatedConfig:a,imageTasks:o,imageTasksPending:!0,generatingImages:!1}),Fl()}else Cl.value.push({role:"assistant",content:`抱歉，生成失败：${t.message||"未知错误"}。请重试或换个描述方式。`})}catch(t){console.error("AI 请求失败:",t),Cl.value.push({role:"assistant",content:`请求失败：${t.message||"网络错误"}。请检查网络连接后重试。`})}finally{Vl.value=!1,Fl()}}}async function Kl(e){var l,a;if(e)try{if(await U.confirm("create"===kl.value?"确定要创建此场景吗？将自动保存场景基本信息、步骤和Prompt模板。":"确定要应用这些修改吗？这将覆盖当前场景的配置。","确认应用",{type:"info"}),"create"===kl.value){const a={scene_key:e.scene.scene_key,name:e.scene.name,name_en:e.scene.name_en||"",description:e.scene.description,description_en:e.scene.description_en||"",icon:e.scene.icon||"",status:"inactive",is_review_safe:e.scene.is_review_safe?1:0,points_cost:e.scene.points_cost||50,price:e.scene.points_cost||50,use_dynamic_render:1},t=await M.post("/config/admin/scene",a);if(200!==t.code&&0!==t.code)throw new Error(t.message||"创建场景失败");const o=(null==(l=e.steps)?void 0:l.map((e,l)=>{var a;return{step_key:e.step_key,title:e.title,title_en:e.title_en||"",component_type:e.component_type,step_order:l+1,is_required:!1!==e.is_required,is_visible:!1!==e.is_visible,gender_based:e.gender_based||!1,free_count:void 0!==e.free_count?e.free_count:1,cost_per_roll:void 0!==e.cost_per_roll?e.cost_per_roll:10,icon:"",config:{},options:(null==(a=e.options)?void 0:a.map((e,l)=>({option_key:e.option_key||`opt_${Date.now().toString(36)}_${l}`,label:e.label,label_en:e.label_en||"",color:e.color||"",image:e.image||"",prompt_text:e.prompt_text||e.label,sort_order:l+1,is_visible:!0,is_default:e.is_default||0===l?1:0,gender:e.gender||null})))||[]}}))||[],n=e.prompt_template?{name:e.prompt_template.name||`${e.scene.name}模板`,template:e.prompt_template.template||"",negative_prompt:e.prompt_template.negative_prompt||""}:null;await M.post(`/config/admin/scene/${e.scene.scene_key}/batch-save`,{steps:o,prompt:n}),z.success("场景创建成功！"),hl.value=!1,Re()}else{if(!Y.value)return;Object.assign(Te,{name:e.scene.name,name_en:e.scene.name_en,description:e.scene.description,description_en:e.scene.description_en,points_cost:e.scene.points_cost,icon:e.scene.icon||Te.icon}),Q.value=(null==(a=e.steps)?void 0:a.map((e,l)=>{var a;return{id:null,step_key:e.step_key,title:e.title,title_en:e.title_en||"",component_type:e.component_type,step_order:l+1,is_required:!1!==e.is_required,is_visible:!1!==e.is_visible,gender_based:e.gender_based||!1,free_count:void 0!==e.free_count?e.free_count:1,cost_per_roll:void 0!==e.cost_per_roll?e.cost_per_roll:10,icon:"",config:{},options:(null==(a=e.options)?void 0:a.map((e,l)=>({option_key:e.option_key||`opt_${Date.now().toString(36)}_${l}`,label:e.label,label_en:e.label_en||"",color:e.color||"",image:e.image||"",prompt_text:e.prompt_text||e.label,sort_order:l+1,is_visible:1,is_default:e.is_default||0===l?1:0,gender:e.gender||null})))||[]}}))||[],e.prompt_template&&(Ke.name=e.prompt_template.name||Ke.name,Ke.template=e.prompt_template.template||"",Ke.negative_prompt=e.prompt_template.negative_prompt||""),X.value=Q.value.length>0?0:-1,z.success("配置已应用，请检查后保存"),hl.value=!1}}catch(t){"cancel"!==t&&z.error("应用配置失败: "+(t.message||"未知错误"))}}return e(!1),e(null),l({description:"",type:"scene"}),e(""),e(!1),o(()=>{Re(),Se()}),(e,l)=>{const a=n("el-button"),t=n("el-alert"),o=n("el-icon"),I=n("el-radio-button"),A=n("el-radio-group"),R=n("el-table-column"),H=n("el-image"),me=n("el-switch"),be=n("el-table"),Se=n("el-input"),Ao=n("el-form-item"),Oo=n("el-tooltip"),Ko=n("el-upload"),Po=n("el-option"),To=n("el-select"),No=n("el-col"),jo=n("el-input-number"),qo=n("el-row"),Lo=n("el-form"),Bo=n("el-tab-pane"),Jo=n("el-tag"),Do=n("el-empty"),Ro=n("el-checkbox"),Wo=n("el-color-picker"),Mo=n("el-tabs"),Go=n("el-dialog"),Ho=n("el-card"),Yo=n("el-drawer"),Qo=n("el-descriptions-item"),Xo=n("el-descriptions"),Zo=s("loading"),en=s("dialog-drag");return d(),i("div",Tl,[u(t,{title:"场景管理已迁移",type:"warning",closable:!1,"show-icon":"",style:{"margin-bottom":"20px"}},{default:p(()=>[l[54]||(l[54]=b(" 场景数据已迁移到「官方模板管理」，建议使用新的模板管理功能。 ",-1)),u(a,{type:"primary",link:"",onClick:l[0]||(l[0]=l=>e.$router.push("/official-templates"))},{default:p(()=>[...l[53]||(l[53]=[b("前往官方模板管理",-1)])]),_:1})]),_:1}),c("div",Nl,[l[56]||(l[56]=c("div",{class:"header-left"},[c("h2",null,"场景管理"),c("span",{class:"subtitle"},"管理所有AI生成场景，配置步骤和定价（旧版，建议使用官方模板管理）")],-1)),c("div",jl,[u(a,{type:"primary",onClick:We},{default:p(()=>[u(o,null,{default:p(()=>[u(_(h))]),_:1}),l[55]||(l[55]=b(" 新增场景 ",-1))]),_:1})])]),c("div",ql,[u(A,{modelValue:Z.value,"onUpdate:modelValue":l[1]||(l[1]=e=>Z.value=e),onChange:De},{default:p(()=>[u(I,{label:"all"},{default:p(()=>[...l[57]||(l[57]=[b("全部",-1)])]),_:1}),u(I,{label:"active"},{default:p(()=>[...l[58]||(l[58]=[b("上线中",-1)])]),_:1}),u(I,{label:"coming_soon"},{default:p(()=>[...l[59]||(l[59]=[b("即将上线",-1)])]),_:1}),u(I,{label:"inactive"},{default:p(()=>[...l[60]||(l[60]=[b("未上线",-1)])]),_:1})]),_:1},8,["modelValue"]),c("span",Ll,"共 "+w(je.value.length)+" 个场景",1)]),r((d(),i("div",Bl,[u(be,{data:je.value,"row-key":"id","empty-text":"暂无场景数据，请点击「新增场景」按钮添加"},{default:p(()=>[u(R,{label:"排序",width:"60",align:"center"},{default:p(()=>[...l[61]||(l[61]=[c("span",{class:"drag-handle"},"☰",-1)])]),_:1}),u(R,{label:"场景","min-width":"240"},{default:p(({row:e})=>[c("div",Jl,[u(H,{class:"scene-icon-img",src:e.icon,fit:"cover","preview-src-list":[e.icon],"preview-teleported":""},{error:p(()=>{var l;return[c("div",Dl,w((null==(l=e.name)?void 0:l.charAt(0))||"?"),1)]}),_:2},1032,["src","preview-src-list"]),c("div",Rl,[c("div",Wl,w(e.name),1),c("div",Ml,w(e.description),1),c("div",Gl,"ID: "+w(e.scene_key||e.id),1)])])]),_:1}),u(R,{label:"状态",width:"200",align:"center"},{default:p(({row:e})=>[c("div",Hl,[c("div",{class:C(["status-option",{active:"active"===e.status}]),onClick:l=>Xe(e,"active")},[...l[62]||(l[62]=[c("span",{class:"status-dot green"},null,-1),c("span",{class:"status-text"},"上线",-1)])],10,Yl),c("div",{class:C(["status-option",{active:"coming_soon"===e.status}]),onClick:l=>Xe(e,"coming_soon")},[...l[63]||(l[63]=[c("span",{class:"status-dot yellow"},null,-1),c("span",{class:"status-text"},"即将",-1)])],10,Ql),c("div",{class:C(["status-option",{active:"inactive"===e.status}]),onClick:l=>Xe(e,"inactive")},[...l[64]||(l[64]=[c("span",{class:"status-dot gray"},null,-1),c("span",{class:"status-text"},"下线",-1)])],10,Xl)])]),_:1}),u(R,{label:"审核安全",width:"90",align:"center"},{default:p(({row:e})=>[u(me,{modelValue:e.is_review_safe,"onUpdate:modelValue":l=>e.is_review_safe=l,"active-value":1,"inactive-value":0,onChange:l=>Qe(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),u(R,{label:"高亮",width:"80",align:"center"},{default:p(({row:e})=>[u(me,{modelValue:e.is_highlighted,"onUpdate:modelValue":l=>e.is_highlighted=l,"active-value":1,"inactive-value":0,onChange:l=>Qe(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),u(R,{label:"醒币",width:"80",align:"center"},{default:p(({row:e})=>[c("span",Zl,w(e.points_cost||e.price),1)]),_:1}),u(R,{label:"操作",width:"120",fixed:"right"},{default:p(({row:e})=>[c("div",ea,[u(a,{type:"primary",link:"",size:"small",onClick:l=>async function(e){var l;F.value=!0,Y.value=e,Object.assign(Te,e),Te.is_review_safe=1===e.is_review_safe,ee.value="basic";try{const t=await M.get(`/config/admin/scene/${e.id}/steps`);Q.value=(t.data||[]).map(e=>{let l={};try{l=e.config?JSON.parse(e.config):{}}catch(t){l={}}const a=(e.options||[]).map(e=>{let l={};try{l=e.metadata?JSON.parse(e.metadata):{}}catch(t){l={}}return{...e,width:l.width||null,height:l.height||null}});if(1===e.gender_based||!0===e.gender_based||l.gender_based){let e=!1,l=!1;const t=a.filter(e=>"male"===e.gender),o=a.filter(e=>"female"===e.gender);t.forEach(l=>{1===l.is_default&&(e?l.is_default=0:e=!0)}),o.forEach(e=>{1===e.is_default&&(l?e.is_default=0:l=!0)}),!e&&t.length>0&&(t[0].is_default=1),!l&&o.length>0&&(o[0].is_default=1)}else{let e=!1;a.forEach(l=>{1===l.is_default&&(e?l.is_default=0:e=!0)}),!e&&a.length>0&&(a[0].is_default=1)}return{...e,config:l,is_required:1===e.is_required,is_visible:1===e.is_visible,gender_based:1===e.gender_based||!0===e.gender_based||l.gender_based||!1,icon:e.icon||l.icon||"",free_count:void 0!==e.free_count?e.free_count:1,cost_per_roll:void 0!==e.cost_per_roll?e.cost_per_roll:10,options:a}});for(const o of Q.value)if(o.step_key)try{const a=await M.get(`/admin/grade-schemes/mapping/${e.id}/${o.step_key}`);0===a.code&&(null==(l=a.data)?void 0:l.scheme_id)&&(o.config.gradeSchemeId=a.data.scheme_id)}catch(a){}X.value=Q.value.length>0?0:-1}catch(t){console.error("加载步骤失败:",t),Q.value=[],X.value=-1}try{const l=(await M.get(`/config/admin/prompts/${e.id}`)).data||[];l.length>0?(Object.assign(Ke,l[0]),Ke.is_active=1===l[0].is_active,Pe.value={name:l[0].name||"",template:l[0].template_content||l[0].template||"",negative_prompt:l[0].negative_prompt||"",segments:l[0].segments||null,model_config:l[0].model_config||null}):(Object.assign(Ke,{id:null,name:`${e.name}模板`,template:"",negative_prompt:"",segments:null,model_config:null,is_active:!0}),Pe.value={name:`${e.name}模板`,template:"",negative_prompt:"",segments:null,model_config:null})}catch(t){console.error("加载Prompt失败:",t),Object.assign(Ke,{id:null,name:`${e.name}模板`,template:"",negative_prompt:"",segments:null,model_config:null,is_active:!0}),Pe.value={name:`${e.name}模板`,template:"",negative_prompt:"",segments:null,model_config:null}}S.value=!0}(e)},{default:p(()=>[...l[65]||(l[65]=[b("编辑",-1)])]),_:1},8,["onClick"]),u(a,{type:"danger",link:"",size:"small",onClick:l=>async function(e){try{await U.confirm(`确定删除场景"${e.name}"吗？`,"删除确认",{type:"warning"}),await M.delete(`/config/admin/scene/${e.id}`),z.success("删除成功"),Re()}catch{}}(e)},{default:p(()=>[...l[66]||(l[66]=[b("删除",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])])),[[Zo,y.value]]),r((d(),g(Go,{modelValue:S.value,"onUpdate:modelValue":l[28]||(l[28]=e=>S.value=e),title:F.value?"编辑场景":"新增场景",width:"90%",style:{"max-width":"1200px"},top:"5vh"},{footer:p(()=>[u(a,{onClick:l[27]||(l[27]=e=>S.value=!1)},{default:p(()=>[...l[116]||(l[116]=[b("取消",-1)])]),_:1}),u(a,{type:"primary",onClick:Ye,loading:$.value},{default:p(()=>[...l[117]||(l[117]=[b("保存",-1)])]),_:1},8,["loading"])]),default:p(()=>[u(Mo,{modelValue:ee.value,"onUpdate:modelValue":l[26]||(l[26]=e=>ee.value=e),type:"card"},{default:p(()=>[u(Bo,{label:"基本信息",name:"basic"},{default:p(()=>[u(Lo,{model:Te,rules:Ne,ref_key:"formRef",ref:G,"label-width":"100px"},{default:p(()=>[u(Ao,{label:"场景ID",prop:"id"},{default:p(()=>[u(Se,{modelValue:Te.id,"onUpdate:modelValue":l[2]||(l[2]=e=>Te.id=e),disabled:F.value,placeholder:"如: idphoto, portrait"},null,8,["modelValue","disabled"])]),_:1}),u(Ao,{label:"场景名称",prop:"name"},{default:p(()=>[c("div",la,[u(Se,{modelValue:Te.name,"onUpdate:modelValue":l[3]||(l[3]=e=>Te.name=e),placeholder:"中文名称",style:{flex:"1"}},null,8,["modelValue"]),u(Se,{modelValue:Te.name_en,"onUpdate:modelValue":l[4]||(l[4]=e=>Te.name_en=e),placeholder:"English name",style:{flex:"1"}},null,8,["modelValue"]),u(Oo,{content:"调用腾讯翻译API",placement:"top"},{default:p(()=>[u(a,{type:"primary",link:"",onClick:gl,icon:_(E),loading:vl.name,class:"translate-btn"},{default:p(()=>[...l[67]||(l[67]=[b("翻译",-1)])]),_:1},8,["icon","loading"])]),_:1})])]),_:1}),u(Ao,{label:"场景描述",prop:"description"},{default:p(()=>[c("div",aa,[u(Se,{modelValue:Te.description,"onUpdate:modelValue":l[5]||(l[5]=e=>Te.description=e),type:"textarea",rows:2,placeholder:"简短描述（中文）",style:{flex:"1"}},null,8,["modelValue"]),u(Se,{modelValue:Te.description_en,"onUpdate:modelValue":l[6]||(l[6]=e=>Te.description_en=e),type:"textarea",rows:2,placeholder:"English description",style:{flex:"1"}},null,8,["modelValue"]),u(Oo,{content:"调用腾讯翻译API",placement:"top"},{default:p(()=>[u(a,{type:"primary",link:"",onClick:fl,icon:_(E),loading:vl.desc,class:"translate-btn"},{default:p(()=>[...l[68]||(l[68]=[b("翻译",-1)])]),_:1},8,["icon","loading"])]),_:1})])]),_:1}),u(Ao,{label:"场景图标"},{default:p(()=>[c("div",ta,[c("div",{class:"scene-icon-selector",onClick:ul,title:"点击从素材库选择图标"},[Te.icon?(d(),g(H,{key:0,class:"icon-preview-inline",src:Te.icon,fit:"cover"},null,8,["src"])):(d(),i("div",oa,[u(o,null,{default:p(()=>[u(_(h))]),_:1}),l[69]||(l[69]=c("span",null,"选择图标",-1))]))]),c("div",na,[Te.icon?(d(),g(a,{key:0,size:"small",link:"",type:"danger",onClick:l[7]||(l[7]=O(e=>Te.icon="",["stop"]))},{default:p(()=>[...l[70]||(l[70]=[b("清除",-1)])]),_:1})):x("",!0),u(Ko,{class:"icon-upload-btn",action:"/api/upload/icon",headers:Oe.value,data:{sceneId:Te.id},"show-file-list":!1,"on-success":Me,"on-error":Ge,"before-upload":He,accept:"image/*"},{default:p(()=>[u(a,{size:"small",link:""},{default:p(()=>[...l[71]||(l[71]=[b("本地上传",-1)])]),_:1})]),_:1},8,["headers","data"])]),l[72]||(l[72]=c("div",{class:"icon-upload-tips"},[c("p",null,"点击图标从COS选择"),c("p",null,"建议: 200×200px PNG")],-1))])]),_:1}),u(qo,{gutter:20},{default:p(()=>[u(No,{span:12},{default:p(()=>[u(Ao,{label:"状态"},{default:p(()=>[u(To,{modelValue:Te.status,"onUpdate:modelValue":l[8]||(l[8]=e=>Te.status=e),style:{width:"100%"}},{default:p(()=>[u(Po,{label:"上线中",value:"active"}),u(Po,{label:"即将上线",value:"coming_soon"}),u(Po,{label:"未上线",value:"inactive"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),u(No,{span:12},{default:p(()=>[u(Ao,{label:"消耗醒币"},{default:p(()=>[u(jo,{modelValue:Te.points_cost,"onUpdate:modelValue":l[9]||(l[9]=e=>Te.points_cost=e),min:1,max:1e3,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),u(Ao,{label:"审核安全"},{default:p(()=>[u(me,{modelValue:Te.is_review_safe,"onUpdate:modelValue":l[10]||(l[10]=e=>Te.is_review_safe=e)},null,8,["modelValue"]),l[73]||(l[73]=c("span",{class:"form-tip"},"审核模式下是否显示此场景",-1))]),_:1})]),_:1},8,["model"])]),_:1}),u(Bo,{label:"步骤配置",name:"steps",disabled:!F.value},{default:p(()=>{var e;return[c("div",sa,[c("div",ia,[l[77]||(l[77]=c("div",{class:"sidebar-title"},"步骤列表",-1)),u(_(W),{modelValue:Q.value,"onUpdate:modelValue":l[11]||(l[11]=e=>Q.value=e),"item-key":"id",handle:".drag-handle",onEnd:ol,class:"steps-list-compact"},{item:p(({element:e,index:t})=>[c("div",{class:C(["step-item-compact",{active:X.value===t}]),onClick:e=>function(e){X.value=e;const l=Q.value[e];l&&!l.config&&(l.config={})}(t)},[l[75]||(l[75]=c("span",{class:"drag-handle"},"☰",-1)),c("span",ca,w(t+1),1),c("div",ra,[c("span",ua,w(e.title),1),u(Jo,{size:"small",type:"info"},{default:p(()=>[b(w(e.step_key||"未设置"),1)]),_:2},1024)]),u(a,{size:"small",link:"",type:"danger",onClick:O(e=>function(e){Q.value.splice(e,1),X.value>=Q.value.length&&(X.value=Q.value.length-1)}(t),["stop"])},{default:p(()=>[...l[74]||(l[74]=[b("×",-1)])]),_:1},8,["onClick"])],10,da)]),_:1},8,["modelValue"]),u(a,{class:"add-step-btn",size:"small",onClick:Ze},{default:p(()=>[...l[76]||(l[76]=[b("+ 添加步骤",-1)])]),_:1})]),qe.value?(d(),i("div",pa,[l[80]||(l[80]=c("div",{class:"config-section-title"},"基本配置",-1)),u(Lo,{model:qe.value,"label-width":"80px",size:"small","label-position":"top"},{default:p(()=>[u(Ao,{label:"步骤图标"},{default:p(()=>[c("div",ma,[c("div",{class:"step-icon-preview",onClick:cl},[qe.value.icon?(d(),i("img",{key:0,src:qe.value.icon,class:"step-icon-img"},null,8,va)):(d(),i("div",ga,[u(o,null,{default:p(()=>[u(_(h))]),_:1})]))]),qe.value.icon?(d(),g(a,{key:0,size:"small",link:"",type:"danger",onClick:l[12]||(l[12]=e=>qe.value.icon="")},{default:p(()=>[...l[78]||(l[78]=[b("清除",-1)])]),_:1})):x("",!0)])]),_:1}),u(Ao,{label:"步骤标识"},{default:p(()=>[u(Se,{modelValue:qe.value.step_key,"onUpdate:modelValue":l[13]||(l[13]=e=>qe.value.step_key=e),placeholder:"如: gender, background"},null,8,["modelValue"])]),_:1}),u(Ao,{label:"步骤标题"},{default:p(()=>[c("div",fa,[u(Se,{modelValue:qe.value.title,"onUpdate:modelValue":l[14]||(l[14]=e=>qe.value.title=e),placeholder:"中文"},null,8,["modelValue"]),u(Se,{modelValue:qe.value.title_en,"onUpdate:modelValue":l[15]||(l[15]=e=>qe.value.title_en=e),placeholder:"English"},null,8,["modelValue"]),u(Oo,{content:"翻译",placement:"top"},{default:p(()=>[u(a,{type:"primary",link:"",size:"small",onClick:_l,icon:_(E),loading:vl.step},null,8,["icon","loading"])]),_:1})])]),_:1}),u(Ao,{label:"组件类型"},{default:p(()=>[u(To,{modelValue:qe.value.component_type,"onUpdate:modelValue":l[16]||(l[16]=e=>qe.value.component_type=e),style:{width:"100%"}},{default:p(()=>[u(Po,{label:"图片上传",value:"image_upload"}),u(Po,{label:"性别选择",value:"gender_select"}),u(Po,{label:"单选框",value:"radio"}),u(Po,{label:"标签选择",value:"tags"}),u(Po,{label:"规格选择",value:"spec_select"}),u(Po,{label:"颜色选择",value:"color_picker"}),u(Po,{label:"图片标签",value:"image_tags"}),u(Po,{label:"滑块",value:"slider"}),u(Po,{label:"摇骰子",value:"random_dice"})]),_:1},8,["modelValue"])]),_:1}),"random_dice"===qe.value.component_type?(d(),i("div",_a,[u(Ao,{label:"免费次数"},{default:p(()=>[u(jo,{modelValue:qe.value.free_count,"onUpdate:modelValue":l[17]||(l[17]=e=>qe.value.free_count=e),min:0,max:99,size:"small",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),u(Ao,{label:"每次消耗"},{default:p(()=>[u(jo,{modelValue:qe.value.cost_per_roll,"onUpdate:modelValue":l[18]||(l[18]=e=>qe.value.cost_per_roll=e),min:0,max:999,size:"small",style:{width:"100%"}},{suffix:p(()=>[...l[79]||(l[79]=[b("醒币",-1)])]),_:1},8,["modelValue"])]),_:1})])):x("",!0),c("div",ya,[u(Ao,{label:"必填"},{default:p(()=>[u(me,{modelValue:qe.value.is_required,"onUpdate:modelValue":l[19]||(l[19]=e=>qe.value.is_required=e)},null,8,["modelValue"])]),_:1}),u(Ao,{label:"显示"},{default:p(()=>[u(me,{modelValue:qe.value.is_visible,"onUpdate:modelValue":l[20]||(l[20]=e=>qe.value.is_visible=e)},null,8,["modelValue"])]),_:1}),"image_tags"===qe.value.component_type?(d(),g(Ao,{key:0,label:"性别分类"},{default:p(()=>[u(me,{modelValue:qe.value.gender_based,"onUpdate:modelValue":l[21]||(l[21]=e=>qe.value.gender_based=e)},null,8,["modelValue"])]),_:1})):x("",!0)])]),_:1},8,["model"])])):(d(),i("div",ba,[u(Do,{description:"请选择步骤","image-size":60})])),qe.value?(d(),i("div",ha,["image_upload"===qe.value.component_type?(d(),i("div",ka,[u(o,{size:40,color:"#909399"},{default:p(()=>[u(_(k))]),_:1}),l[81]||(l[81]=c("p",null,"图片上传组件",-1)),l[82]||(l[82]=c("span",null,"此组件用于用户上传照片，无需配置选项",-1))])):"gender_select"===qe.value.component_type?(d(),i("div",wa,[u(o,{size:40,color:"#909399"},{default:p(()=>[u(_(K))]),_:1}),l[83]||(l[83]=c("p",null,"性别选择组件",-1)),l[84]||(l[84]=c("span",null,"此组件提供男/女选项，无需额外配置",-1))])):"random_dice"===qe.value.component_type?(d(),i("div",Va,[c("div",xa,[u(Ro,{modelValue:qe.value.config.showImage,"onUpdate:modelValue":l[22]||(l[22]=e=>qe.value.config.showImage=e),size:"small"},{default:p(()=>[...l[85]||(l[85]=[b("显示图片",-1)])]),_:1},8,["modelValue"]),l[86]||(l[86]=c("span",{class:"config-tip"},"（勾选后每个选项需要配置图片）",-1))]),c("div",Ca,[l[88]||(l[88]=c("div",{class:"section-title"}," 品级方案管理 ",-1)),Te.id&&qe.value.step_key?(d(),i("div",za,[c("div",Ua,[u(To,{modelValue:qe.value.config.gradeSchemeId,"onUpdate:modelValue":l[23]||(l[23]=e=>qe.value.config.gradeSchemeId=e),placeholder:"选择品级方案",style:{width:"180px"},size:"small",onChange:Fe},{default:p(()=>[(d(!0),i(m,null,v(Ce.value,e=>(d(),g(Po,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),u(a,{size:"small",onClick:$e},{default:p(()=>[...l[87]||(l[87]=[b("编辑",-1)])]),_:1})]),Ue.value?(d(),i("div",$a,[(d(!0),i(m,null,v(Ue.value.grades,e=>(d(),i("span",{key:e.id,class:"grade-preview-item",style:V({background:e.color,color:"#fff"})},w(e.name),5))),128))])):x("",!0)])):(d(),g(Do,{key:1,description:"请先保存场景","image-size":60}))]),c("div",Ia,[l[89]||(l[89]=c("div",{class:"section-title"},"词条池管理",-1)),Te.id&&qe.value.step_key?(d(),g(ye,{"scene-id":Te.id,"step-key":qe.value.step_key,"show-image":(null==(e=qe.value.config)?void 0:e.showImage)||!1,key:qe.value.step_key},null,8,["scene-id","step-key","show-image"])):(d(),g(Do,{key:1,description:"请先保存场景","image-size":60}))])])):(d(),i(m,{key:3},[c("div",Sa,[l[92]||(l[92]=b(" 选项配置 ",-1)),c("div",Fa,[u(Oo,{content:"批量翻译所有选项为英文",placement:"top"},{default:p(()=>[u(a,{size:"small",type:"success",link:"",onClick:yl,icon:_(E)},{default:p(()=>[...l[90]||(l[90]=[b("批量翻译",-1)])]),_:1},8,["icon"])]),_:1}),u(a,{size:"small",type:"primary",link:"",onClick:el},{default:p(()=>[...l[91]||(l[91]=[b("+ 添加选项",-1)])]),_:1})])]),"image_tags"===qe.value.component_type&&qe.value.gender_based?(d(),i("div",Ea,[u(A,{modelValue:Le.value,"onUpdate:modelValue":l[24]||(l[24]=e=>Le.value=e),size:"small"},{default:p(()=>[u(I,{label:""},{default:p(()=>[...l[93]||(l[93]=[b("全部",-1)])]),_:1}),u(I,{label:"male"},{default:p(()=>[...l[94]||(l[94]=[b("男",-1)])]),_:1}),u(I,{label:"female"},{default:p(()=>[...l[95]||(l[95]=[b("女",-1)])]),_:1})]),_:1},8,["modelValue"]),c("span",Aa,w(Be.value.length)+" 项",1)])):x("",!0),"spec_select"===qe.value.component_type?(d(),i("div",Oa,[u(o,null,{default:p(()=>[u(_(P))]),_:1}),l[96]||(l[96]=c("span",null,"尺寸用于后端动态裁剪",-1))])):x("",!0),c("div",Ka,["image_tags"===qe.value.component_type?(d(!0),i(m,{key:0},v(Be.value,(e,t)=>(d(),i("div",{key:e.option_key||t,class:"image-tag-row"},[c("div",Pa,[c("div",{class:"option-thumb-selector",onClick:l=>async function(e){var l;nl.value=e,re.value=-1,ce.value=e.image||"",(null==(l=qe.value)?void 0:l.gender_based)&&e.gender?de.value=e.gender:de.value="",le.value=!0,0===te.value.length?await sl():il()}(e),title:"点击从素材库选择图片"},[e.image?(d(),g(H,{key:0,class:"option-thumb",src:e.image,fit:"cover"},null,8,["src"])):(d(),i("div",Na,[u(o,null,{default:p(()=>[u(_(h))]),_:1})]))],8,Ta),e.image?(d(),g(a,{key:0,size:"small",link:"",type:"danger",onClick:O(l=>e.image="",["stop"]),title:"清除图片"},{default:p(()=>[...l[97]||(l[97]=[b("清除",-1)])]),_:1},8,["onClick"])):x("",!0)]),c("div",ja,[c("div",qa,[c("div",La,[l[98]||(l[98]=c("label",null,"中文",-1)),u(Se,{modelValue:e.label,"onUpdate:modelValue":l=>e.label=l,size:"small",style:{width:"90px"},placeholder:"名称"},null,8,["modelValue","onUpdate:modelValue"])]),c("div",Ba,[l[99]||(l[99]=c("label",null,"English",-1)),c("div",Ja,[u(Se,{modelValue:e.label_en,"onUpdate:modelValue":l=>e.label_en=l,size:"small",style:{width:"100px"},placeholder:"Name"},null,8,["modelValue","onUpdate:modelValue"]),u(Oo,{content:"翻译",placement:"top"},{default:p(()=>[u(a,{type:"primary",link:"",size:"small",onClick:l=>bl(e),class:"mini-translate-btn"},{default:p(()=>[u(o,{size:12},{default:p(()=>[u(_(E))]),_:1})]),_:1},8,["onClick"])]),_:2},1024)])]),qe.value.gender_based?(d(),i("div",Da,[l[100]||(l[100]=c("label",null,"性别",-1)),u(To,{modelValue:e.gender,"onUpdate:modelValue":l=>e.gender=l,size:"small",style:{width:"65px"},clearable:""},{default:p(()=>[u(Po,{label:"男",value:"male"}),u(Po,{label:"女",value:"female"})]),_:1},8,["modelValue","onUpdate:modelValue"])])):x("",!0),c("div",Ra,[l[102]||(l[102]=c("label",null," ",-1)),u(Ro,{"model-value":1===e.is_default,onChange:l=>al(e),size:"small",disabled:tl(e)},{default:p(()=>[...l[101]||(l[101]=[b("默认",-1)])]),_:1},8,["model-value","onChange","disabled"])]),c("div",Wa,[l[104]||(l[104]=c("label",null," ",-1)),u(a,{size:"small",link:"",type:"danger",onClick:l=>function(e){const l=qe.value.options.indexOf(e);l>=0&&ll(l)}(e)},{default:p(()=>[...l[103]||(l[103]=[b("删除",-1)])]),_:1},8,["onClick"])])]),c("div",Ma,[l[105]||(l[105]=c("label",null,"AI提示词",-1)),u(Se,{modelValue:e.prompt_text,"onUpdate:modelValue":l=>e.prompt_text=l,size:"small",placeholder:"发送给AI的描述文字"},null,8,["modelValue","onUpdate:modelValue"])])])]))),128)):"tags"===qe.value.component_type?(d(),i(m,{key:1},[l[107]||(l[107]=c("div",{class:"tags-table-header"},[c("div",{class:"tags-col tags-col-label-main"},"中文"),c("div",{class:"tags-col tags-col-label"},"English"),c("div",{class:"tags-col tags-col-prompt"},"AI提示词"),c("div",{class:"tags-col tags-col-default"},"默认"),c("div",{class:"tags-col tags-col-action"},"操作")],-1)),(d(!0),i(m,null,v(qe.value.options,(e,t)=>(d(),i("div",{key:t,class:"tags-table-row"},[c("div",Ga,[u(Se,{modelValue:e.label,"onUpdate:modelValue":l=>e.label=l,placeholder:"标签名",size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),c("div",Ha,[c("div",Ya,[u(Se,{modelValue:e.label_en,"onUpdate:modelValue":l=>e.label_en=l,placeholder:"Tag",size:"small"},null,8,["modelValue","onUpdate:modelValue"]),u(a,{type:"primary",link:"",size:"small",onClick:l=>bl(e),class:"mini-translate-btn"},{default:p(()=>[u(o,{size:12},{default:p(()=>[u(_(E))]),_:1})]),_:1},8,["onClick"])])]),c("div",Qa,[u(Se,{modelValue:e.prompt_text,"onUpdate:modelValue":l=>e.prompt_text=l,placeholder:"发送给AI的描述",size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),c("div",Xa,[u(Ro,{"model-value":1===e.is_default,onChange:l=>al(e),size:"small",disabled:1===e.is_default},null,8,["model-value","onChange","disabled"])]),c("div",Za,[u(a,{size:"small",link:"",type:"danger",onClick:e=>ll(t)},{default:p(()=>[...l[106]||(l[106]=[b("删除",-1)])]),_:1},8,["onClick"])])]))),128))],64)):"spec_select"===qe.value.component_type?(d(),i(m,{key:2},[l[109]||(l[109]=c("div",{class:"spec-table-header"},[c("div",{class:"spec-col spec-col-label-main"},"中文"),c("div",{class:"spec-col spec-col-label"},"English"),c("div",{class:"spec-col spec-col-size"},"宽度(mm)"),c("div",{class:"spec-col spec-col-size"},"高度(mm)"),c("div",{class:"spec-col spec-col-default"},"默认"),c("div",{class:"spec-col spec-col-action"},"操作")],-1)),(d(!0),i(m,null,v(qe.value.options,(e,t)=>(d(),i("div",{key:t,class:"spec-table-row"},[c("div",et,[u(Se,{modelValue:e.label,"onUpdate:modelValue":l=>e.label=l,placeholder:"一寸",size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),c("div",lt,[c("div",at,[u(Se,{modelValue:e.label_en,"onUpdate:modelValue":l=>e.label_en=l,placeholder:"1 inch",size:"small"},null,8,["modelValue","onUpdate:modelValue"]),u(a,{type:"primary",link:"",size:"small",onClick:l=>bl(e),class:"mini-translate-btn"},{default:p(()=>[u(o,{size:12},{default:p(()=>[u(_(E))]),_:1})]),_:1},8,["onClick"])])]),c("div",tt,[u(Se,{modelValue:e.width,"onUpdate:modelValue":l=>e.width=l,modelModifiers:{number:!0},type:"number",size:"small",placeholder:"25"},null,8,["modelValue","onUpdate:modelValue"])]),c("div",ot,[u(Se,{modelValue:e.height,"onUpdate:modelValue":l=>e.height=l,modelModifiers:{number:!0},type:"number",size:"small",placeholder:"35"},null,8,["modelValue","onUpdate:modelValue"])]),c("div",nt,[u(Ro,{"model-value":1===e.is_default,onChange:l=>al(e),size:"small",disabled:1===e.is_default},null,8,["model-value","onChange","disabled"])]),c("div",st,[u(a,{size:"small",link:"",type:"danger",onClick:e=>ll(t)},{default:p(()=>[...l[108]||(l[108]=[b("删除",-1)])]),_:1},8,["onClick"])])]))),128))],64)):"random_dice"!==qe.value.component_type?(d(),i(m,{key:3},[c("div",it,[l[110]||(l[110]=c("div",{class:"common-col common-col-label-main"},"中文",-1)),l[111]||(l[111]=c("div",{class:"common-col common-col-label"},"English",-1)),"color_picker"===qe.value.component_type?(d(),i("div",dt,"颜色")):(d(),i("div",ct,"图片URL")),l[112]||(l[112]=c("div",{class:"common-col common-col-prompt"},"AI提示词",-1)),l[113]||(l[113]=c("div",{class:"common-col common-col-default"},"默认",-1)),l[114]||(l[114]=c("div",{class:"common-col common-col-action"},"操作",-1))]),(d(!0),i(m,null,v(qe.value.options,(e,t)=>(d(),i("div",{key:t,class:"common-table-row"},[c("div",rt,[u(Se,{modelValue:e.label,"onUpdate:modelValue":l=>e.label=l,placeholder:"选项名",size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),c("div",ut,[c("div",pt,[u(Se,{modelValue:e.label_en,"onUpdate:modelValue":l=>e.label_en=l,placeholder:"Option",size:"small"},null,8,["modelValue","onUpdate:modelValue"]),u(a,{type:"primary",link:"",size:"small",onClick:l=>bl(e),class:"mini-translate-btn"},{default:p(()=>[u(o,{size:12},{default:p(()=>[u(_(E))]),_:1})]),_:1},8,["onClick"])])]),c("div",mt,["color_picker"===qe.value.component_type?(d(),g(Wo,{key:0,modelValue:e.color,"onUpdate:modelValue":l=>e.color=l,size:"small"},null,8,["modelValue","onUpdate:modelValue"])):(d(),g(Se,{key:1,modelValue:e.image,"onUpdate:modelValue":l=>e.image=l,placeholder:"URL",size:"small"},null,8,["modelValue","onUpdate:modelValue"]))]),c("div",vt,[u(Se,{modelValue:e.prompt_text,"onUpdate:modelValue":l=>e.prompt_text=l,placeholder:"发送给AI的描述",size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),c("div",gt,[u(Ro,{"model-value":1===e.is_default,onChange:l=>al(e),size:"small",disabled:1===e.is_default},null,8,["model-value","onChange","disabled"])]),c("div",ft,[u(a,{size:"small",link:"",type:"danger",onClick:e=>ll(t)},{default:p(()=>[...l[115]||(l[115]=[b("删除",-1)])]),_:1},8,["onClick"])])]))),128))],64)):x("",!0)])],64))])):(d(),i("div",_t,[u(Do,{description:"选择步骤后配置选项","image-size":60})]))])]}),_:1},8,["disabled"]),u(Bo,{label:"Prompt模板",name:"prompt",disabled:!F.value},{default:p(()=>[u(Pl,{modelValue:Pe.value,"onUpdate:modelValue":l[25]||(l[25]=e=>Pe.value=e),"scene-steps":Q.value,"scene-id":Te.id},null,8,["modelValue","scene-steps","scene-id"])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title"])),[[en]]),r((d(),g(Go,{modelValue:le.value,"onUpdate:modelValue":l[33]||(l[33]=e=>le.value=e),title:"从COS选择图片",width:"90%",style:{"max-width":"900px"},"append-to-body":""},{footer:p(()=>[u(a,{onClick:l[32]||(l[32]=e=>le.value=!1)},{default:p(()=>[...l[122]||(l[122]=[b("取消",-1)])]),_:1}),u(a,{type:"primary",onClick:dl,disabled:!ce.value},{default:p(()=>[...l[123]||(l[123]=[b("确定选择",-1)])]),_:1},8,["disabled"])]),default:p(()=>[c("div",yt,[c("div",bt,[qe.value&&qe.value.gender_based?(d(),g(A,{key:0,modelValue:de.value,"onUpdate:modelValue":l[29]||(l[29]=e=>de.value=e),size:"small",onChange:il},{default:p(()=>[u(I,{label:""},{default:p(()=>[...l[118]||(l[118]=[b("全部",-1)])]),_:1}),u(I,{label:"male"},{default:p(()=>[...l[119]||(l[119]=[b("男",-1)])]),_:1}),u(I,{label:"female"},{default:p(()=>[...l[120]||(l[120]=[b("女",-1)])]),_:1})]),_:1},8,["modelValue"])):x("",!0),u(To,{modelValue:ie.value,"onUpdate:modelValue":l[30]||(l[30]=e=>ie.value=e),placeholder:"选择文件夹",clearable:"",style:{width:"200px"},onChange:il},{default:p(()=>[u(Po,{label:"全部文件夹",value:""}),(d(!0),i(m,null,v(ne.value,e=>(d(),g(Po,{key:e,label:e||"根目录",value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),u(Se,{modelValue:se.value,"onUpdate:modelValue":l[31]||(l[31]=e=>se.value=e),placeholder:"搜索文件名...",clearable:"",style:{width:"180px"},onInput:il},null,8,["modelValue"]),u(a,{onClick:sl,loading:ae.value},{default:p(()=>[...l[121]||(l[121]=[b("刷新",-1)])]),_:1},8,["loading"])]),oe.value.length>0?(d(),i("div",ht,[c("span",kt,"共 "+w(oe.value.length)+" 张图片",1)])):x("",!0),r((d(),i("div",wt,[(d(!0),i(m,null,v(oe.value,e=>(d(),i("div",{key:e.key,class:C(["cos-image-item",{selected:ce.value===e.url}]),onClick:l=>function(e){ce.value=e.url}(e)},[u(H,{src:e.url,fit:"cover",lazy:""},null,8,["src"]),c("div",xt,[c("div",Ct,w(e.fileName),1),c("div",zt,[e.folderPath&&"根目录"!==e.folderPath?(d(),g(Jo,{key:0,size:"small",type:"info"},{default:p(()=>[b(w(e.folderPath),1)]),_:2},1024)):x("",!0)])])],10,Vt))),128)),ae.value||0!==oe.value.length?x("",!0):(d(),g(Do,{key:0,description:"暂无图片，请调整筛选条件"}))])),[[Zo,ae.value]])])]),_:1},8,["modelValue"])),[[en]]),r((d(),g(Go,{modelValue:ue.value,"onUpdate:modelValue":l[36]||(l[36]=e=>ue.value=e),title:"选择步骤图标",width:"90%",style:{"max-width":"600px"},"append-to-body":""},{footer:p(()=>[u(a,{onClick:l[35]||(l[35]=e=>ue.value=!1)},{default:p(()=>[...l[124]||(l[124]=[b("取消",-1)])]),_:1}),u(a,{type:"primary",onClick:rl,disabled:!ge.value},{default:p(()=>[...l[125]||(l[125]=[b("确定选择",-1)])]),_:1},8,["disabled"])]),default:p(()=>[c("div",Ut,[u(Se,{modelValue:ve.value,"onUpdate:modelValue":l[34]||(l[34]=e=>ve.value=e),placeholder:"搜索图标...",clearable:"",style:{width:"200px","margin-bottom":"12px"}},null,8,["modelValue"]),r((d(),i("div",$t,[(d(!0),i(m,null,v(Ee.value,e=>(d(),i("div",{key:e.key,class:C(["step-icon-item",{selected:ge.value===e.url}]),onClick:l=>function(e){ge.value=e.url}(e)},[c("img",{src:e.url,alt:e.fileName},null,8,St),c("div",Ft,w(e.fileName),1)],10,It))),128)),pe.value||0!==Ee.value.length?x("",!0):(d(),g(Do,{key:0,description:"暂无图标"}))])),[[Zo,pe.value]])])]),_:1},8,["modelValue"])),[[en]]),r((d(),g(Go,{modelValue:fe.value,"onUpdate:modelValue":l[40]||(l[40]=e=>fe.value=e),title:"从COS选择场景图标",width:"90%",style:{"max-width":"900px"},"append-to-body":""},{footer:p(()=>[u(a,{onClick:l[39]||(l[39]=e=>fe.value=!1)},{default:p(()=>[...l[127]||(l[127]=[b("取消",-1)])]),_:1}),u(a,{type:"primary",onClick:ml,disabled:!Ve.value},{default:p(()=>[...l[128]||(l[128]=[b("确定选择",-1)])]),_:1},8,["disabled"])]),default:p(()=>[c("div",Et,[c("div",At,[u(To,{modelValue:we.value,"onUpdate:modelValue":l[37]||(l[37]=e=>we.value=e),placeholder:"选择文件夹",clearable:"",style:{width:"160px"},onChange:Ae},{default:p(()=>[u(Po,{label:"全部文件夹",value:""}),(d(!0),i(m,null,v(he.value,e=>(d(),g(Po,{key:e,label:e||"根目录",value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),u(Se,{modelValue:ke.value,"onUpdate:modelValue":l[38]||(l[38]=e=>ke.value=e),placeholder:"搜索图片...",clearable:"",style:{width:"200px"},onInput:Ae},null,8,["modelValue"]),u(a,{onClick:pl,loading:_e.value,size:"small"},{default:p(()=>[...l[126]||(l[126]=[b("刷新",-1)])]),_:1},8,["loading"]),xe.value.length>0?(d(),i("span",Ot,"共 "+w(xe.value.length)+" 张图片",1)):x("",!0)]),r((d(),i("div",Kt,[(d(!0),i(m,null,v(xe.value,e=>(d(),i("div",{key:e.key,class:C(["scene-icon-item",{selected:Ve.value===e.url}]),onClick:l=>function(e){Ve.value=e.url}(e)},[u(H,{src:e.url,fit:"cover",lazy:""},null,8,["src"]),c("div",Tt,[c("div",Nt,w(e.fileName),1),c("div",jt,[e.folderPath?(d(),g(Jo,{key:0,size:"small",type:"info"},{default:p(()=>[b(w(e.folderPath),1)]),_:2},1024)):x("",!0)])])],10,Pt))),128)),_e.value||0!==xe.value.length?x("",!0):(d(),g(Do,{key:0,description:"暂无图片"}))])),[[Zo,_e.value]])])]),_:1},8,["modelValue"])),[[en]]),c("div",{class:C(["ai-assistant-fab",{active:hl.value}]),onClick:Il},[u(o,{size:24},{default:p(()=>[u(_(E))]),_:1}),l[129]||(l[129]=c("span",{class:"fab-label"},"AI助手",-1))],2),u(Yo,{modelValue:hl.value,"onUpdate:modelValue":l[47]||(l[47]=e=>hl.value=e),title:"AI 场景生成助手",direction:"rtl",size:"420px","close-on-click-modal":!1},{default:p(()=>[c("div",qt,[c("div",Lt,[u(A,{modelValue:kl.value,"onUpdate:modelValue":l[41]||(l[41]=e=>kl.value=e),size:"small"},{default:p(()=>[u(I,{label:"create"},{default:p(()=>[...l[130]||(l[130]=[b("新建场景",-1)])]),_:1}),u(I,{label:"modify",disabled:!Y.value},{default:p(()=>[...l[131]||(l[131]=[b("修改场景",-1)])]),_:1},8,["disabled"]),u(I,{label:"image"},{default:p(()=>[...l[132]||(l[132]=[b("生成图标",-1)])]),_:1})]),_:1},8,["modelValue"])]),"modify"===kl.value&&Y.value?(d(),i("div",Bt,[u(o,null,{default:p(()=>[u(_(T))]),_:1}),c("span",null,"当前场景: "+w(Y.value.name),1)])):x("",!0),"image"===kl.value?(d(),i("div",Jt,[c("div",Dt,[u(t,{title:"AI图片生成已禁用",type:"info",closable:!1,"show-icon":""},{default:p(()=>[...l[133]||(l[133]=[c("p",null,"由于绿幕抠图效果不理想，AI图片生成功能已暂时禁用。",-1),c("p",{style:{"margin-top":"8px"}},"请使用以下方式管理图片：",-1),c("ol",{style:{margin:"8px 0 0 16px",padding:"0"}},[c("li",null,"在「素材管理」中上传图片素材"),c("li",null,"在「场景配置」的步骤选项中点击图片区域从素材库选择")],-1)])]),_:1})]),c("div",Rt,[u(a,{type:"primary",onClick:El},{default:p(()=>[u(o,null,{default:p(()=>[u(_(T))]),_:1}),l[134]||(l[134]=b(" 前往素材管理 ",-1))]),_:1})]),Y.value?(d(),i("div",Wt,[u(Ho,{shadow:"never"},{header:p(()=>[c("span",null,"当前场景: "+w(Y.value.name),1)]),default:p(()=>[l[135]||(l[135]=c("p",{style:{"font-size":"13px",color:"#909399"}}," 请在编辑场景时，点击步骤选项的图片区域从COS素材库选择图片。 ",-1))]),_:1})])):x("",!0)])):x("",!0),r(c("div",{class:"ai-chat-history",ref_key:"chatHistoryRef",ref:zl},[0===Cl.value.length?(d(),i("div",Mt,[l[137]||(l[137]=c("div",{class:"welcome-icon"},"🤖",-1)),l[138]||(l[138]=c("h3",null,"AI 场景生成助手",-1)),"create"===kl.value?(d(),i("p",Gt,"描述您想要创建的场景，我将自动生成完整配置")):(d(),i("p",Ht,"描述您想要修改的内容，我将帮您调整当前场景")),c("div",Yt,[l[136]||(l[136]=c("div",{class:"suggestion-title"},"试试这样说:",-1)),"create"===kl.value?(d(),i("div",{key:0,class:"suggestion-item",onClick:l[42]||(l[42]=e=>Sl("帮我创建一个宠物写真场景，包含宠物类型选择、背景风格、滤镜效果等步骤"))},' "帮我创建一个宠物写真场景" ')):x("",!0),"create"===kl.value?(d(),i("div",{key:1,class:"suggestion-item",onClick:l[43]||(l[43]=e=>Sl("创建一个职业形象照场景，需要性别选择、行业选择、着装风格、背景颜色等配置"))},' "创建一个职业形象照场景" ')):x("",!0),"modify"===kl.value?(d(),i("div",{key:2,class:"suggestion-item",onClick:l[44]||(l[44]=e=>Sl("添加一个新的背景颜色选项：渐变紫色"))},' "添加一个新的背景颜色选项" ')):x("",!0),"modify"===kl.value?(d(),i("div",{key:3,class:"suggestion-item",onClick:l[45]||(l[45]=e=>Sl("优化当前场景的Prompt模板，使生成效果更专业"))},' "优化Prompt模板" ')):x("",!0)])])):x("",!0),(d(!0),i(m,null,v(Cl.value,(e,t)=>{var n,s,r,f,y,h,k;return d(),i("div",{key:t,class:C(["ai-message",e.role])},[c("div",Qt,["user"===e.role?(d(),i("span",Xt,"👤")):(d(),i("span",Zt,"🤖"))]),c("div",eo,[c("div",{class:"message-text",innerHTML:(k=e.content,k?k.replace(/\n/g,"<br>"):"")},null,8,lo),"assistant"===e.role&&e.generatedConfig?(d(),i("div",ao,[c("div",to,[u(o,null,{default:p(()=>[u(_(N))]),_:1}),l[139]||(l[139]=c("span",null,"已生成场景配置",-1))]),c("div",oo,[c("div",null,"场景: "+w((null==(n=e.generatedConfig.scene)?void 0:n.name)||"未命名"),1),c("div",null,"步骤数: "+w((null==(s=e.generatedConfig.steps)?void 0:s.length)||0),1),(null==(r=e.generatedConfig.scene)?void 0:r.icon)?(d(),i("div",no,[c("img",{src:e.generatedConfig.scene.icon,alt:"场景图标",style:{width:"40px",height:"40px","border-radius":"4px"}},null,8,so)])):x("",!0),e.imageTasksPending?(d(),i("div",io,[c("div",co,[u(o,null,{default:p(()=>[u(_(j))]),_:1}),c("span",null,"需要生成 "+w((null==(f=e.imageTasks)?void 0:f.length)||0)+" 张图片",1)]),c("div",ro,[(d(!0),i(m,null,v(e.imageTasks,(e,l)=>(d(),i("div",{key:l,class:"task-item"},[u(o,null,{default:p(()=>[u(_(q))]),_:1}),c("span",null,w(e.label),1)]))),128))]),c("div",uo,[u(a,{type:"primary",size:"small",onClick:e=>Al(t)},{default:p(()=>{var l;return[b(" 确认生成（消耗 "+w((null==(l=e.imageTasks)?void 0:l.length)||0)+" 次调用） ",1)]}),_:2},1032,["onClick"]),u(a,{size:"small",onClick:e=>function(e){var l,a;const t=Cl.value[e];t&&(t.imageTasksPending=!1,t.imageTasks=[],t.content="create"===kl.value?`已为您生成「${(null==(l=t.generatedConfig.scene)?void 0:l.name)||"新场景"}」的完整配置，包含 ${(null==(a=t.generatedConfig.steps)?void 0:a.length)||0} 个步骤。已跳过图片生成，点击下方按钮可预览详情或直接应用。`:"已根据您的要求修改了场景配置。已跳过图片生成，点击下方按钮查看修改结果。",z.info("已跳过图片生成"),Fl())}(t)},{default:p(()=>[...l[140]||(l[140]=[b(" 跳过图片生成 ",-1)])]),_:1},8,["onClick"])])])):x("",!0),e.generatingImages?(d(),i("div",po,[c("div",mo,[u(o,{class:"is-loading"},{default:p(()=>[u(_(L))]),_:1}),c("span",null,"正在生成图标和示意图 ("+w((null==(y=e.imageProgress)?void 0:y.current)||0)+"/"+w((null==(h=e.imageProgress)?void 0:h.total)||0)+")",1)]),c("div",vo,[(d(!0),i(m,null,v(e.imageTasks,(e,l)=>(d(),i("div",{key:l,class:C(["progress-task-item",e.status])},["completed"===e.status?(d(),g(o,{key:0},{default:p(()=>[u(_(B))]),_:1})):"processing"===e.status?(d(),g(o,{key:1,class:"is-loading"},{default:p(()=>[u(_(L))]),_:1})):(d(),g(o,{key:2},{default:p(()=>[u(_(J))]),_:1})),c("span",null,w(e.label),1)],2))),128))])])):x("",!0)]),c("div",go,[u(a,{type:"primary",size:"small",onClick:l=>Kl(e.generatedConfig),disabled:e.generatingImages||e.imageTasksPending},{default:p(()=>[...l[141]||(l[141]=[b(" 应用配置 ",-1)])]),_:1},8,["onClick","disabled"]),u(a,{size:"small",onClick:l=>{return a=e.generatedConfig,$l.value=a,void(Ul.value=!0);var a}},{default:p(()=>[...l[142]||(l[142]=[b(" 预览详情 ",-1)])]),_:1},8,["onClick"])])])):x("",!0)])],2)}),128)),Vl.value?(d(),i("div",fo,[...l[143]||(l[143]=[c("div",{class:"message-avatar"},"🤖",-1),c("div",{class:"message-content"},[c("div",{class:"message-loading"},[c("span"),c("span"),c("span")])],-1)])])):x("",!0)],512),[[D,"image"!==kl.value]]),c("div",_o,[u(Se,{modelValue:wl.value,"onUpdate:modelValue":l[46]||(l[46]=e=>wl.value=e),type:"textarea",rows:3,placeholder:"create"===kl.value?"描述您想创建的场景...":"描述您想修改的内容...",onKeydown:f(O(Ol,["ctrl"]),["enter"]),disabled:Vl.value},null,8,["modelValue","placeholder","onKeydown","disabled"]),c("div",yo,[l[145]||(l[145]=c("span",{class:"input-hint"},"Ctrl + Enter 发送",-1)),u(a,{type:"primary",onClick:Ol,loading:Vl.value,disabled:!wl.value.trim()},{default:p(()=>[...l[144]||(l[144]=[b(" 发送 ",-1)])]),_:1},8,["loading","disabled"])])])])]),_:1},8,["modelValue"]),u(Go,{modelValue:Ul.value,"onUpdate:modelValue":l[50]||(l[50]=e=>Ul.value=e),title:"AI 生成配置预览",width:"80%",style:{"max-width":"900px"},"append-to-body":""},{footer:p(()=>[u(a,{onClick:l[48]||(l[48]=e=>Ul.value=!1)},{default:p(()=>[...l[147]||(l[147]=[b("关闭",-1)])]),_:1}),u(a,{type:"primary",onClick:l[49]||(l[49]=e=>{Kl($l.value),Ul.value=!1})},{default:p(()=>[...l[148]||(l[148]=[b(" 应用此配置 ",-1)])]),_:1})]),default:p(()=>[$l.value?(d(),i("div",bo,[u(Mo,null,{default:p(()=>{var e;return[u(Bo,{label:"场景信息"},{default:p(()=>[u(Xo,{column:2,border:""},{default:p(()=>[u(Qo,{label:"场景ID"},{default:p(()=>{var e;return[b(w(null==(e=$l.value.scene)?void 0:e.scene_key),1)]}),_:1}),u(Qo,{label:"场景名称"},{default:p(()=>{var e;return[b(w(null==(e=$l.value.scene)?void 0:e.name),1)]}),_:1}),u(Qo,{label:"英文名称"},{default:p(()=>{var e;return[b(w(null==(e=$l.value.scene)?void 0:e.name_en),1)]}),_:1}),u(Qo,{label:"消耗醒币"},{default:p(()=>{var e;return[b(w(null==(e=$l.value.scene)?void 0:e.points_cost),1)]}),_:1}),u(Qo,{label:"场景图标"},{default:p(()=>{var e;return[(null==(e=$l.value.scene)?void 0:e.icon)?(d(),i("img",{key:0,src:$l.value.scene.icon,alt:"场景图标",style:{width:"60px",height:"60px","border-radius":"8px","object-fit":"cover"}},null,8,ho)):(d(),i("span",ko,"暂无图标"))]}),_:1}),u(Qo,{label:"图标描述"},{default:p(()=>{var e;return[b(w((null==(e=$l.value.scene)?void 0:e.icon_description)||"无"),1)]}),_:1}),u(Qo,{label:"中文描述",span:2},{default:p(()=>{var e;return[b(w(null==(e=$l.value.scene)?void 0:e.description),1)]}),_:1}),u(Qo,{label:"英文描述",span:2},{default:p(()=>{var e;return[b(w(null==(e=$l.value.scene)?void 0:e.description_en),1)]}),_:1})]),_:1})]),_:1}),u(Bo,{label:`步骤配置 (${(null==(e=$l.value.steps)?void 0:e.length)||0})`},{default:p(()=>[(d(!0),i(m,null,v($l.value.steps,(e,l)=>{var a;return d(),i("div",{key:l,class:"preview-step-card"},[c("div",wo,[c("span",Vo,w(l+1),1),c("span",xo,w(e.title)+" ("+w(e.step_key)+")",1),u(Jo,{size:"small"},{default:p(()=>{return[b(w((l=e.component_type,Je[l]||l)),1)];var l}),_:2},1024)]),(null==(a=e.options)?void 0:a.length)?(d(),i("div",Co,[c("div",zo,[(d(!0),i(m,null,v(e.options,e=>(d(),i("div",{key:e.option_key,class:"option-item"},[e.image?(d(),i("img",{key:0,src:e.image,alt:e.label,class:"option-preview-image"},null,8,Uo)):(d(),i("div",$o,[u(o,null,{default:p(()=>[u(_(j))]),_:1})])),c("div",Io,w(e.label),1)]))),128))])])):x("",!0)])}),128))]),_:1},8,["label"]),u(Bo,{label:"Prompt模板"},{default:p(()=>{var e,a,t;return[c("div",So,[l[146]||(l[146]=c("div",{class:"prompt-label"},"正向提示词:",-1)),c("pre",null,w(null==(e=$l.value.prompt_template)?void 0:e.template),1),(null==(a=$l.value.prompt_template)?void 0:a.negative_prompt)?(d(),i("div",Fo,"负面提示词:")):x("",!0),(null==(t=$l.value.prompt_template)?void 0:t.negative_prompt)?(d(),i("pre",Eo,w($l.value.prompt_template.negative_prompt),1)):x("",!0)])]}),_:1})]}),_:1})])):x("",!0)]),_:1},8,["modelValue"]),u(Go,{modelValue:ze.value,"onUpdate:modelValue":l[52]||(l[52]=e=>ze.value=e),title:"品级方案管理",width:"900px","destroy-on-close":""},{footer:p(()=>[u(a,{onClick:l[51]||(l[51]=e=>ze.value=!1)},{default:p(()=>[...l[149]||(l[149]=[b("关闭",-1)])]),_:1})]),default:p(()=>{var e;return[ze.value&&Te.id&&(null==(e=qe.value)?void 0:e.step_key)?(d(),g(xl,{key:0,"scene-id":String(Te.id),"step-key":qe.value.step_key,onChange:Ie},null,8,["scene-id","step-key"])):x("",!0)]}),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-6579ac3a"]]);export{Ao as default};
