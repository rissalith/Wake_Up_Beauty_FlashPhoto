name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      skip_backup:
        description: 'è·³è¿‡éƒ¨ç½²å‰å¤‡ä»½'
        required: false
        default: 'false'
        type: boolean

env:
  DOMAIN: pop-pub.com
  DEPLOY_PATH: /www/wwwroot/pop-pub.com

jobs:
  notify-start:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Start
        run: |
          if [ -n "${{ secrets.WECHAT_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "msgtype": "markdown",
                "markdown": {
                  "content": "## ğŸš€ FlashPhoto å¼€å§‹éƒ¨ç½²\n> **åˆ†æ”¯**: ${{ github.ref_name }}\n> **æäº¤**: `${{ github.sha }}`\n> **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}\n> **è§¦å‘è€…**: ${{ github.actor }}\n> **æ—¶é—´**: '"$(date '+%Y-%m-%d %H:%M:%S')"'"
                }
              }'
          fi

  deploy:
    needs: notify-start
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed
        run: |
          # è·å–å˜åŒ–çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files: $CHANGED_FILES"
          # è½¬æ¢ä¸º JSON æ•°ç»„
          FILES_JSON=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "files=$FILES_JSON" >> $GITHUB_OUTPUT

      - name: Trigger Deploy via Webhook
        id: deploy
        run: |
          echo "è§¦å‘éƒ¨ç½² Webhook..."

          # ç”ŸæˆåŒ…å«æ–‡ä»¶å˜åŒ–çš„ payload
          PAYLOAD=$(cat <<EOF
          {
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "actor": "${{ github.actor }}",
            "commits": [{
              "added": [],
              "modified": ${{ steps.changed.outputs.files }},
              "removed": []
            }]
          }
          EOF
          )

          echo "Payload: $PAYLOAD"

          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" | sed 's/^.* //')

          # é‡è¯•é€»è¾‘ï¼šå¦‚æœéƒ¨ç½²æ­£åœ¨è¿›è¡Œä¸­ï¼ˆ409ï¼‰ï¼Œç­‰å¾…åé‡è¯•
          MAX_RETRIES=10
          RETRY_INTERVAL=30

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "å°è¯•è§¦å‘éƒ¨ç½² ($attempt/$MAX_RETRIES)..."

            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://${{ env.DOMAIN }}/webhook/deploy" \
              -H "Content-Type: application/json" \
              -H "X-Webhook-Signature: sha256=$SIGNATURE" \
              -d "$PAYLOAD" \
              --max-time 30)

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
            echo "å“åº”: $BODY"

            if [ "$HTTP_CODE" = "202" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "Webhook è§¦å‘æˆåŠŸ"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$HTTP_CODE" = "409" ]; then
              echo "éƒ¨ç½²æ­£åœ¨è¿›è¡Œä¸­ï¼Œç­‰å¾… ${RETRY_INTERVAL} ç§’åé‡è¯•..."
              sleep $RETRY_INTERVAL
            else
              echo "Webhook è§¦å‘å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          done

          echo "è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œéƒ¨ç½²å¤±è´¥"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Wait for Deployment
        run: |
          echo "ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
          sleep 120

      - name: Verify Deployment
        id: verify
        run: |
          echo "éªŒè¯éƒ¨ç½²çŠ¶æ€..."

          # æ£€æŸ¥å¥åº·çŠ¶æ€ï¼ˆå¢åŠ é‡è¯•æ¬¡æ•°å’Œé—´éš”ï¼‰
          for i in {1..10}; do
            echo "å°è¯• $i/10..."

            HEALTH=$(curl -sf "https://${{ env.DOMAIN }}/api/health" || echo "failed")

            if [ "$HEALTH" != "failed" ]; then
              echo "å¥åº·æ£€æŸ¥é€šè¿‡"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            sleep 15
          done

          echo "å¥åº·æ£€æŸ¥å¤±è´¥"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Check Deploy Logs on Failure
        if: failure()
        run: |
          echo "è·å–éƒ¨ç½²æ—¥å¿—..."
          curl -sf "https://${{ env.DOMAIN }}/webhook/logs" || echo "æ— æ³•è·å–æ—¥å¿—"

      - name: Notify Success
        if: success()
        run: |
          if [ -n "${{ secrets.WECHAT_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "msgtype": "markdown",
                "markdown": {
                  "content": "## âœ… FlashPhoto éƒ¨ç½²æˆåŠŸ\n> **åˆ†æ”¯**: ${{ github.ref_name }}\n> **æäº¤**: `${{ github.sha }}`\n> **è§¦å‘è€…**: ${{ github.actor }}\n> **è®¿é—®åœ°å€**: https://pop-pub.com"
                }
              }'
          fi

      - name: Notify Failure
        if: failure()
        run: |
          if [ -n "${{ secrets.WECHAT_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "msgtype": "markdown",
                "markdown": {
                  "content": "## âŒ FlashPhoto éƒ¨ç½²å¤±è´¥\n> **åˆ†æ”¯**: ${{ github.ref_name }}\n> **æäº¤**: `${{ github.sha }}`\n> **è§¦å‘è€…**: ${{ github.actor }}\n\n[æŸ¥çœ‹å®Œæ•´æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                }
              }'
          fi
