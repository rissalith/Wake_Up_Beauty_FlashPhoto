name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      skip_backup:
        description: '跳过部署前备份'
        required: false
        default: 'false'
        type: boolean

env:
  DOMAIN: pop-pub.com
  DEPLOY_PATH: /www/wwwroot/pop-pub.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Admin Frontend Dependencies
        working-directory: admin-server/admin-web
        run: npm ci

      - name: Build Admin Frontend
        working-directory: admin-server/admin-web
        run: npm run build

      - name: Pre-deploy Backup
        if: ${{ github.event.inputs.skip_backup != 'true' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            bash docker/deploy-optimized.sh backup || echo "备份跳过（可能是首次部署）"

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 30m
          script: |
            cd ${{ env.DEPLOY_PATH }}
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            bash docker/deploy-optimized.sh update

      - name: Verify Deployment
        id: verify
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "等待服务启动..."
            sleep 30

            # 在服务器本地检查健康状态
            NGINX_OK=$(curl -sfL "http://localhost/health" > /dev/null && echo "1" || echo "0")
            API_OK=$(curl -sfk "https://localhost/api/health" > /dev/null && echo "1" || echo "0")

            echo "健康检查结果: Nginx=$NGINX_OK, API=$API_OK"

            if [ "$NGINX_OK" = "1" ] && [ "$API_OK" = "1" ]; then
              echo "所有服务健康检查通过"
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              exit 0
            else
              echo "健康检查失败"
              echo "--- Docker 容器状态 ---"
              docker ps -a
              echo "--- Nginx 日志 ---"
              docker logs flashphoto-nginx --tail 30 2>&1 || echo "无法获取 Nginx 日志"
              echo "--- Core API 日志 ---"
              docker logs flashphoto-core-api --tail 30 2>&1 || echo "无法获取 Core API 日志"
              exit 1
            fi

      - name: Notify Success
        if: success()
        run: |
          if [ -n "${{ secrets.WECHAT_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "msgtype": "markdown",
                "markdown": {
                  "content": "## ✅ FlashPhoto 部署成功\n> **分支**: ${{ github.ref_name }}\n> **提交**: `${{ github.sha }}`\n> **触发者**: ${{ github.actor }}\n> **访问地址**: https://pop-pub.com"
                }
              }'
          fi

      - name: Notify Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 收集错误信息
            ERROR_INFO=$(docker ps -a --format "{{.Names}}: {{.Status}}" 2>&1 | head -10)
            NGINX_LOG=$(docker logs flashphoto-nginx --tail 10 2>&1 | tail -5 || echo "无日志")
            API_LOG=$(docker logs flashphoto-core-api --tail 10 2>&1 | tail -5 || echo "无日志")

            # 发送企业微信通知
            if [ -n "${{ secrets.WECHAT_WEBHOOK }}" ]; then
              curl -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
                -H "Content-Type: application/json" \
                -d "{
                  \"msgtype\": \"markdown\",
                  \"markdown\": {
                    \"content\": \"## ❌ FlashPhoto 部署失败\n> **分支**: ${{ github.ref_name }}\n> **提交**: \`${{ github.sha }}\`\n> **触发者**: ${{ github.actor }}\n\n**容器状态**:\n\`\`\`\n${ERROR_INFO}\n\`\`\`\n\n**Nginx 日志**:\n\`\`\`\n${NGINX_LOG}\n\`\`\`\n\n**API 日志**:\n\`\`\`\n${API_LOG}\n\`\`\`\n\n[查看完整日志](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\"
                  }
                }"
            fi

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            echo "部署失败，尝试回滚..."
            bash docker/deploy-optimized.sh rollback || echo "回滚失败或无备份可用"
