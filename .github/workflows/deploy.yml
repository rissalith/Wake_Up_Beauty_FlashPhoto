name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      skip_backup:
        description: '跳过部署前备份'
        required: false
        default: 'false'
        type: boolean

env:
  DOMAIN: pop-pub.com
  DEPLOY_PATH: /www/wwwroot/pop-pub.com

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Admin Frontend Dependencies
        working-directory: admin-server/admin-web
        run: npm ci

      - name: Build Admin Frontend
        working-directory: admin-server/admin-web
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: admin-frontend
          path: admin-server/admin-web/dist
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Deploy via Webhook
        id: deploy
        run: |
          echo "触发部署 Webhook..."

          # 生成签名
          PAYLOAD='{"branch":"${{ github.ref_name }}","commit":"${{ github.sha }}","actor":"${{ github.actor }}"}'
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" | sed 's/^.* //')

          # 发送请求
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://${{ env.DOMAIN }}/webhook/deploy" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Signature: sha256=$SIGNATURE" \
            -d "$PAYLOAD" \
            --max-time 30)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP 状态码: $HTTP_CODE"
          echo "响应: $BODY"

          if [ "$HTTP_CODE" = "202" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "Webhook 触发成功"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "Webhook 触发失败"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Wait for Deployment
        run: |
          echo "等待部署完成..."
          sleep 60

      - name: Verify Deployment
        id: verify
        run: |
          echo "验证部署状态..."

          # 检查健康状态
          for i in {1..5}; do
            echo "尝试 $i/5..."

            HEALTH=$(curl -sf "https://${{ env.DOMAIN }}/api/health" || echo "failed")

            if [ "$HEALTH" != "failed" ]; then
              echo "健康检查通过"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            sleep 10
          done

          echo "健康检查失败"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Check Deploy Logs on Failure
        if: failure()
        run: |
          echo "获取部署日志..."
          curl -sf "https://${{ env.DOMAIN }}/webhook/logs" || echo "无法获取日志"

      - name: Notify Success
        if: success()
        run: |
          if [ -n "${{ secrets.WECHAT_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "msgtype": "markdown",
                "markdown": {
                  "content": "## ✅ FlashPhoto 部署成功\n> **分支**: ${{ github.ref_name }}\n> **提交**: `${{ github.sha }}`\n> **触发者**: ${{ github.actor }}\n> **访问地址**: https://pop-pub.com"
                }
              }'
          fi

      - name: Notify Failure
        if: failure()
        run: |
          if [ -n "${{ secrets.WECHAT_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "msgtype": "markdown",
                "markdown": {
                  "content": "## ❌ FlashPhoto 部署失败\n> **分支**: ${{ github.ref_name }}\n> **提交**: `${{ github.sha }}`\n> **触发者**: ${{ github.actor }}\n\n[查看完整日志](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                }
              }'
          fi
