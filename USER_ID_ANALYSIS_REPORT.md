# ç”¨æˆ·IDä½“ç³»åˆ†ææŠ¥å‘Šä¸ä¼˜åŒ–è®¡åˆ’

## ä¸€ã€å½“å‰IDä½“ç³»æ¦‚è§ˆ

### 1.1 æ¶‰åŠçš„IDç±»å‹

| IDç±»å‹ | æ¥æº | ç”¨é€” | å”¯ä¸€æ€§èŒƒå›´ |
|--------|------|------|------------|
| `openid` | å¾®ä¿¡ç™»å½• | å•ä¸ªå°ç¨‹åºå†…ç”¨æˆ·æ ‡è¯† | å•ä¸ªå°ç¨‹åº |
| `unionid` | å¾®ä¿¡å¼€æ”¾å¹³å° | è·¨å°ç¨‹åº/å…¬ä¼—å·ç”¨æˆ·æ ‡è¯† | å¼€æ”¾å¹³å°è´¦å·ä¸‹æ‰€æœ‰åº”ç”¨ |
| `userId` (å†…éƒ¨ID) | ç³»ç»Ÿç”Ÿæˆ (UUID) | æ•°æ®åº“ä¸»é”®ã€ä¸šåŠ¡å…³è” | å…¨å±€å”¯ä¸€ |
| `session_key` | å¾®ä¿¡ç™»å½• | ä¼šè¯å¯†é’¥ã€ç­¾åéªŒè¯ | ä¸´æ—¶æœ‰æ•ˆ |

### 1.2 å½“å‰æ¶æ„ä¸­çš„IDä½¿ç”¨æƒ…å†µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å°ç¨‹åºç«¯ (miniprogram)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æœ¬åœ°å­˜å‚¨: userId, openid, unionid, session_key, userInfo â”‚   â”‚
â”‚  â”‚ å…¨å±€æ•°æ®: globalData.userId, globalData.unionid          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœåŠ¡ç«¯ (å¤šæœåŠ¡)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   server/    â”‚  â”‚ admin-server â”‚  â”‚   core-api   â”‚          â”‚
â”‚  â”‚  (ä¸»API)     â”‚  â”‚  (åå°ç®¡ç†)   â”‚  â”‚  (æ ¸å¿ƒAPI)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                 â”‚                 â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              å…±äº«æ•°æ®åº“ (flashphoto.db)                   â”‚   â”‚
â”‚  â”‚  usersè¡¨: id(ä¸»é”®), user_id, openid, unionid             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å‘ç°çš„é—®é¢˜

### 2.1 ğŸ”´ ä¸¥é‡é—®é¢˜

#### é—®é¢˜1: æ•°æ®åº“å­—æ®µå‘½åä¸ä¸€è‡´
**ä½ç½®**: [`admin-server/server/config/database.js:53-66`](admin-server/server/config/database.js:53)

```sql
-- å½“å‰å®šä¹‰
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id VARCHAR(50) UNIQUE NOT NULL,    -- ä¸šåŠ¡ID
  unionid VARCHAR(100) UNIQUE NOT NULL,   -- å¼ºåˆ¶è¦æ±‚unionid
  openid VARCHAR(100) NOT NULL,
  ...
)
```

**é—®é¢˜**:
- `id` æ˜¯è‡ªå¢ä¸»é”®ï¼Œ`user_id` æ˜¯ä¸šåŠ¡IDï¼Œå®¹æ˜“æ··æ·†
- `unionid` è®¾ä¸º `UNIQUE NOT NULL`ï¼Œä½†å°ç¨‹åºæœªç»‘å®šå¼€æ”¾å¹³å°æ—¶æ— æ³•è·å–unionid
- ä¸åŒæœåŠ¡ä½¿ç”¨ä¸åŒå­—æ®µåæŸ¥è¯¢ç”¨æˆ·

#### é—®é¢˜2: ç”¨æˆ·æŸ¥æ‰¾é€»è¾‘ä¸ç»Ÿä¸€
**ä½ç½®**: å¤šä¸ªæ–‡ä»¶

| æ–‡ä»¶ | æŸ¥æ‰¾é€»è¾‘ |
|------|----------|
| [`server/routes/user.js:104-109`](server/routes/user.js:104) | å…ˆunionidåopenid |
| [`admin-server/server/routes/users.js:57-72`](admin-server/server/routes/users.js:57) | å…ˆunionidåopenidï¼Œä½†ä½¿ç”¨ä¸åŒå­—æ®µ |
| [`core-api/routes/miniprogram/user.js:105`](core-api/routes/miniprogram/user.js:105) | **ä»…ç”¨unionid**ï¼Œæ— openidå›é€€ |

**é£é™©**: 
- core-apiå¼ºåˆ¶è¦æ±‚unionidï¼Œæœªç»‘å®šå¼€æ”¾å¹³å°çš„å°ç¨‹åºæ— æ³•ä½¿ç”¨
- åŒä¸€ç”¨æˆ·å¯èƒ½åœ¨ä¸åŒæœåŠ¡ä¸­è¢«è¯†åˆ«ä¸ºä¸åŒç”¨æˆ·

#### é—®é¢˜3: userIdç”Ÿæˆæ–¹å¼ä¸ä¸€è‡´
| æœåŠ¡ | ç”Ÿæˆæ–¹å¼ | ç¤ºä¾‹ |
|------|----------|------|
| server | `uuidv4()` | `550e8400-e29b-41d4-a716-446655440000` |
| admin-server | `'u_' + Date.now() + '_' + random` | `u_1705123456789_abc123` |
| core-api | `uuidv4()` | `550e8400-e29b-41d4-a716-446655440000` |

**é£é™©**: åŒä¸€ç”¨æˆ·åœ¨ä¸åŒæœåŠ¡æ³¨å†Œä¼šäº§ç”Ÿä¸åŒçš„userId

### 2.2 ğŸŸ¡ ä¸­ç­‰é—®é¢˜

#### é—®é¢˜4: æ”¯ä»˜åœºæ™¯IDä¼ é€’æ··ä¹±
**ä½ç½®**: [`admin-server/server/routes/pay.js:80-81`](admin-server/server/routes/pay.js:80)

```javascript
// åˆ›å»ºæ”¯ä»˜è®¢å•
router.post('/create-order', async (req, res) => {
  const { userId, openid, amount, points, description } = req.body;
  // ...
  payer: {
    openid: openid || userId  // âš ï¸ å°†userIdå½“ä½œopenidä½¿ç”¨
  }
```

**é—®é¢˜**: å¾®ä¿¡æ”¯ä»˜APIçš„payer.openidå¿…é¡»æ˜¯çœŸå®çš„openidï¼Œä¸èƒ½ç”¨userIdæ›¿ä»£

#### é—®é¢˜5: è™šæ‹Ÿæ”¯ä»˜session_keyç®¡ç†
**ä½ç½®**: [`admin-server/server/routes/virtual-pay.js:26-39`](admin-server/server/routes/virtual-pay.js:26)

```javascript
// ä¼˜å…ˆä½¿ç”¨å‰ç«¯ä¼ æ¥çš„ sessionKeyï¼Œå¦åˆ™ä»æ•°æ®åº“è·å–
let sessionKey = clientSessionKey;
if (!sessionKey) {
  let user = getOne('SELECT session_key FROM users WHERE id = ?', [userId]);
  // ...
}
```

**é—®é¢˜**: 
- session_keyå­˜å‚¨åœ¨æ•°æ®åº“ä¸­å­˜åœ¨å®‰å…¨é£é™©
- å‰ç«¯ä¼ é€’session_keyä¸å®‰å…¨

#### é—®é¢˜6: å°ç¨‹åºç«¯IDå›é€€é€»è¾‘
**ä½ç½®**: [`miniprogram/app.js:139-149`](miniprogram/app.js:139)

```javascript
// å…¼å®¹ï¼šå¦‚æœæ²¡æœ‰ç‹¬ç«‹çš„userIdï¼Œå°è¯•ä»userInfoæˆ–openidæ¢å¤
if (!userId && userInfo && userInfo.userId) {
  userId = userInfo.userId;
}
if (!userId) {
  const openid = wx.getStorageSync('openid');
  if (openid) {
    userId = openid;  // âš ï¸ å°†openidå½“ä½œuserIdä½¿ç”¨
  }
}
```

**é—®é¢˜**: å°†openidå½“ä½œuserIdä½¿ç”¨ä¼šå¯¼è‡´æ•°æ®å…³è”æ··ä¹±

### 2.3 ğŸŸ¢ è½»å¾®é—®é¢˜

#### é—®é¢˜7: åå°ç®¡ç†å‘˜IDä¸ç”¨æˆ·IDæ··ç”¨
**ä½ç½®**: [`admin-server/server/routes/auth.js`](admin-server/server/routes/auth.js)

åå°ç®¡ç†å‘˜ä½¿ç”¨ç‹¬ç«‹çš„adminsè¡¨ï¼ŒIDä½“ç³»æ¸…æ™°ï¼Œä½†JWT payloadä¸­çš„å­—æ®µå‘½åå¯ä¼˜åŒ–ã€‚

#### é—®é¢˜8: åè®®ç­¾ç½²çŠ¶æ€å­˜å‚¨ä½ç½®ä¸ä¸€è‡´
- server: å­˜å‚¨åœ¨usersè¡¨çš„ `privacy_agreed`, `terms_agreed` å­—æ®µ
- admin-server: å­˜å‚¨åœ¨ç‹¬ç«‹çš„ `user_agreements` è¡¨

---

## ä¸‰ã€è·¨å°ç¨‹åºå…±ç”¨åœºæ™¯åˆ†æ

### 3.1 å½“å‰è®¾è®¡æ„å›¾
ä»ä»£ç æ³¨é‡Šå’Œæ¶æ„å¯ä»¥çœ‹å‡ºï¼Œé¡¹ç›®è®¾è®¡äº†unionidä½œä¸º"çŸ©é˜µäº§å“æ ¸å¿ƒæ ‡è¯†"ï¼š

```javascript
// miniprogram/app.js:612
globalData: {
  userId: null,       // å½“å‰ç”¨æˆ·IDï¼ˆå†…éƒ¨ä¸»é”®ï¼‰
  unionid: null,      // ç”¨æˆ·UnionIDï¼ˆçŸ©é˜µäº§å“æ ¸å¿ƒæ ‡è¯†ï¼‰
}
```

### 3.2 å­˜åœ¨çš„é—®é¢˜

1. **unionidè·å–ä¾èµ–å¼€æ”¾å¹³å°ç»‘å®š**
   - å°ç¨‹åºå¿…é¡»ç»‘å®šåˆ°å¾®ä¿¡å¼€æ”¾å¹³å°æ‰èƒ½è·å–unionid
   - æœªç»‘å®šæ—¶ï¼Œè·¨å°ç¨‹åºç”¨æˆ·è¯†åˆ«æ— æ³•å®ç°

2. **openidä½œä¸ºå›é€€æ–¹æ¡ˆçš„å±€é™æ€§**
   - openidä»…åœ¨å•ä¸ªå°ç¨‹åºå†…å”¯ä¸€
   - ä¸åŒå°ç¨‹åºçš„openidä¸åŒï¼Œæ— æ³•å…³è”

3. **æ•°æ®åº“è®¾è®¡ä¸æ”¯æŒå¤šopenid**
   - å½“å‰usersè¡¨åªæœ‰ä¸€ä¸ªopenidå­—æ®µ
   - æ— æ³•å­˜å‚¨åŒä¸€ç”¨æˆ·åœ¨ä¸åŒå°ç¨‹åºçš„openid

---

## å››ã€ä¼˜åŒ–è®¡åˆ’

### é˜¶æ®µä¸€ï¼šç´§æ€¥ä¿®å¤ï¼ˆ1-2å¤©ï¼‰

#### 1.1 ç»Ÿä¸€ç”¨æˆ·æŸ¥æ‰¾é€»è¾‘
åˆ›å»ºç»Ÿä¸€çš„ç”¨æˆ·æŸ¥æ‰¾å‡½æ•°ï¼Œæ‰€æœ‰æœåŠ¡å…±ç”¨ï¼š

```javascript
// shared/utils/userHelper.js
function findUser(db, identifier) {
  // 1. å°è¯•ç”¨å†…éƒ¨userIdæŸ¥æ‰¾
  let user = db.prepare('SELECT * FROM users WHERE id = ?').get(identifier);
  if (user) return user;
  
  // 2. å°è¯•ç”¨unionidæŸ¥æ‰¾
  user = db.prepare('SELECT * FROM users WHERE unionid = ?').get(identifier);
  if (user) return user;
  
  // 3. å°è¯•ç”¨openidæŸ¥æ‰¾
  user = db.prepare('SELECT * FROM users WHERE openid = ?').get(identifier);
  return user;
}
```

#### 1.2 ä¿®å¤æ”¯ä»˜æ¥å£çš„openidä¼ é€’
```javascript
// admin-server/server/routes/pay.js
router.post('/create-order', async (req, res) => {
  const { userId, openid, amount, points } = req.body;
  
  // ç¡®ä¿æœ‰æœ‰æ•ˆçš„openid
  let payerOpenid = openid;
  if (!payerOpenid) {
    const user = findUser(db, userId);
    payerOpenid = user?.openid;
  }
  
  if (!payerOpenid) {
    return res.status(400).json({ code: 400, message: 'ç¼ºå°‘æœ‰æ•ˆçš„openid' });
  }
  // ...
});
```

#### 1.3 ç§»é™¤å°ç¨‹åºç«¯çš„openidå›é€€é€»è¾‘
```javascript
// miniprogram/app.js - ä¿®æ”¹silentLogin
if (!userId) {
  // ä¸å†å°†openidå½“ä½œuserIdä½¿ç”¨
  // è€Œæ˜¯æç¤ºç”¨æˆ·é‡æ–°ç™»å½•
  return false;
}
```

### é˜¶æ®µäºŒï¼šæ¶æ„ä¼˜åŒ–ï¼ˆ3-5å¤©ï¼‰

#### 2.1 æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ–

```sql
-- æ–°å¢ç”¨æˆ·ç»‘å®šè¡¨ï¼Œæ”¯æŒå¤šå°ç¨‹åº
CREATE TABLE user_bindings (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,           -- å…³è”users.id
  app_id TEXT NOT NULL,            -- å°ç¨‹åºAppID
  openid TEXT NOT NULL,            -- è¯¥å°ç¨‹åºçš„openid
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(app_id, openid)
);

-- ä¿®æ”¹usersè¡¨
ALTER TABLE users ADD COLUMN primary_openid TEXT;  -- ä¸»openidï¼ˆé¦–æ¬¡æ³¨å†Œçš„å°ç¨‹åºï¼‰
-- unionidæ”¹ä¸ºå¯ç©º
-- ALTER TABLE users MODIFY unionid VARCHAR(100) NULL;
```

#### 2.2 ç»Ÿä¸€userIdç”Ÿæˆç­–ç•¥
æ‰€æœ‰æœåŠ¡ä½¿ç”¨ç›¸åŒçš„UUID v4ç”Ÿæˆç­–ç•¥ï¼š

```javascript
// shared/utils/idGenerator.js
const { v4: uuidv4 } = require('uuid');

function generateUserId() {
  return uuidv4();
}

function generateOrderId(prefix = 'ORD') {
  return prefix + Date.now().toString(36).toUpperCase() + 
         Math.random().toString(36).substr(2, 6).toUpperCase();
}
```

#### 2.3 session_keyå®‰å…¨å¤„ç†
```javascript
// ä¸åœ¨æ•°æ®åº“ä¸­å­˜å‚¨session_key
// æ”¹ä¸ºä½¿ç”¨Rediså­˜å‚¨ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
const redis = require('redis');

async function storeSessionKey(userId, sessionKey) {
  await redis.setex(`session:${userId}`, 7200, sessionKey); // 2å°æ—¶è¿‡æœŸ
}

async function getSessionKey(userId) {
  return await redis.get(`session:${userId}`);
}
```

### é˜¶æ®µä¸‰ï¼šé•¿æœŸè§„åˆ’ï¼ˆ1-2å‘¨ï¼‰

#### 3.1 å®ç°å®Œæ•´çš„è·¨å°ç¨‹åºç”¨æˆ·ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·ä¸­å¿ƒæœåŠ¡ (User Center)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  usersè¡¨: id(UUID), unionid(å¯ç©º), nickname, avatar...   â”‚   â”‚
â”‚  â”‚  user_bindingsè¡¨: user_id, app_id, openid               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å°ç¨‹åºA  â”‚        â”‚ å°ç¨‹åºB  â”‚        â”‚ å…¬ä¼—å·   â”‚
    â”‚ openid_a â”‚        â”‚ openid_b â”‚        â”‚ openid_c â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2 ç”¨æˆ·ç™»å½•æµç¨‹ä¼˜åŒ–

```
1. å°ç¨‹åºè°ƒç”¨wx.loginè·å–code
2. åç«¯ç”¨codeæ¢å–openidå’Œunionid
3. æŸ¥æ‰¾ç”¨æˆ·:
   a. æœ‰unionid â†’ ç”¨unionidæŸ¥æ‰¾
   b. æ— unionid â†’ ç”¨(app_id + openid)åœ¨user_bindingsä¸­æŸ¥æ‰¾
4. ç”¨æˆ·ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ç”¨æˆ· + ç»‘å®šè®°å½•
5. ç”¨æˆ·å­˜åœ¨ â†’ æ›´æ–°ç»‘å®šè®°å½•ï¼ˆå¦‚æœæ˜¯æ–°å°ç¨‹åºï¼‰
6. è¿”å›ç»Ÿä¸€çš„userIdç»™å‰ç«¯
```

#### 3.3 APIæ¥å£è§„èŒƒåŒ–

| æ¥å£ | å¿…éœ€å‚æ•° | å¯é€‰å‚æ•° |
|------|----------|----------|
| ç”¨æˆ·ç›¸å…³ | userId | - |
| æ”¯ä»˜ç›¸å…³ | userId, openid | - |
| è™šæ‹Ÿæ”¯ä»˜ | userId, openid, sessionKey | - |

---

## äº”ã€å®æ–½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | å½±å“èŒƒå›´ |
|--------|------|----------|----------|
| P0 | ä¿®å¤æ”¯ä»˜æ¥å£openidä¼ é€’ | 2h | æ”¯ä»˜åŠŸèƒ½ |
| P0 | ç»Ÿä¸€ç”¨æˆ·æŸ¥æ‰¾é€»è¾‘ | 4h | å…¨éƒ¨æœåŠ¡ |
| P1 | ç§»é™¤openidå›é€€é€»è¾‘ | 2h | å°ç¨‹åºç«¯ |
| P1 | ç»Ÿä¸€userIdç”Ÿæˆç­–ç•¥ | 2h | æ–°ç”¨æˆ·æ³¨å†Œ |
| P2 | æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ– | 8h | éœ€è¦æ•°æ®è¿ç§» |
| P2 | session_keyå®‰å…¨å¤„ç† | 4h | è™šæ‹Ÿæ”¯ä»˜ |
| P3 | è·¨å°ç¨‹åºç”¨æˆ·ä½“ç³» | 16h | æ–°åŠŸèƒ½ |

---

## å…­ã€æµ‹è¯•æ£€æŸ¥æ¸…å•

### 6.1 ç™»å½•åœºæ™¯
- [ ] æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•ï¼ˆæœ‰unionidï¼‰
- [ ] æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•ï¼ˆæ— unionidï¼‰
- [ ] è€ç”¨æˆ·ç™»å½•ï¼ˆæœ‰unionidï¼‰
- [ ] è€ç”¨æˆ·ç™»å½•ï¼ˆæ— unionidï¼Œä»…openidï¼‰
- [ ] è·¨è®¾å¤‡ç™»å½•

### 6.2 æ”¯ä»˜åœºæ™¯
- [ ] Androidæ ‡å‡†å¾®ä¿¡æ”¯ä»˜
- [ ] iOSè™šæ‹Ÿæ”¯ä»˜
- [ ] æ”¯ä»˜å›è°ƒå¤„ç†
- [ ] è®¢å•çŠ¶æ€æŸ¥è¯¢

### 6.3 åå°ç®¡ç†
- [ ] ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢
- [ ] ç”¨æˆ·è¯¦æƒ…æŸ¥çœ‹
- [ ] é†’å¸è°ƒæ•´
- [ ] è®¢å•ç®¡ç†

### 6.4 è·¨å°ç¨‹åºï¼ˆæœªæ¥ï¼‰
- [ ] åŒä¸€ç”¨æˆ·åœ¨ä¸åŒå°ç¨‹åºç™»å½•
- [ ] æ•°æ®åŒæ­¥
- [ ] é†’å¸å…±äº«

---

## ä¸ƒã€æ€»ç»“

å½“å‰é¡¹ç›®çš„ç”¨æˆ·IDä½“ç³»å­˜åœ¨ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š

1. **IDå‘½åå’Œä½¿ç”¨ä¸ä¸€è‡´** - ä¸åŒæœåŠ¡å¯¹åŒä¸€æ¦‚å¿µä½¿ç”¨ä¸åŒå­—æ®µå
2. **unionidä¾èµ–è¿‡å¼º** - æœªè€ƒè™‘å°ç¨‹åºæœªç»‘å®šå¼€æ”¾å¹³å°çš„æƒ…å†µ
3. **å›é€€é€»è¾‘æœ‰é£é™©** - å°†openidå½“ä½œuserIdä½¿ç”¨ä¼šå¯¼è‡´æ•°æ®æ··ä¹±
4. **æ”¯ä»˜æ¥å£å‚æ•°é”™è¯¯** - å¯èƒ½å¯¼è‡´æ”¯ä»˜å¤±è´¥

å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥ä¿®å¤ï¼Œå…ˆè§£å†³P0çº§åˆ«çš„ç´§æ€¥é—®é¢˜ï¼Œå†è¿›è¡Œæ¶æ„ä¼˜åŒ–ã€‚
