<!--é€šç”¨åœºæ™¯é¡µé¢ - åŒæ å¸ƒå±€é‡æ„ç‰ˆ-->
<wxs src="../../utils/i18n.wxs" module="i18n" />

<view class="scene-page">
  <!-- åŠ è½½ä¸­ -->
  <view class="loading-container" wx:if="{{configLoading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">{{lang.loading || 'åŠ è½½ä¸­...'}}</text>
  </view>

  <!-- ä¸»å†…å®¹ -->
  <scroll-view class="main-content" scroll-y wx:else>
    <!-- é¡¶éƒ¨æé†’ -->
    <view class="top-notice {{showTopNotice ? 'show' : ''}}" wx:if="{{showTopNotice}}">
      <text>{{topNoticeText}}</text>
    </view>

    <!-- æ‚¬æµ®è¿›åº¦æ¡ç»„ä»¶ -->
    <floating-progress
      topOffset="16"
      showReassurance="{{true}}"
    />

    <!-- åŒæ å¸ƒå±€å®¹å™¨ -->
    <view class="dual-column-layout">
      <!-- å·¦ä¾§ï¼šåˆ›ä½œè€…å‚è€ƒå›¾ -->
      <view class="left-column">
        <view class="reference-section">
          <view class="section-header">
            <text class="section-title">{{i18n.text('æ•ˆæœå‚è€ƒ', 'Reference', currentLang)}}</text>
          </view>
          <!-- ä¸»å‚è€ƒå›¾ -->
          <view class="reference-main-image" bindtap="previewReferenceImage">
            <image
              class="reference-image"
              src="{{referenceImage || sceneConfig.cover_image || sceneConfig.icon}}"
              mode="aspectFill"
              lazy-load="{{true}}"
            />
            <view class="reference-badge">
              <image class="badge-icon" src="/images/icon-ai-spark.svg" mode="aspectFit" />
              <text class="badge-text">AI</text>
            </view>
          </view>
          <!-- å¤šå‚è€ƒå›¾åˆ—è¡¨ï¼ˆå¦‚æœæœ‰ï¼‰ -->
          <scroll-view class="reference-list" scroll-x wx:if="{{referenceImages && referenceImages.length > 1}}">
            <view class="reference-thumb-list">
              <view
                class="reference-thumb {{currentRefIndex === index ? 'active' : ''}}"
                wx:for="{{referenceImages}}"
                wx:key="index"
                bindtap="selectReferenceImage"
                data-index="{{index}}"
              >
                <image class="thumb-image" src="{{item.image_url}}" mode="aspectFill" />
              </view>
            </view>
          </scroll-view>
          <!-- å‚è€ƒå›¾è¯´æ˜ -->
          <view class="reference-info" wx:if="{{sceneConfig.description}}">
            <text class="reference-desc">{{i18n.getName(sceneConfig, currentLang) || sceneConfig.description}}</text>
          </view>
        </view>
      </view>

      <!-- å³ä¾§ï¼šç”¨æˆ·ä¸Šä¼ åŒº + æµç¨‹ç»„ä»¶ -->
      <view class="right-column">
        <!-- ç”¨æˆ·ä¸Šä¼ åŒº -->
        <view class="user-upload-section">
          <view class="section-header">
            <text class="section-title">{{i18n.text('ä¸Šä¼ ç…§ç‰‡', 'Upload Photos', currentLang)}}</text>
            <text class="upload-count">{{uploadedImages.length}}/{{userImageConfig.max_count || 3}}</text>
          </view>
          <view class="upload-slots">
            <!-- å·²ä¸Šä¼ çš„å›¾ç‰‡ -->
            <view
              class="upload-slot filled"
              wx:for="{{uploadedImages}}"
              wx:key="index"
            >
              <image class="slot-image" src="{{item.path}}" mode="aspectFill" />
              <view class="slot-delete" catchtap="deleteImage" data-index="{{index}}">
                <image class="delete-icon" src="/images/icon-close.svg" mode="aspectFit" />
              </view>
              <!-- æ§½ä½æ ‡é¢˜ -->
              <view class="slot-label" wx:if="{{userImageConfig.slots[index].title}}">
                <text>{{i18n.text(userImageConfig.slots[index].title, userImageConfig.slots[index].title_en, currentLang)}}</text>
              </view>
            </view>
            <!-- ä¸Šä¼ ä¸­çŠ¶æ€ -->
            <view class="upload-slot uploading" wx:if="{{uploading}}">
              <view class="upload-progress-wrap">
                <view class="upload-spinner"></view>
                <text class="upload-progress-text">{{uploadProgress || 0}}%</text>
              </view>
            </view>
            <!-- ç©ºæ§½ä½ï¼ˆå¯æ·»åŠ ï¼‰ -->
            <block wx:for="{{emptySlots}}" wx:key="index">
              <view
                class="upload-slot empty {{item.required ? 'required' : ''}}"
                bindtap="chooseImageForSlot"
                data-slot-index="{{uploadedImages.length + index}}"
                wx:if="{{!uploading || index > 0}}"
              >
                <view class="slot-add-icon">
                  <image src="/images/icon-add.svg" mode="aspectFit" />
                </view>
                <text class="slot-title">{{i18n.text(item.title, item.title_en, currentLang) || i18n.text('æ·»åŠ ç…§ç‰‡', 'Add Photo', currentLang)}}</text>
                <text class="slot-hint" wx:if="{{item.description}}">{{i18n.text(item.description, item.description_en, currentLang)}}</text>
                <view class="required-badge" wx:if="{{item.required}}">
                  <text>{{i18n.text('å¿…å¡«', 'Required', currentLang)}}</text>
                </view>
              </view>
            </block>
          </view>
          <view class="upload-tips">{{i18n.text('å»ºè®®ä¸Šä¼ æ¸…æ™°çš„æ­£é¢ç…§ç‰‡', 'Please upload clear front-facing photos', currentLang)}}</view>
        </view>

        <!-- æµç¨‹ç»„ä»¶åŒº -->
        <view class="flow-components-section">
          <block wx:for="{{steps}}" wx:key="step_key">
            <!-- è·³è¿‡å›¾ç‰‡ä¸Šä¼ ç±»å‹ -->
            <block wx:if="{{item.component_type !== 'image_upload'}}">
              <!-- æ‘‡éª°å­ç»„ä»¶ä¸éœ€è¦ optionsï¼Œå•ç‹¬å¤„ç† -->
              <view class="config-section" wx:if="{{item.component_type === 'random_dice' || (stepOptions[item.step_key] && stepOptions[item.step_key].length > 0)}}">
                <view class="section-header">
                  <image class="step-icon" wx:if="{{item.icon}}" src="{{item.icon}}" mode="aspectFit" />
                  <text class="section-title">{{item.title}}</text>
                  <!-- éª°å­æ­¥éª¤æ˜¾ç¤ºé—®å·å›¾æ ‡ -->
                  <view class="title-help-icon" wx:if="{{item.component_type === 'random_dice'}}" catchtap="onShowDiceRules" data-step-key="{{item.step_key}}" data-draw-type="{{item.config.poolType || 'phrase'}}">?</view>
                </view>

                <!-- æ€§åˆ«é€‰æ‹© (gender_select) -->
                <view class="gender-options" wx:if="{{item.component_type === 'gender_select'}}">
                  <view
                    class="gender-item male {{selections[item.step_key] === 'male' ? 'active' : ''}}"
                    bindtap="selectOption"
                    data-key="{{item.step_key}}"
                    data-id="male"
                  >
                    <view class="gender-icon-wrapper">
                      <view class="gender-icon-male"></view>
                    </view>
                    <text class="gender-text">{{lang.fp_male || 'ç”·'}}</text>
                  </view>
                  <view
                    class="gender-item female {{selections[item.step_key] === 'female' ? 'active' : ''}}"
                    bindtap="selectOption"
                    data-key="{{item.step_key}}"
                    data-id="female"
                  >
                    <view class="gender-icon-wrapper">
                      <view class="gender-icon-female"></view>
                    </view>
                    <text class="gender-text">{{lang.fp_female || 'å¥³'}}</text>
                  </view>
                </view>

                <!-- å•é€‰æ¡†/æ€§åˆ«é€‰æ‹© (radio) -->
                <view class="radio-options" wx:if="{{item.component_type === 'radio'}}">
                  <view
                    class="radio-item {{selections[item.step_key] === opt.id ? 'active' : ''}}"
                    wx:for="{{stepOptions[item.step_key]}}"
                    wx:for-item="opt"
                    wx:key="id"
                    bindtap="selectOption"
                    data-key="{{item.step_key}}"
                    data-id="{{opt.id}}"
                  >
                    <text>{{opt.name}}</text>
                  </view>
                </view>

                <!-- æ ‡ç­¾é€‰æ‹©ï¼ˆæ–‡å­—ï¼‰ -->
                <view class="tag-options" wx:if="{{item.component_type === 'tags'}}">
                  <view
                    class="tag-item {{selections[item.step_key] === opt.id ? 'active' : ''}}"
                    wx:for="{{stepOptions[item.step_key]}}"
                    wx:for-item="opt"
                    wx:key="id"
                    bindtap="selectOption"
                    data-key="{{item.step_key}}"
                    data-id="{{opt.id}}"
                  >
                    <text>{{opt.name}}</text>
                  </view>
                </view>

                <!-- è§„æ ¼é€‰æ‹© -->
                <view class="tag-options" wx:if="{{item.component_type === 'spec_select'}}">
                  <view
                    class="tag-item {{selections[item.step_key] === opt.id ? 'active' : ''}}"
                    wx:for="{{stepOptions[item.step_key]}}"
                    wx:for-item="opt"
                    wx:key="id"
                    bindtap="selectOption"
                    data-key="{{item.step_key}}"
                    data-id="{{opt.id}}"
                  >
                    <text>{{opt.name}}</text>
                  </view>
                </view>

                <!-- é¢œè‰²é€‰æ‹©å™¨ -->
                <view class="color-options" wx:if="{{item.component_type === 'color_picker'}}">
                  <view
                    class="color-item {{selections[item.step_key] === opt.id ? 'active' : ''}}"
                    wx:for="{{stepOptions[item.step_key]}}"
                    wx:for-item="opt"
                    wx:key="id"
                    bindtap="selectOption"
                    data-key="{{item.step_key}}"
                    data-id="{{opt.id}}"
                  >
                    <view class="color-circle" style="background-color: {{opt.color || '#ffffff'}};"></view>
                    <text class="color-name">{{opt.name}}</text>
                  </view>
                </view>

                <!-- å›¾ç‰‡æ ‡ç­¾é€‰æ‹© -->
                <scroll-view class="image-tag-scroll" scroll-x wx:if="{{item.component_type === 'image_tags'}}">
                  <view class="image-tag-options">
                    <view
                      class="image-tag-item {{selections[item.step_key] === opt.id ? 'active' : ''}}"
                      wx:for="{{stepOptions[item.step_key]}}"
                      wx:for-item="opt"
                      wx:key="id"
                      bindtap="selectOption"
                      data-key="{{item.step_key}}"
                      data-id="{{opt.id}}"
                    >
                      <view class="tag-image-wrapper">
                        <image
                          src="{{opt.image}}"
                          mode="aspectFill"
                          class="tag-image"
                          wx:if="{{opt.image}}"
                          catchtap="previewTagImage"
                          data-url="{{opt.image}}"
                          data-name="{{opt.name}}"
                        />
                        <view class="tag-placeholder" wx:else>
                          <text>{{opt.name}}</text>
                        </view>
                      </view>
                      <text class="tag-name">{{opt.name}}</text>
                      <view class="select-indicator {{selections[item.step_key] === opt.id ? 'selected' : ''}}">
                        <view class="indicator-dot" wx:if="{{selections[item.step_key] === opt.id}}"></view>
                      </view>
                    </view>
                  </view>
                </scroll-view>

                <!-- æ»‘å— -->
                <view class="slider-wrapper" wx:if="{{item.component_type === 'slider'}}">
                  <slider
                    value="{{selections[item.step_key]}}"
                    min="{{item.min || 0}}"
                    max="{{item.max || 100}}"
                    step="{{item.step || 1}}"
                    show-value
                    activeColor="#ff6b35"
                    bindchange="onSliderChange"
                    data-key="{{item.step_key}}"
                  />
                </view>

                <!-- æ‘‡éª°å­ç»„ä»¶ (random_dice) -->
                <dice-roller
                  wx:if="{{item.component_type === 'random_dice'}}"
                  scene-id="{{sceneId}}"
                  step-key="{{item.step_key}}"
                  draw-type="{{item.config.poolType || 'phrase'}}"
                  result="{{diceSteps[item.step_key].result}}"
                  is-rolling="{{diceSteps[item.step_key].isRolling}}"
                  free-count="{{diceSteps[item.step_key].freeCount}}"
                  confirmed="{{diceSteps[item.step_key].confirmed}}"
                  cost-per-roll="{{item.config.costPerRoll || 10}}"
                  show-rarity="{{item.config.showRarity || false}}"
                  title="{{item.config.title || item.title}}"
                  subtitle="{{item.config.subtitle || ''}}"
                  user-points="{{userPoints}}"
                  pool-items="{{diceSteps[item.step_key].poolItems}}"
                  bind:roll="onDiceRoll"
                  bind:confirm="onDiceConfirm"
                  bind:insufficientPoints="onDiceInsufficientPoints"
                  bind:loadPool="onLoadDicePool"
                />
              </view>
            </block>
          </block>
        </view>
      </view>
    </view>

    <!-- Prompt é¢„è§ˆåŒº -->
    <view class="prompt-preview-section" wx:if="{{showPromptPreview && promptPreview}}">
      <view class="section-header">
        <text class="section-title">{{i18n.text('ç”Ÿæˆé¢„è§ˆ', 'Generation Preview', currentLang)}}</text>
        <view class="preview-toggle" bindtap="togglePromptPreview">
          <text>{{promptPreviewExpanded ? i18n.text('æ”¶èµ·', 'Collapse', currentLang) : i18n.text('å±•å¼€', 'Expand', currentLang)}}</text>
          <image class="toggle-icon {{promptPreviewExpanded ? 'expanded' : ''}}" src="/images/icon-arrow-down.svg" mode="aspectFit" />
        </view>
      </view>
      <view class="prompt-preview-content {{promptPreviewExpanded ? 'expanded' : ''}}">
        <text class="prompt-text" selectable="{{false}}">{{promptPreview}}</text>
      </view>
      <view class="prompt-preview-footer">
        <text class="preview-hint">{{i18n.text('ä»¥ä¸Šå†…å®¹å°†ç”¨äºAIç”Ÿæˆï¼Œä¸å¯ç¼–è¾‘', 'The above content will be used for AI generation and cannot be edited', currentLang)}}</text>
      </view>
    </view>

    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-placeholder"></view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{!configLoading}}">
    <view class="quantity-selector">
      <view class="qty-btn {{generateCount <= 1 ? 'disabled' : ''}}" bindtap="decreaseQuantity">âˆ’</view>
      <text class="qty-value">{{generateCount}}{{lang.fp_unit}}</text>
      <view class="qty-btn {{generateCount >= 10 ? 'disabled' : ''}}" bindtap="increaseQuantity">+</view>
    </view>
    <view class="generate-btn {{uploadedImages.length === 0 ? 'disabled' : ''}}" bindtap="showPaymentModal">
      <text class="btn-text">{{lang.fp_generateNow || 'Generate Now'}}</text>
      <text class="btn-points">{{totalPoints}} {{lang.points || 'Points'}}</text>
    </view>
  </view>

  <!-- æ”¯ä»˜å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showPayModal}}" catchtap="hidePaymentModal">
    <view class="modal-content pay-modal" catchtap="stopPropagation">
      <!-- è£…é¥°æ€§æ¸å˜èƒŒæ™¯ -->
      <view class="pay-modal-bg"></view>

      <!-- å…³é—­æŒ‰é’® -->
      <view class="modal-close-btn" bindtap="hidePaymentModal">Ã—</view>

      <view class="modal-body">
        <!-- é†’å¸å›¾æ ‡è£…é¥° -->
        <view class="pay-icon-decoration">
          <view class="pay-icon-circle">
            <text class="pay-icon-star">âœ¦</text>
          </view>
        </view>

        <view class="pay-info-card">
          <view class="pay-info-row">
            <text class="info-label">{{lang.fp_generateQty || 'ç”Ÿæˆæ•°é‡'}}</text>
            <text class="info-value">{{generateCount}}{{lang.fp_unit || 'å¼ '}}</text>
          </view>
          <view class="pay-info-divider"></view>
          <view class="pay-info-row highlight-row">
            <text class="info-label">{{lang.consumePoints || 'æœ¬æ¬¡æ¶ˆè€—'}}</text>
            <view class="info-value-wrapper">
              <text class="info-value-highlight">-{{totalPoints}}</text>
              <text class="info-unit">{{lang.pointsUnit || 'é†’å¸'}}</text>
            </view>
          </view>
          <view class="pay-info-divider"></view>
          <view class="pay-info-row">
            <text class="info-label">{{lang.currentBalance || 'å½“å‰ä½™é¢'}}</text>
            <view class="info-value-wrapper">
              <text class="info-value">{{userPoints}}</text>
              <text class="info-unit">{{lang.pointsUnit || 'é†’å¸'}}</text>
            </view>
          </view>
          <view class="pay-info-divider"></view>
          <view class="pay-info-row balance-after-row">
            <text class="info-label-after">{{lang.balanceAfterPay || 'æ”¯ä»˜åä½™é¢'}}</text>
            <view class="info-value-wrapper">
              <text class="info-value-after">{{userPoints - totalPoints}}</text>
              <text class="info-unit-after">{{lang.pointsUnit || 'é†’å¸'}}</text>
            </view>
          </view>
        </view>

        <!-- ä½™é¢ä¸è¶³æç¤º - å¢å¼ºç‰ˆ -->
        <view class="pay-warning-enhanced" wx:if="{{userPoints < totalPoints}}">
          <view class="warning-header">
            <view class="warning-icon">!</view>
            <text class="warning-title">{{lang.insufficientBalanceTitle || 'ä½™é¢ä¸è¶³'}}</text>
          </view>
          <view class="warning-desc">
            <text>{{lang.needMorePoints || 'è¿˜éœ€'}} {{totalPoints - userPoints}} {{lang.pointsUnit || 'é†’å¸'}}</text>
          </view>
          <view class="earn-points-tips">
            <view class="earn-tip-title">{{lang.howToEarnPoints || 'è·å–é†’å¸æ–¹å¼ï¼š'}}</view>
            <view class="earn-tip-item" bindtap="goToInvite">
              <text class="earn-tip-icon">ğŸ‘¥</text>
              <text class="earn-tip-text">{{lang.earnTip1 || 'é‚€è¯·å¥½å‹ +50é†’å¸/äºº'}}</text>
              <text class="earn-tip-arrow">â€º</text>
            </view>
            <view class="earn-tip-item" bindtap="goToHistory">
              <text class="earn-tip-icon">ğŸ“¤</text>
              <text class="earn-tip-text">{{lang.earnTip2 || 'åˆ†äº«ç…§ç‰‡ +10é†’å¸/æ¬¡'}}</text>
              <text class="earn-tip-arrow">â€º</text>
            </view>
            <view class="earn-tip-item" bindtap="goToRecharge" wx:if="{{!isIOSPlatform}}">
              <text class="earn-tip-icon">ğŸ’°</text>
              <text class="earn-tip-text">{{lang.earnTip3 || 'å……å€¼ 1å…ƒ=10é†’å¸'}}</text>
              <text class="earn-tip-arrow">â€º</text>
            </view>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <!-- iOSç”¨æˆ·ä½™é¢ä¸è¶³æ—¶æ˜¾ç¤ºé‚€è¯·å¥½å‹æŒ‰é’® -->
        <view class="pay-btn btn-recharge" bindtap="goToInvite" wx:if="{{userPoints < totalPoints && isIOSPlatform}}">
          <text>{{lang.inviteFriends || 'é‚€è¯·å¥½å‹'}}</text>
        </view>
        <!-- éiOSç”¨æˆ·ä½™é¢ä¸è¶³æ—¶æ˜¾ç¤ºå……å€¼æŒ‰é’® -->
        <view class="pay-btn btn-recharge" bindtap="goToRecharge" wx:elif="{{userPoints < totalPoints}}">
          <text>{{lang.goRecharge || 'å»å……å€¼'}}</text>
        </view>
        <view class="pay-btn btn-confirm" bindtap="confirmPayment" wx:else>
          <text>{{lang.fp_confirmPayBtn || 'ç¡®è®¤æ”¯ä»˜'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç™»å½•å¼¹çª— -->
  <login-modal
    show="{{showLoginModal}}"
    bind:close="onLoginModalClose"
    bind:skip="onLoginModalClose"
    bind:loginsuccess="onLoginSuccess"
  />

  <!-- éšç§åè®®å¼¹çª— -->
  <privacy-modal
    show="{{showPrivacyModal}}"
    bind:close="onPrivacyModalClose"
    bind:agree="onPrivacyAgree"
  />

  <!-- éª°å­è§„åˆ™è¯´æ˜å¼¹çª— -->
  <view class="dice-rules-modal" wx:if="{{showDiceRulesModal}}">
    <view class="dice-rules-mask" catchtap="onCloseDiceRules"></view>
    <view class="dice-rules-content">
      <view class="dice-rules-header">
        <text class="dice-rules-title">{{lang.dice_rulesTitle || 'æŠ½å–è§„åˆ™'}}</text>
        <view class="dice-rules-close" catchtap="onCloseDiceRules">Ã—</view>
      </view>

      <!-- è§„åˆ™è¯´æ˜ -->
      <view class="dice-rules-section">
        <view class="dice-rules-item">
          <text class="dice-rules-label">{{lang.dice_freeRule || 'å…è´¹æ¬¡æ•°'}}</text>
          <text class="dice-rules-value">{{lang.dice_freeRuleDesc || 'æ¯å¤©æ¯ä¸ªåœºæ™¯å¯å…è´¹æŠ½å–1æ¬¡'}}</text>
        </view>
        <view class="dice-rules-item">
          <text class="dice-rules-label">{{lang.dice_costRule || 'ä»˜è´¹æŠ½å–'}}</text>
          <text class="dice-rules-value">10 {{lang.pointsUnit || 'é†’å¸'}} / {{lang.dice_perTime || 'æ¬¡'}}</text>
        </view>
      </view>

      <!-- å£°æ˜ -->
      <view class="dice-rules-disclaimer">
        <text class="dice-disclaimer-text">{{lang.dice_disclaimer || 'æŠ½å–ç»“æœå®Œå…¨éšæœºï¼Œæ¦‚ç‡ä»…ä¾›å‚è€ƒ'}}</text>
      </view>

      <!-- é€‰é¡¹æ¸…å• -->
      <view class="dice-pool-section">
        <view class="dice-pool-title">{{lang.dice_poolTitle || 'å¯æŠ½å–å†…å®¹'}}</view>
        <scroll-view class="dice-pool-list" scroll-y>
          <view class="dice-pool-item" wx:for="{{currentDicePoolItems}}" wx:key="id">
            <image class="dice-pool-item-img" wx:if="{{item.image}}" src="{{item.image}}" mode="aspectFit" />
            <view class="dice-pool-item-icon" wx:else>
              <text wx:if="{{currentDiceDrawType === 'horse'}}">ğŸ´</text>
              <text wx:else>ğŸ“œ</text>
            </view>
            <view class="dice-pool-item-info">
              <text class="dice-pool-item-name">{{item.name}}</text>
              <text class="dice-pool-item-rarity {{item.rarity}}" wx:if="{{item.rarity_name}}">{{item.rarity_name}}</text>
            </view>
            <text class="dice-pool-item-prob">{{item.probability}}</text>
          </view>
          <view class="dice-pool-empty" wx:if="{{!currentDicePoolItems || currentDicePoolItems.length === 0}}">
            <text>{{lang.dice_loadingPool || 'åŠ è½½ä¸­...'}}</text>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>
</view>
