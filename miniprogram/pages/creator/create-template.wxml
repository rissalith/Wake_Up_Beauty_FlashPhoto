<!-- 创建模板页面 -->
<view class="page-container">
  <!-- 自定义导航栏 -->
  <view class="custom-nav" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-content">
      <view class="nav-back" bindtap="goBack">
        <image class="back-icon" src="/images/icon-back-white.svg" mode="aspectFit"></image>
      </view>
      <text class="nav-title">{{isEdit ? '编辑模板' : '创建模板'}}</text>
      <view class="nav-placeholder"></view>
    </view>
  </view>

  <!-- 页面内容 -->
  <scroll-view class="page-scroll" style="top: {{navBarHeight}}px;" scroll-y="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">
    <!-- 步骤指示器 -->
    <view class="step-indicator">
      <view class="step-item {{currentStep >= 1 ? 'active' : ''}} {{currentStep > 1 ? 'done' : ''}}">
        <view class="step-num">1</view>
        <text class="step-text">基本信息</text>
      </view>
      <view class="step-line {{currentStep > 1 ? 'active' : ''}}"></view>
      <view class="step-item {{currentStep >= 2 ? 'active' : ''}} {{currentStep > 2 ? 'done' : ''}}">
        <view class="step-num">2</view>
        <text class="step-text">上传图片</text>
      </view>
      <view class="step-line {{currentStep > 2 ? 'active' : ''}}"></view>
      <view class="step-item {{currentStep >= 3 ? 'active' : ''}}">
        <view class="step-num">3</view>
        <text class="step-text">设置参数</text>
      </view>
    </view>

    <!-- 步骤1：基本信息 -->
    <view class="step-content" wx:if="{{currentStep === 1}}">
      <!-- AI 智能生成入口 -->
      <view class="ai-generate-section" wx:if="{{!isEdit}}">
        <view class="ai-generate-card" bindtap="showAiGenerateModal">
          <view class="ai-icon-wrapper">
            <text class="ai-icon">✨</text>
          </view>
          <view class="ai-text-wrapper">
            <text class="ai-title">AI 智能生成</text>
            <text class="ai-desc">描述你想要的模板，AI 自动生成配置</text>
          </view>
          <view class="ai-arrow">
            <text>›</text>
          </view>
        </view>
      </view>

      <view class="form-section">
        <view class="form-item">
          <text class="form-label required">模板名称</text>
          <input
            class="form-input"
            placeholder="给模板起个名字"
            value="{{formData.name}}"
            bindinput="onInputChange"
            data-field="name"
            maxlength="20"
          />
          <text class="form-count">{{formData.name.length || 0}}/20</text>
        </view>

        <view class="form-item">
          <text class="form-label">模板描述</text>
          <textarea
            class="form-textarea"
            placeholder="描述一下这个模板的特点和适用场景"
            value="{{formData.description}}"
            bindinput="onInputChange"
            data-field="description"
            maxlength="100"
          />
          <text class="form-count">{{formData.description.length || 0}}/100</text>
        </view>

        <view class="form-item">
          <text class="form-label">选择分类</text>
          <picker mode="selector" range="{{categories}}" range-key="name" value="{{categoryIndex}}" bindchange="onCategoryChange">
            <view class="form-picker">
              <text class="picker-text {{categoryIndex >= 0 ? '' : 'placeholder'}}">
                {{categoryIndex >= 0 ? categories[categoryIndex].name : '请选择分类'}}
              </text>
              <image class="picker-arrow" src="/images/icon-arrow-down.svg" mode="aspectFit"></image>
            </view>
          </picker>
        </view>

        <view class="form-item">
          <text class="form-label">适用性别</text>
          <view class="gender-options">
            <view class="gender-option {{formData.gender === 'all' ? 'active' : ''}}" bindtap="selectGender" data-gender="all">
              <text>不限</text>
            </view>
            <view class="gender-option {{formData.gender === 'male' ? 'active' : ''}}" bindtap="selectGender" data-gender="male">
              <text>男</text>
            </view>
            <view class="gender-option {{formData.gender === 'female' ? 'active' : ''}}" bindtap="selectGender" data-gender="female">
              <text>女</text>
            </view>
          </view>
        </view>

        <view class="form-item">
          <text class="form-label required">定价（醒币）</text>
          <input
            class="form-input"
            type="number"
            placeholder="设置使用价格"
            value="{{formData.points_cost}}"
            bindinput="onInputChange"
            data-field="points_cost"
          />
          <text class="form-hint">建议定价 30-100 醒币</text>
        </view>
      </view>
    </view>

    <!-- 步骤2：上传图片 -->
    <view class="step-content" wx:if="{{currentStep === 2}}">
      <view class="upload-section">
        <view class="upload-item">
          <text class="upload-label required">封面图</text>
          <text class="upload-hint">展示在市场列表中，建议尺寸 3:4</text>
          <view class="upload-area" bindtap="chooseCoverImage">
            <image wx:if="{{formData.cover_image}}" class="upload-preview" src="{{formData.cover_image}}" mode="aspectFill"></image>
            <view wx:else class="upload-placeholder">
              <image class="upload-icon" src="/images/icon-add-image.svg" mode="aspectFit"></image>
              <text class="upload-text">点击上传封面图</text>
            </view>
          </view>
        </view>

        <view class="upload-item">
          <text class="upload-label required">参考样式图</text>
          <text class="upload-hint">AI 将基于此图生成，用户的脸会替换到这张图中</text>
          <view class="upload-area" bindtap="chooseReferenceImage">
            <image wx:if="{{formData.reference_image}}" class="upload-preview" src="{{formData.reference_image}}" mode="aspectFill"></image>
            <view wx:else class="upload-placeholder">
              <image class="upload-icon" src="/images/icon-add-image.svg" mode="aspectFit"></image>
              <text class="upload-text">点击上传参考图</text>
            </view>
          </view>
        </view>
      </view>

      <view class="tips-section">
        <text class="tips-title">参考图要求</text>
        <view class="tips-list">
          <text class="tips-item">1. 图片中需要有清晰的人物面部</text>
          <text class="tips-item">2. 建议使用高质量、高清晰度的图片</text>
          <text class="tips-item">3. 避免使用版权图片或他人肖像</text>
          <text class="tips-item">4. 不得包含违规内容</text>
        </view>
      </view>
    </view>

    <!-- 步骤3：设置参数 -->
    <view class="step-content" wx:if="{{currentStep === 3}}">
      <view class="prompt-section">
        <view class="form-item">
          <text class="form-label required">Prompt 模板</text>
          <text class="form-hint">描述 AI 如何生成图片，可使用变量如 {{expression}}</text>
          <textarea
            class="form-textarea large"
            placeholder="例如：基于参考图生成{{expression}}表情的照片，保持整体风格不变..."
            value="{{formData.prompt_template}}"
            bindinput="onInputChange"
            data-field="prompt_template"
            maxlength="500"
          />
          <text class="form-count">{{formData.prompt_template.length || 0}}/500</text>
        </view>

        <view class="form-item">
          <text class="form-label">负面提示词</text>
          <textarea
            class="form-textarea"
            placeholder="描述不希望出现的内容"
            value="{{formData.negative_prompt}}"
            bindinput="onInputChange"
            data-field="negative_prompt"
            maxlength="200"
          />
        </view>
      </view>

      <view class="preview-section">
        <text class="preview-title">模板预览</text>
        <view class="preview-card">
          <image class="preview-cover" src="{{formData.cover_image || '/images/placeholder.svg'}}" mode="aspectFill"></image>
          <view class="preview-info">
            <text class="preview-name">{{formData.name || '模板名称'}}</text>
            <text class="preview-price">{{formData.points_cost || 50}} 醒币</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 底部安全区 -->
    <view class="safe-bottom"></view>
  </scroll-view>

  <!-- 底部按钮 -->
  <view class="bottom-bar" style="padding-bottom: env(safe-area-inset-bottom);">
    <view class="btn-prev" wx:if="{{currentStep > 1}}" bindtap="prevStep">
      <text class="btn-text">上一步</text>
    </view>
    <view class="btn-next {{canNext ? '' : 'disabled'}}" bindtap="nextStep">
      <text class="btn-text">{{currentStep === 3 ? '提交审核' : '下一步'}}</text>
    </view>
    <view class="btn-draft" wx:if="{{currentStep === 3}}" bindtap="saveDraft">
      <text class="btn-text">保存草稿</text>
    </view>
  </view>

  <!-- AI 生成弹窗 -->
  <view class="ai-modal-mask" wx:if="{{showAiModal}}" bindtap="hideAiGenerateModal">
    <view class="ai-modal" catchtap="preventBubble">
      <view class="ai-modal-header">
        <text class="ai-modal-title">AI 智能生成</text>
        <view class="ai-modal-close" bindtap="hideAiGenerateModal">×</view>
      </view>

      <view class="ai-modal-body">
        <!-- 输入区域 -->
        <view class="ai-input-section" wx:if="{{!aiGenerating && !aiResult}}">
          <text class="ai-input-label">描述你想要的模板</text>
          <textarea
            class="ai-input-textarea"
            placeholder="例如：春节拜年场景，用户可以选择不同的祝福语和喜庆背景"
            value="{{aiDescription}}"
            bindinput="onAiDescriptionInput"
            maxlength="200"
          />
          <text class="ai-input-count">{{aiDescription.length || 0}}/200</text>

          <!-- 示例 -->
          <view class="ai-examples">
            <text class="ai-examples-title">试试这些示例：</text>
            <view class="ai-example-tags">
              <text class="ai-example-tag" bindtap="useAiExample" data-text="春节拜年场景，用户可以选择祝福语和喜庆背景">春节拜年</text>
              <text class="ai-example-tag" bindtap="useAiExample" data-text="职业证件照，用户可以选择背景颜色和服装风格">职业证件照</text>
              <text class="ai-example-tag" bindtap="useAiExample" data-text="情人节主题，用户可以选择浪漫背景和装饰">情人节</text>
              <text class="ai-example-tag" bindtap="useAiExample" data-text="毕业照场景，用户可以选择学士服和校园背景">毕业照</text>
            </view>
          </view>
        </view>

        <!-- 生成中 -->
        <view class="ai-generating-section" wx:if="{{aiGenerating}}">
          <view class="ai-loading-animation">
            <view class="ai-loading-dot"></view>
            <view class="ai-loading-dot"></view>
            <view class="ai-loading-dot"></view>
          </view>
          <text class="ai-generating-text">{{aiGeneratingText}}</text>
          <view class="ai-progress-bar">
            <view class="ai-progress-fill" style="width: {{aiProgress}}%;"></view>
          </view>
          <text class="ai-progress-text">{{aiProgress}}%</text>
        </view>

        <!-- 生成结果 -->
        <view class="ai-result-section" wx:if="{{aiResult}}">
          <view class="ai-result-header">
            <text class="ai-result-title">生成完成</text>
            <text class="ai-result-score">评分: {{aiResult.score || 0}}</text>
          </view>

          <view class="ai-result-item">
            <text class="ai-result-label">模板名称</text>
            <text class="ai-result-value">{{aiResult.name}}</text>
          </view>

          <view class="ai-result-item">
            <text class="ai-result-label">模板描述</text>
            <text class="ai-result-value">{{aiResult.description}}</text>
          </view>

          <view class="ai-result-item">
            <text class="ai-result-label">Prompt 模板</text>
            <text class="ai-result-value prompt">{{aiResult.prompt}}</text>
          </view>

          <view class="ai-result-item">
            <text class="ai-result-label">建议定价</text>
            <text class="ai-result-value">{{aiResult.points_cost}} 醒币</text>
          </view>
        </view>
      </view>

      <view class="ai-modal-footer">
        <view wx:if="{{!aiGenerating && !aiResult}}" class="ai-btn-generate {{aiDescription.length > 5 ? '' : 'disabled'}}" bindtap="startAiGenerate">
          <text>开始生成</text>
        </view>
        <view wx:if="{{aiGenerating}}" class="ai-btn-cancel" bindtap="cancelAiGenerate">
          <text>取消</text>
        </view>
        <view wx:if="{{aiResult}}" class="ai-btn-group">
          <view class="ai-btn-retry" bindtap="retryAiGenerate">
            <text>重新生成</text>
          </view>
          <view class="ai-btn-apply" bindtap="applyAiResult">
            <text>应用配置</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
