<!--pages/creator/my-templates.wxml-->
<wxs module="utils">
module.exports = {
  getStatusText: function(status) {
    var map = {
      draft: 'è‰ç¨¿',
      reviewing: 'å®¡æ ¸ä¸­',
      pending: 'å¾…å®¡æ ¸',
      active: 'å·²ä¸Šæ¶',
      rejected: 'å·²æ‹’ç»',
      offline: 'å·²ä¸‹æ¶'
    }
    return map[status] || status
  }
}
</wxs>

<view class="my-templates">
  <!-- å¤´éƒ¨ç»Ÿè®¡ -->
  <view class="stats-header">
    <view class="stats-item">
      <text class="stats-value">{{stats.total}}</text>
      <text class="stats-label">å…¨éƒ¨</text>
    </view>
    <view class="stats-item">
      <text class="stats-value active">{{stats.active}}</text>
      <text class="stats-label">å·²ä¸Šæ¶</text>
    </view>
    <view class="stats-item">
      <text class="stats-value reviewing">{{stats.reviewing + stats.pending}}</text>
      <text class="stats-label">å®¡æ ¸ä¸­</text>
    </view>
    <view class="stats-item">
      <text class="stats-value rejected">{{stats.rejected}}</text>
      <text class="stats-label">å·²æ‹’ç»</text>
    </view>
  </view>

  <!-- Tab ç­›é€‰ -->
  <view class="tabs">
    <view class="tab {{currentTab === '' ? 'active' : ''}}" data-tab="" bindtap="onTabChange">
      å…¨éƒ¨
    </view>
    <view class="tab {{currentTab === 'draft' ? 'active' : ''}}" data-tab="draft" bindtap="onTabChange">
      è‰ç¨¿
    </view>
    <view class="tab {{currentTab === 'reviewing' ? 'active' : ''}}" data-tab="reviewing" bindtap="onTabChange">
      å®¡æ ¸ä¸­
    </view>
    <view class="tab {{currentTab === 'active' ? 'active' : ''}}" data-tab="active" bindtap="onTabChange">
      å·²ä¸Šæ¶
    </view>
    <view class="tab {{currentTab === 'rejected' ? 'active' : ''}}" data-tab="rejected" bindtap="onTabChange">
      å·²æ‹’ç»
    </view>
  </view>

  <!-- æç¤ºä¿¡æ¯ -->
  <view class="drag-tip" wx:if="{{templates.length > 1 && currentTab === ''}}">
    <text class="tip-icon">ğŸ’¡</text>
    <text>é•¿æŒ‰æ¨¡æ¿å¯æ‹–æ‹½æ’åº</text>
  </view>

  <!-- æ¨¡æ¿åˆ—è¡¨ -->
  <view class="template-list">
    <view
      wx:for="{{templates}}"
      wx:key="id"
      class="template-card {{isDragging && dragIndex === index ? 'dragging' : ''}}"
      style="{{isDragging && dragIndex === index ? 'transform: translateY(' + dragOffsetY + 'px);' : ''}}"
      data-index="{{index}}"
      bindlongpress="onDragStart"
      bindtouchmove="onDragMove"
      bindtouchend="onDragEnd"
      bindtouchcancel="onDragEnd"
    >
      <!-- æ‹–æ‹½æ‰‹æŸ„ -->
      <view class="drag-handle" wx:if="{{currentTab === ''}}">
        <text class="handle-icon">â‹®â‹®</text>
      </view>

      <!-- æ¨¡æ¿ä¿¡æ¯ -->
      <view class="template-content" bindtap="editTemplate" data-id="{{item.id}}" data-status="{{item.status}}">
        <image class="template-cover" src="{{item.cover_image}}" mode="aspectFill" />
        <view class="template-info">
          <view class="template-name">{{item.name}}</view>
          <view class="template-desc">{{item.description || 'æš‚æ— æè¿°'}}</view>
          <view class="template-meta">
            <view class="status-tag {{item.status}}">{{utils.getStatusText(item.status)}}</view>
            <text class="points">{{item.points_cost}} é†’å¸</text>
            <text class="use-count" wx:if="{{item.status === 'active'}}">ä½¿ç”¨ {{item.use_count || 0}}</text>
          </view>
          <!-- æ‹’ç»åŸå›  -->
          <view class="reject-reason" wx:if="{{item.status === 'rejected' && item.reject_reason}}">
            <text class="reason-label">æ‹’ç»åŸå› ï¼š</text>
            <text class="reason-text">{{item.reject_reason}}</text>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="template-actions">
        <!-- è‰ç¨¿çŠ¶æ€ -->
        <block wx:if="{{item.status === 'draft'}}">
          <view class="action-btn edit" bindtap="editTemplate" data-id="{{item.id}}" data-status="{{item.status}}">ç¼–è¾‘</view>
          <view class="action-btn submit" bindtap="submitForReview" data-id="{{item.id}}">æäº¤å®¡æ ¸</view>
          <view class="action-btn delete" bindtap="deleteTemplate" data-id="{{item.id}}" data-status="{{item.status}}">åˆ é™¤</view>
        </block>

        <!-- å®¡æ ¸ä¸­çŠ¶æ€ -->
        <block wx:elif="{{item.status === 'reviewing' || item.status === 'pending'}}">
          <view class="action-btn disabled">ç­‰å¾…å®¡æ ¸ç»“æœ</view>
        </block>

        <!-- å·²ä¸Šæ¶çŠ¶æ€ -->
        <block wx:elif="{{item.status === 'active'}}">
          <view class="action-btn edit" bindtap="editTemplate" data-id="{{item.id}}" data-status="{{item.status}}">ç¼–è¾‘</view>
          <view class="action-btn offline" bindtap="offlineTemplate" data-id="{{item.id}}">ä¸‹æ¶</view>
          <view class="action-btn delete" bindtap="deleteTemplate" data-id="{{item.id}}" data-status="{{item.status}}">åˆ é™¤</view>
        </block>

        <!-- å·²æ‹’ç»çŠ¶æ€ -->
        <block wx:elif="{{item.status === 'rejected'}}">
          <view class="action-btn edit" bindtap="editTemplate" data-id="{{item.id}}" data-status="{{item.status}}">ä¿®æ”¹</view>
          <view class="action-btn submit" bindtap="submitForReview" data-id="{{item.id}}">é‡æ–°æäº¤</view>
          <view class="action-btn delete" bindtap="deleteTemplate" data-id="{{item.id}}" data-status="{{item.status}}">åˆ é™¤</view>
        </block>

        <!-- å·²ä¸‹æ¶çŠ¶æ€ -->
        <block wx:elif="{{item.status === 'offline'}}">
          <view class="action-btn edit" bindtap="editTemplate" data-id="{{item.id}}" data-status="{{item.status}}">ç¼–è¾‘</view>
          <view class="action-btn submit" bindtap="submitForReview" data-id="{{item.id}}">é‡æ–°ä¸Šæ¶</view>
          <view class="action-btn delete" bindtap="deleteTemplate" data-id="{{item.id}}" data-status="{{item.status}}">åˆ é™¤</view>
        </block>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && templates.length === 0}}">
      <image class="empty-icon" src="/images/icon-empty.svg" mode="aspectFit" />
      <text class="empty-text">æš‚æ— æ¨¡æ¿</text>
      <view class="empty-btn" bindtap="createTemplate">åˆ›å»ºç¬¬ä¸€ä¸ªæ¨¡æ¿</view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{!loading && templates.length > 0 && hasMore}}">
      <text>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!loading && templates.length > 0 && !hasMore}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </view>

  <!-- åˆ›å»ºæŒ‰é’® -->
  <view class="create-btn" bindtap="createTemplate">
    <text class="create-icon">+</text>
    <text>åˆ›å»ºæ¨¡æ¿</text>
  </view>
</view>
