<!--pages/creator/my-templates.wxml-->
<wxs module="utils">
module.exports = {
  getStatusText: function(status) {
    var map = {
      draft: '草稿',
      reviewing: '审核中',
      pending: '待审核',
      active: '已上架',
      rejected: '已拒绝',
      offline: '已下架'
    }
    return map[status] || status
  }
}
</wxs>

<view class="my-templates">
  <!-- 顶部导航栏 -->
  <view class="nav-bar" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-content">
      <view class="nav-back" bindtap="goBack">
        <image class="back-icon" src="/images/icon-arrow-left.svg" mode="aspectFit"></image>
      </view>
      <text class="nav-title">我的模板</text>
      <view class="nav-action" bindtap="createTemplate">
        <image class="add-icon" src="/images/icon-add.svg" mode="aspectFit"></image>
      </view>
    </view>
  </view>

  <!-- 统计头部 -->
  <view class="stats-header" style="margin-top: {{statusBarHeight + 44}}px;">
    <view class="stats-item">
      <text class="stats-value">{{stats.total || 0}}</text>
      <text class="stats-label">全部</text>
    </view>
    <view class="stats-item">
      <text class="stats-value active">{{stats.active || 0}}</text>
      <text class="stats-label">已上架</text>
    </view>
    <view class="stats-item">
      <text class="stats-value reviewing">{{(stats.reviewing || 0) + (stats.pending || 0)}}</text>
      <text class="stats-label">审核中</text>
    </view>
    <view class="stats-item">
      <text class="stats-value rejected">{{stats.rejected || 0}}</text>
      <text class="stats-label">已拒绝</text>
    </view>
  </view>

  <!-- 搜索栏 -->
  <view class="search-bar">
    <view class="search-input-wrap {{searchFocused ? 'focused' : ''}}">
      <image class="search-icon" src="/images/icon-search.svg" mode="aspectFit"></image>
      <input
        class="search-input"
        type="text"
        placeholder="搜索模板名称"
        placeholder-class="search-placeholder"
        value="{{searchKeyword}}"
        bindfocus="onSearchFocus"
        bindblur="onSearchBlur"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
        confirm-type="search"
      />
      <view class="search-clear" wx:if="{{searchKeyword}}" bindtap="onClearSearch">
        <image class="clear-icon" src="/images/icon-close-circle.svg" mode="aspectFit"></image>
      </view>
    </view>
  </view>

  <!-- 状态筛选标签 -->
  <scroll-view class="status-scroll" scroll-x="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">
    <view class="status-list">
      <view
        wx:for="{{statusOptions}}"
        wx:key="value"
        class="status-item {{currentStatus === item.value ? 'active' : ''}}"
        data-value="{{item.value}}"
        bindtap="onStatusChange"
      >
        <text class="status-name">{{item.label}}</text>
      </view>
    </view>
  </scroll-view>

  <!-- 模板网格列表 -->
  <scroll-view
    class="template-scroll"
    scroll-y="{{true}}"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    bindscrolltolower="onReachBottom"
    refresher-enabled="{{true}}"
    bindrefresherrefresh="onPullDownRefresh"
  >
    <view class="template-grid">
      <view
        wx:for="{{templates}}"
        wx:key="id"
        class="template-card"
      >
        <!-- 封面区域 -->
        <view class="card-cover-wrap" bindtap="onTemplateClick" data-id="{{item.id}}" data-status="{{item.status}}">
          <image class="card-cover" src="{{item.cover_image || '/images/placeholder.svg'}}" mode="aspectFill" lazy-load="{{true}}"></image>
          <!-- 状态标签 -->
          <view class="card-status {{item.status}}">
            <text>{{utils.getStatusText(item.status)}}</text>
          </view>
          <!-- 使用次数 -->
          <view class="card-use-count" wx:if="{{item.status === 'active'}}">
            <image class="use-icon" src="/images/icon-fire.svg" mode="aspectFit"></image>
            <text>{{item.use_count || 0}}</text>
          </view>
        </view>

        <!-- 信息区域 -->
        <view class="card-info">
          <text class="card-name">{{item.name || '未命名模板'}}</text>
          <view class="card-meta">
            <text class="card-price">{{item.points_cost || 0}} 醒币</text>
          </view>
        </view>

        <!-- 拒绝原因 -->
        <view class="reject-reason" wx:if="{{item.status === 'rejected' && item.reject_reason}}">
          <text class="reason-text">拒绝原因：{{item.reject_reason}}</text>
        </view>

        <!-- 操作按钮 -->
        <view class="card-actions">
          <!-- 草稿状态 -->
          <block wx:if="{{item.status === 'draft'}}">
            <view class="action-btn edit" bindtap="onTemplateClick" data-id="{{item.id}}" data-status="{{item.status}}">编辑</view>
            <view class="action-btn submit" bindtap="submitForReview" data-id="{{item.id}}">提交审核</view>
            <view class="action-btn delete" bindtap="deleteTemplate" data-id="{{item.id}}" data-status="{{item.status}}">删除</view>
          </block>

          <!-- 审核中状态 -->
          <block wx:elif="{{item.status === 'reviewing' || item.status === 'pending'}}">
            <view class="action-btn disabled full">等待审核结果</view>
          </block>

          <!-- 已上架状态 -->
          <block wx:elif="{{item.status === 'active'}}">
            <view class="action-btn edit" bindtap="onTemplateClick" data-id="{{item.id}}" data-status="{{item.status}}">编辑</view>
            <view class="action-btn offline" bindtap="offlineTemplate" data-id="{{item.id}}">下架</view>
            <view class="action-btn delete" bindtap="deleteTemplate" data-id="{{item.id}}" data-status="{{item.status}}">删除</view>
          </block>

          <!-- 已拒绝状态 -->
          <block wx:elif="{{item.status === 'rejected'}}">
            <view class="action-btn edit" bindtap="onTemplateClick" data-id="{{item.id}}" data-status="{{item.status}}">修改</view>
            <view class="action-btn submit" bindtap="submitForReview" data-id="{{item.id}}">重新提交</view>
            <view class="action-btn delete" bindtap="deleteTemplate" data-id="{{item.id}}" data-status="{{item.status}}">删除</view>
          </block>

          <!-- 已下架状态 -->
          <block wx:elif="{{item.status === 'offline'}}">
            <view class="action-btn edit" bindtap="onTemplateClick" data-id="{{item.id}}" data-status="{{item.status}}">编辑</view>
            <view class="action-btn submit" bindtap="submitForReview" data-id="{{item.id}}">重新上架</view>
            <view class="action-btn delete" bindtap="deleteTemplate" data-id="{{item.id}}" data-status="{{item.status}}">删除</view>
          </block>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{!loading && templates.length === 0}}">
      <image class="empty-icon" src="/images/icon-empty.svg" mode="aspectFit"></image>
      <text class="empty-text" wx:if="{{searchKeyword}}">未找到相关模板</text>
      <text class="empty-text" wx:elif="{{currentStatus === 'draft'}}">暂无草稿模板</text>
      <text class="empty-text" wx:elif="{{currentStatus === 'reviewing'}}">暂无审核中模板</text>
      <text class="empty-text" wx:elif="{{currentStatus === 'active'}}">暂无已上架模板</text>
      <text class="empty-text" wx:elif="{{currentStatus === 'rejected'}}">暂无已拒绝模板</text>
      <text class="empty-text" wx:elif="{{currentStatus === 'offline'}}">暂无已下架模板</text>
      <text class="empty-text" wx:else>还没有创建模板</text>
      <view class="empty-btn" wx:if="{{!searchKeyword && !currentStatus}}" bindtap="createTemplate">创建第一个模板</view>
      <view class="empty-btn secondary" wx:if="{{searchKeyword}}" bindtap="onClearSearch">清除搜索</view>
    </view>

    <!-- 加载状态 -->
    <view class="loading-state" wx:if="{{loading && templates.length === 0}}">
      <view class="loading-spinner"></view>
      <text>加载中...</text>
    </view>

    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{loading && templates.length > 0}}">
      <view class="loading-spinner small"></view>
      <text>加载更多...</text>
    </view>

    <!-- 没有更多 -->
    <view class="no-more" wx:if="{{!loading && templates.length > 0 && !hasMore}}">
      <text>- 已经到底了 -</text>
    </view>

    <!-- 底部安全区 -->
    <view class="safe-bottom"></view>
  </scroll-view>

  <!-- 悬浮创建按钮 -->
  <view class="float-create-btn" bindtap="createTemplate">
    <image class="float-icon" src="/images/icon-add.svg" mode="aspectFit"></image>
  </view>
</view>
