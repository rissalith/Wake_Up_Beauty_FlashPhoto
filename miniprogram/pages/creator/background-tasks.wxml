<!-- åå°ä»»åŠ¡ç®¡ç†é¡µé¢ -->
<view class="page-container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-nav" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-content">
      <view class="nav-back" bindtap="goBack">
        <image class="back-icon" src="/images/icon-back-white.svg" mode="aspectFit"></image>
      </view>
      <text class="nav-title">åå°ä»»åŠ¡</text>
      <view class="nav-placeholder"></view>
    </view>
  </view>

  <!-- é¡µé¢å†…å®¹ -->
  <scroll-view class="page-scroll" style="top: {{navBarHeight}}px;" scroll-y="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">

    <!-- åŠ è½½ä¸­ -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-container" wx:elif="{{tasks.length === 0}}">
      <image class="empty-icon" src="/images/icon-empty.svg" mode="aspectFit"></image>
      <text class="empty-title">æš‚æ— åå°ä»»åŠ¡</text>
      <text class="empty-desc">ä½¿ç”¨ AI æ™ºèƒ½ç”Ÿæˆæ—¶ï¼Œå¯ä»¥å°†ä»»åŠ¡è½¬å…¥åå°è¿è¡Œ</text>
    </view>

    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <view class="task-list" wx:else>
      <view class="task-card {{item.status}}" wx:for="{{tasks}}" wx:key="taskId">
        <!-- ä»»åŠ¡å¤´éƒ¨ -->
        <view class="task-header">
          <view class="task-status-icon {{item.status}}">
            <text wx:if="{{item.status === 'processing' || item.status === 'loading'}}">ğŸ”„</text>
            <text wx:elif="{{item.status === 'completed'}}">âœ…</text>
            <text wx:elif="{{item.status === 'failed'}}">âŒ</text>
            <text wx:else>â³</text>
          </view>
          <view class="task-info">
            <text class="task-title">{{item.description || 'æœªå‘½åä»»åŠ¡'}}</text>
            <text class="task-time">{{item.createdAt}}</text>
          </view>
          <view class="task-delete" bindtap="deleteTask" data-taskid="{{item.taskId}}" catchtap="deleteTask">
            <text>Ã—</text>
          </view>
        </view>

        <!-- ä»»åŠ¡çŠ¶æ€ -->
        <view class="task-status-row">
          <!-- è¿›è¡Œä¸­ -->
          <block wx:if="{{item.status === 'processing' || item.status === 'loading'}}">
            <text class="status-text processing">{{item.currentStep || 'å¤„ç†ä¸­...'}}</text>
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{item.progress}}%;"></view>
            </view>
            <text class="progress-text">{{item.progress}}%</text>
          </block>

          <!-- å·²å®Œæˆ -->
          <block wx:elif="{{item.status === 'completed'}}">
            <text class="status-text completed">ç”Ÿæˆå®Œæˆ</text>
            <view class="task-result-preview" wx:if="{{item.result && item.result.config}}">
              <text class="result-item">åœºæ™¯ï¼š{{item.result.config.scene.name || 'æœªå‘½å'}}</text>
              <text class="result-item">æ­¥éª¤ï¼š{{item.result.config.steps.length || 0}}ä¸ª</text>
              <text class="result-item">è¯„åˆ†ï¼š{{item.result.score || 0}}åˆ†</text>
            </view>
          </block>

          <!-- å¤±è´¥ -->
          <block wx:elif="{{item.status === 'failed'}}">
            <text class="status-text failed">ç”Ÿæˆå¤±è´¥</text>
            <text class="error-message" wx:if="{{item.errorMessage}}">{{item.errorMessage}}</text>
          </block>

          <!-- è¿‡æœŸ -->
          <block wx:elif="{{item.status === 'expired'}}">
            <text class="status-text expired">ä»»åŠ¡å·²è¿‡æœŸ</text>
          </block>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="task-actions">
          <!-- å·²å®Œæˆçš„æ“ä½œ -->
          <block wx:if="{{item.status === 'completed'}}">
            <view class="action-btn secondary" bindtap="viewResult" data-taskid="{{item.taskId}}">
              <text>æŸ¥çœ‹ç»“æœ</text>
            </view>
            <view class="action-btn primary" bindtap="continueEdit" data-taskid="{{item.taskId}}" data-templateid="{{item.templateId}}">
              <text>ç»§ç»­ç¼–è¾‘</text>
            </view>
          </block>

          <!-- å¤±è´¥çš„æ“ä½œ -->
          <block wx:elif="{{item.status === 'failed'}}">
            <view class="action-btn secondary" bindtap="deleteTask" data-taskid="{{item.taskId}}">
              <text>åˆ é™¤</text>
            </view>
            <view class="action-btn primary" bindtap="retryTask" data-taskid="{{item.taskId}}" data-description="{{item.description}}">
              <text>é‡è¯•</text>
            </view>
          </block>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨å®‰å…¨åŒº -->
    <view class="safe-bottom"></view>
  </scroll-view>
</view>
