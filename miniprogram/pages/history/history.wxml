<!-- å†å²è®°å½•é¡µé¢ -->
<view class="container">
  <!-- æœªç™»å½•æç¤º -->
  <view class="login-required" wx:if="{{!isLoggedIn}}">
    <image class="login-icon" src="{{images.logo || '/images/logo.png'}}" mode="aspectFit" />
    <text class="login-title">{{i18n.loginRequired || 'è¯·å…ˆç™»å½•'}}</text>
    <text class="login-desc">{{i18n.loginRequiredHistoryDesc || 'ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„ç…§ç‰‡ç”Ÿæˆè®°å½•'}}</text>
    <button class="login-btn" bindtap="goToLogin">{{i18n.goLogin || 'å»ç™»å½•'}}</button>
  </view>

  <!-- å·²ç™»å½•å†…å®¹ -->
  <view wx:else>
    <!-- AIç”Ÿæˆå…è´£å£°æ˜ -->
    <view class="ai-disclaimer" wx:if="{{statusCounts.all > 0}}">
      <text class="disclaimer-text">{{i18n.hist_aiDisclaimer}}</text>
    </view>

  <!-- ç­›é€‰åŒºåŸŸ -->
  <view class="filter-area" wx:if="{{statusCounts.all > 0}}">
    <!-- ç¬¬ä¸€è¡Œï¼šçŠ¶æ€ç­›é€‰ -->
    <view class="filter-row">
      <view class="filter-label">{{i18n.hist_filterStatus || 'çŠ¶æ€'}}</view>
      <view class="filter-tabs status-tabs">
        <view class="filter-tab {{currentStatus === 'all' ? 'active' : ''}}" bindtap="setStatusFilter" data-status="all">
          <text>{{i18n.hist_statusAll || 'å…¨éƒ¨'}}</text>
          <text class="filter-count" wx:if="{{statusCounts.all > 0}}">{{statusCounts.all}}</text>
        </view>
        <view class="filter-tab {{currentStatus === 'pending' ? 'active' : ''}}" bindtap="setStatusFilter" data-status="pending" wx:if="{{statusCounts.pending > 0}}">
          <text>{{i18n.hist_statusPending || 'è¿›è¡Œä¸­'}}</text>
          <text class="filter-count pending-count">{{statusCounts.pending}}</text>
        </view>
        <view class="filter-tab {{currentStatus === 'done' ? 'active' : ''}}" bindtap="setStatusFilter" data-status="done" wx:if="{{statusCounts.done > 0 || statusCounts.remake > 0}}">
          <text>{{i18n.hist_statusDone || 'å·²å®Œæˆ'}}</text>
          <text class="filter-count" wx:if="{{statusCounts.done + statusCounts.remake > 0}}">{{statusCounts.done + statusCounts.remake}}</text>
        </view>
        <view class="filter-tab {{currentStatus === 'failed' ? 'active' : ''}}" bindtap="setStatusFilter" data-status="failed" wx:if="{{statusCounts.failed > 0}}">
          <text>{{i18n.hist_statusFailed || 'å¤±è´¥'}}</text>
          <text class="filter-count failed-count">{{statusCounts.failed}}</text>
        </view>
      </view>
    </view>

    <!-- ç¬¬äºŒè¡Œï¼šæ¥æºç­›é€‰ï¼ˆåœ¨å…¨éƒ¨æˆ–å·²å®ŒæˆçŠ¶æ€ä¸‹æ˜¾ç¤ºï¼Œä¸”æœ‰é‡åˆ¶ç…§ç‰‡æ—¶ï¼‰ -->
    <view class="filter-row" wx:if="{{(currentStatus === 'all' || currentStatus === 'done') && statusCounts.remake > 0}}">
      <view class="filter-label">{{i18n.hist_filterSource || 'æ¥æº'}}</view>
      <view class="filter-tabs source-tabs">
        <view class="filter-tab {{currentSource === 'all' ? 'active' : ''}}" bindtap="setSourceFilter" data-source="all">
          <text>{{i18n.hist_sourceAll || 'å…¨éƒ¨'}}</text>
        </view>
        <view class="filter-tab {{currentSource === 'original' ? 'active' : ''}}" bindtap="setSourceFilter" data-source="original">
          <text>{{i18n.hist_sourceOriginal || 'åŸåˆ›'}}</text>
          <text class="filter-count">{{statusCounts.done}}</text>
        </view>
        <view class="filter-tab {{currentSource === 'remake' ? 'active' : ''}}" bindtap="setSourceFilter" data-source="remake">
          <text>{{i18n.hist_sourceRemake || 'é‡åˆ¶'}}</text>
          <text class="filter-count">{{statusCounts.remake}}</text>
        </view>
      </view>
    </view>

    <!-- ç¬¬ä¸‰è¡Œï¼šåœºæ™¯ç±»å‹ç­›é€‰ï¼ˆåœ¨å…¨éƒ¨æˆ–å·²å®ŒæˆçŠ¶æ€ä¸‹æ˜¾ç¤ºï¼Œä¸”æœ‰å¤šç§ç±»å‹æ—¶ï¼‰ -->
    <view class="filter-row" wx:if="{{(currentStatus === 'all' || currentStatus === 'done') && typeFilters.length > 1}}">
      <view class="filter-label">{{i18n.hist_filterType || 'ç±»å‹'}}</view>
      <scroll-view class="filter-scroll" scroll-x enable-flex>
        <view class="filter-tabs type-tabs">
          <view class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}" bindtap="setFilter" data-filter="all">
            <text>{{i18n.hist_filterAll || 'å…¨éƒ¨'}}</text>
          </view>
          <view class="filter-tab {{currentFilter === item.id ? 'active' : ''}}" wx:for="{{typeFilters}}" wx:key="id" bindtap="setFilter" data-filter="{{item.id}}">
            <text>{{item.name}}</text>
            <text class="filter-count">{{item.count}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- å…¨å±€ç©ºçŠ¶æ€ - å®Œå…¨æ²¡æœ‰ä»»ä½•è®°å½• -->
  <view class="section empty-section" wx:if="{{statusCounts.all === 0}}">
    <view class="empty-state">
      <view class="empty-icon-wrap">
        <view class="css-icon history-icon-large"></view>
      </view>
      <text class="empty-text">{{i18n.hist_noRecords}}</text>
      <text class="empty-tip">{{i18n.hist_noRecordsTip}}</text>
      <view class="empty-btn" bindtap="goToHome">{{i18n.hist_createNow}}</view>
    </view>
  </view>

  <!-- å†å²è®°å½•å†…å®¹åŒº -->
  <view class="section" wx:if="{{statusCounts.all > 0}}">
    <!-- æ“ä½œæ  -->
    <view class="section-header" wx:if="{{historyList.length > 0}}">
      <text class="section-count">{{historyList.length}}{{i18n.hist_unit || 'æ¡'}}</text>
      <view class="header-actions">
        <!-- æ¸…é™¤å¤±è´¥æŒ‰é’® -->
        <view class="clear-failed-btn" wx:if="{{currentStatus === 'failed' && statusCounts.failed > 0}}" bindtap="clearFailedTasks">
          {{i18n.hist_clearAll || 'æ¸…é™¤å…¨éƒ¨'}}
        </view>
        <!-- Tabæ»‘å—åˆ‡æ¢ -->
        <view class="view-mode-tabs" wx:if="{{currentStatus !== 'pending' && currentStatus !== 'failed'}}">
          <view class="tab-slider {{viewMode === 'grid' ? 'slide-right' : ''}}"></view>
          <view class="tab-item {{viewMode === 'list' ? 'active' : ''}}" bindtap="setViewMode" data-mode="list">
            <view class="css-icon list-view-icon"></view>
          </view>
          <view class="tab-item {{viewMode === 'grid' ? 'active' : ''}}" bindtap="setViewMode" data-mode="grid">
            <view class="css-icon grid-view-icon"></view>
          </view>
        </view>
        <view class="select-mode-btn" bindtap="toggleSelectMode" wx:if="{{currentStatus !== 'pending' && currentStatus !== 'failed'}}">
          {{selectMode ? i18n.hist_cancel : i18n.hist_select}}
        </view>
      </view>
    </view>

    <!-- å¤šé€‰æ“ä½œæ  -->
    <view class="select-bar" wx:if="{{selectMode}}">
      <view class="select-all" bindtap="toggleSelectAll">
        <view class="checkbox {{isAllSelected ? 'checked' : ''}}"></view>
        <text>{{i18n.selectAll}}</text>
      </view>
      <text class="selected-count">{{i18n.hist_selectedCount}}{{selectedCount}}{{i18n.hist_unit}}</text>
      <view class="batch-actions">
        <view class="batch-btn download {{selectedCount > 0 ? '' : 'disabled'}}" bindtap="batchDownload">
          <image class="batch-icon" src="./icons/download.svg" mode="aspectFit"></image>
          <text class="batch-btn-text">{{i18n.hist_download}}</text>
        </view>
        <view class="batch-btn delete {{selectedCount > 0 ? '' : 'disabled'}}" bindtap="batchDelete">
          <image class="batch-icon" src="./icons/delete.svg" mode="aspectFit"></image>
          <text class="batch-btn-text">{{i18n.hist_delete}}</text>
        </view>
      </view>
    </view>

    <!-- ç­›é€‰ç©ºçŠ¶æ€ - å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰è®°å½• -->
    <view class="filter-empty-state" wx:if="{{historyList.length === 0 && statusCounts.all > 0}}">
      <view class="filter-empty-icon">ğŸ”</view>
      <text class="filter-empty-text">{{i18n.hist_filterNoRecords || 'è¯¥åˆ†ç±»ä¸‹æš‚æ— è®°å½•'}}</text>
      <view class="filter-empty-tip" bindtap="resetFilter">
        <text>{{i18n.hist_viewAll || 'æŸ¥çœ‹å…¨éƒ¨'}}</text>
      </view>
    </view>

    <!-- ç»Ÿä¸€åˆ—è¡¨ - åˆ—è¡¨è§†å›¾ -->
    <view class="history-list" wx:if="{{historyList.length > 0 && viewMode === 'list'}}">
      <block wx:for="{{historyList}}" wx:key="id">
        <!-- è¿›è¡Œä¸­çš„ä»»åŠ¡ -->
        <view class="history-item pending-item" wx:if="{{item.displayStatus === 'pending'}}" data-id="{{item.id}}">
          <view class="history-img-wrap">
            <image class="history-img" src="{{item.originalImage}}" mode="aspectFill"></image>
            <view class="status-overlay pending">
              <view class="loading-spinner small"></view>
            </view>
          </view>
          <view class="history-info">
            <text class="history-spec">{{item.specDisplay}}</text>
            <text class="history-status pending">{{i18n.hist_aiGenerating || 'ç”Ÿæˆä¸­...'}}</text>
            <text class="history-time">{{item.timeStr}}</text>
          </view>
          <view class="item-actions">
            <view class="action-btn cancel" catchtap="cancelPendingTask" data-id="{{item.id}}">
              <view class="cancel-x">âœ•</view>
            </view>
          </view>
        </view>

        <!-- å¤±è´¥çš„ä»»åŠ¡ -->
        <view class="history-item failed-item" wx:elif="{{item.displayStatus === 'failed'}}" data-id="{{item.id}}">
          <view class="history-img-wrap">
            <image class="history-img" src="{{item.originalImage}}" mode="aspectFill"></image>
            <view class="status-overlay failed">
              <text class="failed-x">âœ•</text>
            </view>
          </view>
          <view class="history-info">
            <text class="history-spec">{{item.specDisplay}}</text>
            <view class="failed-info">
              <text class="history-status failed">{{item.failReason || i18n.hist_failedTitle || 'ç”Ÿæˆå¤±è´¥'}}</text>
              <text class="failed-tip" wx:if="{{item.isSystemError}}">{{i18n.hist_systemErrorTip || 'ç³»ç»ŸåŸå› ï¼Œå…è´¹é‡è¯•'}}</text>
            </view>
            <text class="history-time">{{item.timeStr}}</text>
          </view>
          <view class="item-actions">
            <view class="action-btn retry" catchtap="retryFailedTask" data-id="{{item.id}}">
              <text class="retry-text">{{item.isSystemError ? (i18n.hist_freeRetry || 'å…è´¹é‡è¯•') : (i18n.hist_retry || 'é‡è¯•')}}</text>
            </view>
            <view class="action-btn delete" catchtap="deleteFailedTask" data-id="{{item.id}}">
              <image class="action-icon" src="./icons/delete.svg" mode="aspectFit"></image>
            </view>
          </view>
        </view>

        <!-- å·²å®Œæˆçš„ä»»åŠ¡ -->
        <view class="history-item {{item.selected ? 'selected' : ''}}" wx:else bindtap="{{selectMode ? 'toggleSelect' : 'showPhotoDetail'}}" data-index="{{index}}" data-id="{{item.id}}">
          <!-- å¤šé€‰å¤é€‰æ¡† -->
          <view class="item-checkbox" wx:if="{{selectMode}}" catchtap="toggleSelect" data-index="{{index}}">
            <view class="checkbox {{item.selected ? 'checked' : ''}}"></view>
          </view>
          <view class="history-img-wrap">
            <image class="history-img" src="{{item.resultImage}}" mode="aspectFill"></image>
            <!-- é‡åˆ¶æ ‡è®° -->
            <view class="remake-tag" wx:if="{{item.isRemake}}">
              <text class="remake-tag-text">{{i18n.hist_remakeTag || 'é‡åˆ¶'}}</text>
            </view>
          </view>
          <view class="history-info">
            <text class="history-spec">{{item.specDisplay}}</text>
            <text class="history-time">{{item.timeStr}}</text>
          </view>
        </view>
      </block>
    </view>

    <!-- ç»Ÿä¸€åˆ—è¡¨ - ç½‘æ ¼è§†å›¾ -->
    <view class="history-grid" wx:if="{{historyList.length > 0 && viewMode === 'grid'}}">
      <block wx:for="{{historyList}}" wx:key="id">
        <!-- è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼ˆç½‘æ ¼è§†å›¾ï¼‰ -->
        <view class="grid-item pending-grid-item" wx:if="{{item.displayStatus === 'pending'}}" data-id="{{item.id}}">
          <view class="grid-img-wrap">
            <image class="grid-img" src="{{item.originalImage}}" mode="aspectFill"></image>
            <view class="status-overlay pending">
              <view class="loading-spinner small"></view>
            </view>
          </view>
          <view class="grid-info">
            <text class="grid-spec pending">{{i18n.hist_aiGenerating || 'ç”Ÿæˆä¸­...'}}</text>
          </view>
          <view class="grid-cancel-btn" catchtap="cancelPendingTask" data-id="{{item.id}}">
            <text class="cancel-x">âœ•</text>
          </view>
        </view>

        <!-- å¤±è´¥çš„ä»»åŠ¡ï¼ˆç½‘æ ¼è§†å›¾ï¼‰ -->
        <view class="grid-item failed-grid-item" wx:elif="{{item.displayStatus === 'failed'}}" data-id="{{item.id}}">
          <view class="grid-img-wrap">
            <image class="grid-img" src="{{item.originalImage}}" mode="aspectFill"></image>
            <view class="status-overlay failed">
              <text class="failed-x">âœ•</text>
            </view>
          </view>
          <view class="grid-info">
            <text class="grid-spec failed">{{i18n.hist_failedTitle || 'å¤±è´¥'}}</text>
          </view>
          <view class="grid-action-btns">
            <view class="grid-action-btn retry" catchtap="retryFailedTask" data-id="{{item.id}}">
              <image class="action-icon" src="./icons/retry.svg" mode="aspectFit"></image>
            </view>
            <view class="grid-action-btn delete" catchtap="deleteFailedTask" data-id="{{item.id}}">
              <image class="action-icon" src="./icons/delete.svg" mode="aspectFit"></image>
            </view>
          </view>
        </view>

        <!-- å·²å®Œæˆçš„ä»»åŠ¡ï¼ˆç½‘æ ¼è§†å›¾ï¼‰ -->
        <view class="grid-item {{item.selected ? 'selected' : ''}}" wx:else bindtap="{{selectMode ? 'toggleSelect' : 'showPhotoDetail'}}" data-index="{{index}}" data-id="{{item.id}}">
          <!-- å¤šé€‰å¤é€‰æ¡† -->
          <view class="grid-checkbox" wx:if="{{selectMode}}" catchtap="toggleSelect" data-index="{{index}}">
            <view class="checkbox {{item.selected ? 'checked' : ''}}"></view>
          </view>
          <!-- å›¾ç‰‡å®¹å™¨ -->
          <view class="grid-img-wrap">
            <image class="grid-img" src="{{item.resultImage}}" mode="aspectFill"></image>
            <!-- é‡åˆ¶æ ‡è®° -->
            <view class="remake-tag" wx:if="{{item.isRemake}}">
              <text class="remake-tag-text">{{i18n.hist_remakeTag || 'é‡åˆ¶'}}</text>
            </view>
          </view>
          <view class="grid-info">
            <text class="grid-spec">{{item.specDisplay}}</text>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- åº•éƒ¨å ä½ï¼Œé˜²æ­¢è¢«TabBaré®æŒ¡ -->
  <view class="bottom-safe-area"></view>
  </view><!-- å…³é—­ wx:else -->
</view>

<!-- ç…§ç‰‡è¯¦æƒ…å¼¹çª— -->
<view class="modal-mask" wx:if="{{showPhotoDetailModal}}" bindtap="hidePhotoDetail">
  <view class="photo-detail-modal" catchtap="">
    <!-- å…³é—­æŒ‰é’® -->
    <view class="detail-close-btn" bindtap="hidePhotoDetail">
      <text class="close-x">Ã—</text>
    </view>

    <!-- å›¾ç‰‡é¢„è§ˆ -->
    <view class="detail-image-wrap">
      <image class="detail-image" src="{{currentDetailPhoto.resultImage}}" mode="aspectFit" bindtap="previewDetailImage"></image>
    </view>

    <!-- ç…§ç‰‡ä¿¡æ¯ -->
    <view class="detail-info">
      <text class="detail-spec">{{currentDetailPhoto.specDisplay}}</text>
      <text class="detail-time">{{currentDetailPhoto.timeStr}}</text>
    </view>

    <!-- ç”Ÿæˆæ¡ä»¶ -->
    <view class="detail-options" wx:if="{{currentDetailPhoto.configDisplay && currentDetailPhoto.configDisplay.length > 0}}">
      <view class="detail-options-title">{{i18n.detail_conditions || 'ç”Ÿæˆæ¡ä»¶'}}</view>
      <view class="detail-options-list">
        <view class="detail-option-item" wx:for="{{currentDetailPhoto.configDisplay}}" wx:key="key">
          <text class="option-label">{{item.label}}:</text>
          <text class="option-value">{{item.value}}</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="detail-actions">
      <view class="detail-action-btn" bindtap="detailSharePhoto">
        <image class="detail-action-icon" src="./icons/share.svg" mode="aspectFit"></image>
        <text class="detail-action-btn-text">{{i18n.detail_share || 'åˆ†äº«'}}</text>
        <!-- çº¢ç‚¹ä»…åœ¨éé‡åˆ¶ä¸”æœªåˆ†äº«è¿‡æ—¶æ˜¾ç¤º -->
        <view class="share-red-dot" wx:if="{{!currentDetailPhoto.hasShared && !currentDetailPhoto.isRemake}}"></view>
      </view>
      <view class="detail-action-btn" bindtap="detailRegeneratePhoto" wx:if="{{!currentDetailPhoto.isRemake}}">
        <image class="detail-action-icon" src="./icons/retry.svg" mode="aspectFit"></image>
        <text class="detail-action-btn-text">{{i18n.detail_remake || 'é‡åˆ¶'}}</text>
      </view>
      <view class="detail-action-btn" bindtap="detailSaveImage">
        <image class="detail-action-icon" src="./icons/download.svg" mode="aspectFit"></image>
        <text class="detail-action-btn-text">{{i18n.detail_save || 'ä¿å­˜'}}</text>
      </view>
      <view class="detail-action-btn delete" bindtap="detailDeletePhoto">
        <image class="detail-action-icon" src="./icons/delete.svg" mode="aspectFit"></image>
        <text class="detail-action-btn-text">{{i18n.detail_delete || 'åˆ é™¤'}}</text>
      </view>
    </view>
  </view>
</view>

<!-- åˆ†äº«æµ·æŠ¥å¼¹çª— -->
<view class="modal-mask" wx:if="{{showShareModal}}" bindtap="hideShareModal">
  <view class="share-modal-content" catchtap="">
    <!-- å¤´éƒ¨ -->
    <view class="share-modal-header">
      <text class="share-modal-title">{{i18n.hist_sharePoster || 'åˆ†äº«æµ·æŠ¥'}}</text>
      <view class="modal-close-btn" bindtap="hideShareModal">
        <view class="close-line close-line-1"></view>
        <view class="close-line close-line-2"></view>
      </view>
    </view>

    <!-- æµ·æŠ¥é¢„è§ˆåŒº -->
    <view class="share-poster-wrap">
      <canvas type="2d" id="posterCanvas" class="poster-canvas" style="width: 540rpx; height: 660rpx;"></canvas>
      <image wx:if="{{posterImage}}" class="poster-preview" src="{{posterImage}}" mode="aspectFit"></image>
      <view class="poster-loading" wx:if="{{!posterImage}}">
        <view class="poster-spinner"></view>
        <text class="poster-loading-text">{{i18n.loading || 'ç”Ÿæˆä¸­...'}}</text>
      </view>
    </view>

    <!-- é†’å¸å¥–åŠ±æç¤ºï¼šä»…åœ¨éé‡åˆ¶ä¸”æœªåˆ†äº«è¿‡æ—¶æ˜¾ç¤º -->
    <view class="share-coupon-tip" wx:if="{{!shareItem.hasShared && !shareItem.isRemake}}">
      <image class="coupon-tip-icon" src="./icons/gift.svg" mode="aspectFit"></image>
      <text class="coupon-tip-text">{{i18n.hist_sharePointsTip || 'é¦–æ¬¡åˆ†äº«å¯è·å¾—10é†’å¸'}}</text>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="share-actions">
      <button class="share-action-btn wechat" open-type="share" data-share-type="poster" catchtap="">
        <image class="share-btn-icon" src="./icons/wechat.svg" mode="aspectFit"></image>
        <text>{{i18n.hist_shareToFriend || 'åˆ†äº«ç»™å¥½å‹'}}</text>
      </button>
      <view class="share-action-btn save" bindtap="savePoster">
        <image class="share-btn-icon" src="./icons/save.svg" mode="aspectFit"></image>
        <text>{{i18n.hist_savePoster || 'ä¿å­˜æµ·æŠ¥'}}</text>
      </view>
    </view>
  </view>
</view>