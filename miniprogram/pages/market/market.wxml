<!-- 模板市场首页 -->
<wxs src="../../utils/i18n.wxs" module="i18n" />

<view class="page-container">
  <!-- 自定义导航栏 -->
  <view class="custom-nav" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-content">
      <!-- 左侧语言切换 -->
      <view class="lang-switch">
        <view class="lang-option {{currentLang === 'zh-CN' ? 'active' : ''}}" bindtap="switchLanguage" data-lang="zh-CN">
          <text>简</text>
        </view>
        <view class="lang-option {{currentLang === 'en' ? 'active' : ''}}" bindtap="switchLanguage" data-lang="en">
          <text>En</text>
        </view>
      </view>
      <!-- 中间标题图片 -->
      <image class="nav-title-img" src="{{titleImage}}" mode="heightFix"></image>
      <!-- 右侧占位 -->
      <view class="nav-placeholder"></view>
    </view>
  </view>

  <!-- 分类 Tab -->
  <view class="category-tabs" style="top: {{navBarHeight}}px;">
    <scroll-view class="tabs-scroll" scroll-x="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">
      <view class="tabs-container">
        <view
          class="tab-item {{(currentCategory === item.id) || (currentCategory === null && index === 0) ? 'active' : ''}}"
          wx:for="{{categories}}"
          wx:for-index="index"
          wx:key="id"
          bindtap="switchCategory"
          data-id="{{item.id}}"
        >
          <text class="tab-text">{{i18n.getName(item, currentLang)}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 模板瀑布流 -->
  <scroll-view
    class="template-list"
    style="top: {{navBarHeight + 44}}px;"
    scroll-y="{{true}}"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    bindscrolltolower="loadMore"
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onRefresh"
  >
    <!-- 瀑布流容器 -->
    <view class="waterfall-container">
      <!-- 左列 -->
      <view class="waterfall-column left">
        <view
          class="template-card"
          wx:for="{{leftColumn}}"
          wx:key="id"
          bindtap="goToTemplate"
          data-id="{{item.id}}"
        >
          <view class="card-image-wrap">
            <image
              class="card-image"
              src="{{item.cover_image}}"
              mode="widthFix"
              lazy-load="{{true}}"
            ></image>
            <!-- 左下角原图缩略图 -->
            <view class="reference-thumb" wx:if="{{item.reference_image}}">
              <image class="reference-image" src="{{item.reference_image}}" mode="aspectFill" lazy-load="{{true}}"></image>
              <text class="reference-label">{{i18n.text('原图', 'Original', currentLang)}}</text>
            </view>
          </view>
          <view class="card-bottom-new">
            <text class="card-title-new">{{i18n.getName(item, currentLang)}}</text>
            <view class="do-same-btn" catchtap="doSame" data-id="{{item.id}}">
              <image class="spark-icon" src="/images/icon-ai-spark.svg" mode="aspectFit"></image>
              <text class="do-same-text">{{i18n.text('做同款', 'Try it', currentLang)}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 右列 -->
      <view class="waterfall-column right">
        <view
          class="template-card"
          wx:for="{{rightColumn}}"
          wx:key="id"
          bindtap="goToTemplate"
          data-id="{{item.id}}"
        >
          <view class="card-image-wrap">
            <image
              class="card-image"
              src="{{item.cover_image}}"
              mode="widthFix"
              lazy-load="{{true}}"
            ></image>
            <!-- 左下角原图缩略图 -->
            <view class="reference-thumb" wx:if="{{item.reference_image}}">
              <image class="reference-image" src="{{item.reference_image}}" mode="aspectFill" lazy-load="{{true}}"></image>
              <text class="reference-label">{{i18n.text('原图', 'Original', currentLang)}}</text>
            </view>
          </view>
          <view class="card-bottom-new">
            <text class="card-title-new">{{i18n.getName(item, currentLang)}}</text>
            <view class="do-same-btn" catchtap="doSame" data-id="{{item.id}}">
              <image class="spark-icon" src="/images/icon-ai-spark.svg" mode="aspectFit"></image>
              <text class="do-same-text">{{i18n.text('做同款', 'Try it', currentLang)}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 加载状态 -->
    <view class="loading-more" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{i18n.text('加载中...', 'Loading...', currentLang)}}</text>
    </view>

    <!-- 没有更多 -->
    <view class="no-more" wx:if="{{!hasMore && templates.length > 0}}">
      <text class="no-more-text">— {{i18n.text('没有更多了', 'No more', currentLang)}} —</text>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{!loading && templates.length === 0}}">
      <text class="empty-text">{{i18n.text('暂无模板', 'No templates', currentLang)}}</text>
      <text class="empty-hint">{{i18n.text('创作者们正在努力创作中...', 'Creators are working hard...', currentLang)}}</text>
    </view>

    <!-- 底部安全区 -->
    <view class="safe-bottom"></view>
  </scroll-view>
</view>

<!-- 登录弹窗 -->
<login-modal
  show="{{showLoginModal}}"
  bind:close="onLoginModalClose"
  bind:loginsuccess="onLoginSuccess"
/>
