# é†’ç¾é—ªå›¾ - Docker éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Nginx (ç«¯å£ 80/443)                      â”‚
â”‚                      åå‘ä»£ç† + SSL ç»ˆæ­¢                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼           â–¼           â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å°ç¨‹åºAPI  â”‚  â”‚ åå°ç®¡ç†   â”‚  â”‚ AI æœåŠ¡   â”‚  â”‚ æ”¯ä»˜æœåŠ¡   â”‚
â”‚  :3001    â”‚  â”‚  :3000    â”‚  â”‚  :3002    â”‚  â”‚  :3003    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚              â”‚
      â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Docker Volumes (æŒä¹…åŒ–)        â”‚
â”‚  - miniprogram-data (å°ç¨‹åºæ•°æ®åº“)   â”‚
â”‚  - admin-data (åå°æ•°æ®åº“)           â”‚
â”‚  - admin-uploads (ä¸Šä¼ æ–‡ä»¶)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### 1. å‡†å¤‡æœåŠ¡å™¨

**ç³»ç»Ÿè¦æ±‚:**
- Linux æœåŠ¡å™¨ (æ¨è Ubuntu 20.04+/CentOS 8+)
- å†…å­˜: æœ€ä½ 2GBï¼Œæ¨è 4GB+
- ç¡¬ç›˜: æœ€ä½ 20GB
- å·²é…ç½®åŸŸåå¹¶è§£æåˆ°æœåŠ¡å™¨ IP

### 2. ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨

```bash
# æ–¹å¼ä¸€: Git å…‹éš†
git clone your-repo-url /www/wwwroot/flashphoto
cd /www/wwwroot/flashphoto

# æ–¹å¼äºŒ: ç›´æ¥ä¸Šä¼ 
# å°†é¡¹ç›®æ–‡ä»¶ä¸Šä¼ åˆ° /www/wwwroot/flashphoto ç›®å½•
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
cp env.example .env

# ç¼–è¾‘é…ç½®
vim .env
```

**å¿…é¡»é…ç½®çš„å˜é‡:**
```env
# å¾®ä¿¡å°ç¨‹åº
WX_APPID=ä½ çš„å°ç¨‹åºAppID
WX_SECRET=ä½ çš„å°ç¨‹åºSecret

# å¾®ä¿¡æ”¯ä»˜ (å¦‚æœéœ€è¦)
WX_MCH_ID=å•†æˆ·å·
WX_PAY_API_KEY=APIå¯†é’¥

# AI æœåŠ¡
AI_API_KEY=ä½ çš„AIæœåŠ¡å¯†é’¥

# JWT å¯†é’¥ (ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹)
JWT_SECRET=éšæœºç”Ÿæˆçš„å®‰å…¨å¯†é’¥
```

### 4. é…ç½® SSL è¯ä¹¦ (å¯é€‰ä½†æ¨è)

```bash
# å°† SSL è¯ä¹¦æ”¾ç½®åˆ°æŒ‡å®šç›®å½•
mkdir -p docker/nginx/ssl
cp /path/to/fullchain.pem docker/nginx/ssl/
cp /path/to/privkey.pem docker/nginx/ssl/
```

### 5. ä¸€é”®éƒ¨ç½²

```bash
# ç»™éƒ¨ç½²è„šæœ¬æ‰§è¡Œæƒé™
chmod +x docker/deploy.sh

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./docker/deploy.sh start
```

## ğŸ“– å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
./docker/deploy.sh start

# åœæ­¢æœåŠ¡
./docker/deploy.sh stop

# é‡å¯æœåŠ¡
./docker/deploy.sh restart

# æ›´æ–°æœåŠ¡ (æ‹‰å–ä»£ç å¹¶é‡æ–°æ„å»º)
./docker/deploy.sh update

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
./docker/deploy.sh logs

# æŸ¥çœ‹æŒ‡å®šæœåŠ¡æ—¥å¿—
./docker/deploy.sh logs miniprogram-api
./docker/deploy.sh logs admin-api
./docker/deploy.sh logs ai-service
./docker/deploy.sh logs pay-service

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./docker/deploy.sh status

# å¤‡ä»½æ•°æ®
./docker/deploy.sh backup

# æ¢å¤æ•°æ®
./docker/deploy.sh restore /path/to/backup.tar.gz
```

## ğŸ”§ æ‰‹åŠ¨ Docker å‘½ä»¤

```bash
# æ„å»ºå¹¶å¯åŠ¨
docker compose up -d --build

# åœæ­¢
docker compose down

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f

# è¿›å…¥å®¹å™¨
docker exec -it flashphoto-miniprogram-api sh
docker exec -it flashphoto-admin-api sh

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker compose ps

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats
```

## ğŸŒ è®¿é—®åœ°å€

éƒ¨ç½²å®Œæˆåï¼Œå¯é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®:

| æœåŠ¡ | HTTPS åœ°å€ | HTTP æµ‹è¯•åœ°å€ |
|------|-----------|--------------|
| åå°ç®¡ç† | https://pop-pub.com/admin | http://æœåŠ¡å™¨IP:8080/admin |
| å°ç¨‹åº API | https://pop-pub.com/api | http://æœåŠ¡å™¨IP:8080/api |
| å¥åº·æ£€æŸ¥ | https://pop-pub.com/health | http://æœåŠ¡å™¨IP:8080/health |

**é»˜è®¤ç®¡ç†å‘˜è´¦å·:**
- ç”¨æˆ·å: `admin`
- å¯†ç : `admin123` (é¦–æ¬¡ç™»å½•åè¯·ä¿®æ”¹)

## ğŸ“ ç›®å½•ç»“æ„

```
flashphoto/
â”œâ”€â”€ docker-compose.yml      # Docker ç¼–æ’é…ç½®
â”œâ”€â”€ .env                    # ç¯å¢ƒå˜é‡ (éœ€åˆ›å»º)
â”œâ”€â”€ env.example             # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ DOCKER_DEPLOY.md        # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ server/                 # å°ç¨‹åº API æœåŠ¡
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ admin-server/           # åå°ç®¡ç†ç³»ç»Ÿ
â”‚   â””â”€â”€ server/
â”‚       â”œâ”€â”€ Dockerfile
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ services/               # å¾®æœåŠ¡
â”‚   â”œâ”€â”€ ai-service/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ pay-service/
â”‚       â”œâ”€â”€ Dockerfile
â”‚       â””â”€â”€ ...
â”‚
â””â”€â”€ docker/                 # Docker é…ç½®æ–‡ä»¶
    â”œâ”€â”€ deploy.sh           # éƒ¨ç½²è„šæœ¬
    â”œâ”€â”€ certs/              # æ”¯ä»˜è¯ä¹¦
    â””â”€â”€ nginx/
        â”œâ”€â”€ nginx.conf      # Nginx ä¸»é…ç½®
        â”œâ”€â”€ conf.d/         # ç«™ç‚¹é…ç½®
        â”œâ”€â”€ ssl/            # SSL è¯ä¹¦
        â””â”€â”€ logs/           # æ—¥å¿—
```

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–

æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨ Docker å·ä¸­ï¼Œç¡®ä¿å®¹å™¨é‡å¯åæ•°æ®ä¸ä¸¢å¤±:

| å·å | ç”¨é€” | å®¹å™¨å†…è·¯å¾„ |
|-----|------|-----------|
| flashphoto-miniprogram-data | å°ç¨‹åºæ•°æ®åº“ | /app/data |
| flashphoto-admin-data | åå°ç®¡ç†æ•°æ®åº“ | /app/data |
| flashphoto-admin-uploads | ä¸Šä¼ æ–‡ä»¶ | /app/uploads |

**å¤‡ä»½æ•°æ®:**
```bash
./docker/deploy.sh backup
```

**æŸ¥çœ‹å·:**
```bash
docker volume ls | grep flashphoto
```

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **: é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
2. **é…ç½® SSL**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
3. **é˜²ç«å¢™**: åªå¼€æ”¾ 80/443 ç«¯å£
4. **å®šæœŸå¤‡ä»½**: ä½¿ç”¨ `./docker/deploy.sh backup` å®šæœŸå¤‡ä»½
5. **æ›´æ–°é•œåƒ**: å®šæœŸæ›´æ–° Node.js åŸºç¡€é•œåƒ

## â“ å¸¸è§é—®é¢˜

### Q: å®¹å™¨å¯åŠ¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker compose logs -f

# æ£€æŸ¥é…ç½®
docker compose config
```

### Q: å¦‚ä½•æŸ¥çœ‹æ•°æ®åº“å†…å®¹ï¼Ÿ
```bash
# è¿›å…¥å°ç¨‹åºAPIå®¹å™¨
docker exec -it flashphoto-miniprogram-api sh

# æŸ¥çœ‹æ•°æ®åº“
sqlite3 /app/data/flashphoto_prod.db ".tables"
```

### Q: å¦‚ä½•æ›´æ–°å•ä¸ªæœåŠ¡ï¼Ÿ
```bash
# é‡æ–°æ„å»ºå¹¶å¯åŠ¨æŒ‡å®šæœåŠ¡
docker compose up -d --build miniprogram-api
```

### Q: ç«¯å£è¢«å ç”¨æ€ä¹ˆåŠï¼Ÿ
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep 80

# ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„
```

### Q: å¦‚ä½•è¿ç§»åˆ°æ–°æœåŠ¡å™¨ï¼Ÿ
1. åœ¨æ—§æœåŠ¡å™¨æ‰§è¡Œå¤‡ä»½: `./docker/deploy.sh backup`
2. å°†æ•´ä¸ªé¡¹ç›®ç›®å½•å’Œå¤‡ä»½æ–‡ä»¶å¤åˆ¶åˆ°æ–°æœåŠ¡å™¨
3. åœ¨æ–°æœåŠ¡å™¨æ‰§è¡Œ: `./docker/deploy.sh start`
4. æ¢å¤æ•°æ®: `./docker/deploy.sh restore /path/to/backup.tar.gz`

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥:
1. Docker æ˜¯å¦æ­£ç¡®å®‰è£…: `docker --version`
2. ç¯å¢ƒå˜é‡æ˜¯å¦é…ç½®: `cat .env`
3. å®¹å™¨æ—¥å¿—: `docker compose logs`
4. æœåŠ¡å¥åº·çŠ¶æ€: `curl http://localhost:8080/health`
