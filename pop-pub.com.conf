# 微服务架构 Nginx 配置
# 服务端口分配:
#   - 3000: admin-api (管理后台)
#   - 3001: core-api (核心服务: 用户、配置、积分、照片)
#   - 3002: ai-service (AI 图片生成)
#   - 3003: pay-service (支付服务)

# 上游服务定义
upstream admin_api {
    server 127.0.0.1:3000;
    keepalive 32;
}

upstream core_api {
    server 127.0.0.1:3001;
    keepalive 32;
}

upstream ai_service {
    server 127.0.0.1:3002;
    keepalive 16;
}

upstream pay_service {
    server 127.0.0.1:3003;
    keepalive 32;
}

server {
    listen 80;
    server_name pop-pub.com www.pop-pub.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name pop-pub.com www.pop-pub.com;
    
    ssl_certificate /etc/nginx/ssl/pop-pub.com_bundle.crt;
    ssl_certificate_key /etc/nginx/ssl/pop-pub.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    keepalive_timeout 65;
    client_max_body_size 100m;
    
    root /usr/share/nginx/html;
    index index.html index.htm;
    
    access_log /var/log/nginx/pop-pub.com.access.log;
    error_log /var/log/nginx/pop-pub.com.error.log;

    # ==================== 静态资源 ====================
    
    # 管理后台静态文件
    location ^~ /admin/ {
        alias /var/www/flashphoto-api/public/admin/;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    location = /admin {
        return 301 /admin/;
    }

    # CDN 图片目录
    location /flashphoto/ {
        alias /var/www/html/flashphoto/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
    }

    # ==================== AI 服务 (端口 3002) ====================
    # 独立隔离，防止 AI 服务故障影响其他服务
    location ~ ^/api/ai(/|$) {
        proxy_pass http://ai_service;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        # AI 服务需要更长的超时时间
        proxy_connect_timeout 60s;
        proxy_send_timeout 180s;
        proxy_read_timeout 180s;
        # 大请求体支持（图片上传）
        client_max_body_size 50m;
    }

    # ==================== 支付服务 (端口 3003) ====================
    # 独立隔离，确保支付安全和稳定
    location ~ ^/api/(pay|virtual-pay)(/|$) {
        proxy_pass http://pay_service;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ==================== 管理后台 API (端口 3000) ====================
    # 后台管理专用接口
    location ~ ^/api/(stats|auth|orders|coupons|sync|recharge|security|upload|assets|monitor|translate|users|photos)(/|$) {
        proxy_pass http://admin_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # 后台管理 - config/admin 路由
    location ~ ^/api/config/admin {
        proxy_pass http://admin_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后台管理 - feedback/admin 路由
    location ~ ^/api/feedback/admin {
        proxy_pass http://admin_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后台管理 - photos 管理路由
    location ~ ^/api/photos/(batch|export|stats) {
        proxy_pass http://admin_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后台管理 - points 管理路由
    location ~ ^/api/points/(packages/all|rewards/all|stats|adjust)$ {
        proxy_pass http://admin_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后台管理 - points records (不带userId)
    location = /api/points/records {
        proxy_pass http://admin_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    
# 小程序端 - 用户协议签署接口 (转发到 core_api)    location = /api/users/sign-agreement {        proxy_pass http://core_api;        proxy_http_version 1.1;        proxy_set_header Host $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_set_header X-Forwarded-Proto $scheme;    }
    # 后台管理 - admin 路由
    location ~ ^/api/admin(/|$) {
        proxy_pass http://admin_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==================== 核心服务 (端口 3001) ====================
    # 默认 API 路由 - 小程序核心功能
    location /api/ {
        proxy_pass http://core_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ==================== 健康检查端点 ====================
    location /health/ai {
        proxy_pass http://ai_service/health;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    location /health/pay {
        proxy_pass http://pay_service/health;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    location /health/core {
        proxy_pass http://core_api/health;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    location /health/admin {
        proxy_pass http://admin_api/health;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    # ==================== 默认处理 ====================
    location / {
        try_files $uri $uri/ =404;
    }
    
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}